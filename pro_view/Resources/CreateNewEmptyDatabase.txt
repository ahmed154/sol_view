--
-- PostgreSQL database dump
--

-- Dumped from database version 10.4
-- Dumped by pg_dump version 10.5

-- Started on 2019-02-09 00:55:50

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET client_min_messages = warning;
SET row_security = off;

--
-- TOC entry 15 (class 2615 OID 62187)
-- Name: acc; Type: SCHEMA; Schema: -; Owner: postgres
--

CREATE SCHEMA acc;


ALTER SCHEMA acc OWNER TO postgres;

--
-- TOC entry 17 (class 2615 OID 62188)
-- Name: grl; Type: SCHEMA; Schema: -; Owner: postgres
--

CREATE SCHEMA grl;


ALTER SCHEMA grl OWNER TO postgres;

--
-- TOC entry 18 (class 2615 OID 62189)
-- Name: scl; Type: SCHEMA; Schema: -; Owner: postgres
--

CREATE SCHEMA scl;


ALTER SCHEMA scl OWNER TO postgres;

--
-- TOC entry 1 (class 3079 OID 12924)
-- Name: plpgsql; Type: EXTENSION; Schema: -; Owner: 
--

CREATE EXTENSION IF NOT EXISTS plpgsql WITH SCHEMA pg_catalog;


--
-- TOC entry 3515 (class 0 OID 0)
-- Dependencies: 1
-- Name: EXTENSION plpgsql; Type: COMMENT; Schema: -; Owner: 
--

COMMENT ON EXTENSION plpgsql IS 'PL/pgSQL procedural language';


SET default_tablespace = '';

SET default_with_oids = false;

--
-- TOC entry 208 (class 1259 OID 62190)
-- Name: tbl_cc; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_cc (
    id character varying(50) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    cc1 boolean DEFAULT false NOT NULL,
    cc2 boolean DEFAULT false NOT NULL,
    company_id character varying(2) NOT NULL,
    branch_id character varying(3),
    notes text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    level smallint,
    parent boolean DEFAULT false NOT NULL,
    parent_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE acc.tbl_cc OWNER TO postgres;

--
-- TOC entry 333 (class 1255 OID 62201)
-- Name: fnc_cc_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cc_delete(in_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF acc.tbl_cc
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN	
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from acc.tbl_ccedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));		
-------------------------------------------------------------------------INSERT INTO acc.tbl_ccedit & DELETE acc.tbl_cc
INSERT INTO acc.tbl_ccedit(
	id, cc_id, sequ, aname, ename, cc1, cc2, company_id, branch_id, notes, stop, activetime, level, parent, parent_id, 
	creationtime, editingtime, createuser_id, edituser_id, edit, delete)
SELECT on_edit_id, id, sequ, aname, ename, cc1, cc2, company_id, branch_id, notes, stop, activetime, level, parent, parent_id, 
	creationtime, on_servertime, createuser_id, in_user_id, edit, 1
	FROM acc.tbl_cc
	WHERE id = in_id AND company_id = in_company_id;

DELETE FROM acc.tbl_cc
	WHERE id = in_id AND company_id = in_company_id;										
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 26, 8, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.tbl_cc order by acc.tbl_cc.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;

	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_cc where id = '0';
INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 26, in_id);

------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cc_delete(in_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 289 (class 1255 OID 62202)
-- Name: fnc_cc_insert(character varying, text, text, boolean, boolean, character varying, character varying, text, boolean, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cc_insert(in_id character varying, in_aname text, in_ename text, in_cc1 boolean, in_cc2 boolean, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) RETURNS SETOF acc.tbl_cc
    LANGUAGE plpgsql
    AS $$

declare 
	on_sequ int;
	on_xseq text;
	on_lvl smallint;
	on_lvlnu smallint;
	on_servertime timestamp; 
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_cc where id = '0';
	
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_lvl = (select acc.sysfnc_cclevel(in_parent_id, in_company_id));
	on_sequ = (select acc.sysfnc_ccsequ(on_lvl, in_parent_id, in_company_id));	
	on_lvlnu = (select nu from grl.tbl_lvlnuset where doctypeid = 2 and lvlnu = on_lvl);

	IF (length(on_sequ::text) > on_lvlnu)  
	THEN INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','||'1' ||','|| ex_id ||',' || ex_msgtext || ',' || ex_context); 
	----------------------------------------------------------------------------------------------------------------------------INSERT INTO ex
	INSERT INTO grl.tbl_ex(
		id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
		VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 24, in_id);
	RollBack; 
	return QUERY select * from temp_EX;  
	END IF;
	
	in_id = (select cast(on_sequ as character varying));
	on_lvlnu = (select (on_lvlnu - length(on_sequ::text)));
					
	WHILE (on_lvlnu > 0)
		loop
			in_id = (select concat('0',in_id));
			on_lvlnu = (select (on_lvlnu - 1));
		end loop;	
					
	IF (in_parent_id IS NULL)
		THEN in_id = (select in_id);					
	Else in_id =  (select concat(in_parent_id, in_id));
	END IF;
	
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);				
------------------------------------------------------------------------------------------------------INSERT INTO cc
INSERT INTO acc.tbl_cc(
	id, sequ, aname, ename, cc1, cc2, company_id, branch_id, notes, stop, activetime, level, parent_id, 
	creationtime, createuser_id)
	VALUES (in_id, on_sequ, in_aname, in_ename, in_cc1, in_cc2, in_company_id, in_branch_id, in_notes, in_stop, in_activetime, 
			on_lvl, in_parent_id, on_servertime, in_user_id);

Update acc.tbl_cc SET parent = 'true' WHERE acc.tbl_cc.id = in_parent_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 24, 8, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.tbl_cc order by acc.tbl_cc.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;

	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_cc where id = '0';
INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 24, in_id);

------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cc_insert(in_id character varying, in_aname text, in_ename text, in_cc1 boolean, in_cc2 boolean, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 309 (class 1255 OID 62203)
-- Name: fnc_cc_update(character varying, text, text, boolean, boolean, character varying, character varying, text, boolean, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cc_update(in_id character varying, in_aname text, in_ename text, in_cc1 boolean, in_cc2 boolean, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) RETURNS SETOF acc.tbl_cc
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN	
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from acc.tbl_ccedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from acc.tbl_cc WHERE id = in_id AND company_id = in_company_id) + 1);	
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);	
-------------------------------------------------------------------------INSERT INTO acc.tbl_ccedit & UPDATE acc.tbl_cc
INSERT INTO acc.tbl_ccedit(
	id, cc_id, sequ, aname, ename, cc1, cc2, company_id, branch_id, notes, stop, activetime, level, parent, parent_id, 
	creationtime, editingtime, createuser_id, edituser_id, edit)
SELECT on_edit_id, id, sequ, aname, ename, cc1, cc2, company_id, branch_id, notes, stop, activetime, level, parent, parent_id, 
	creationtime, on_servertime, createuser_id, in_user_id, on_edit_id
	FROM acc.tbl_cc
	WHERE id = in_id AND company_id = in_company_id;

UPDATE acc.tbl_cc
	SET aname=in_aname, ename=in_ename, cc1=in_cc1, cc2=in_cc2, company_id=in_company_id, branch_id=in_branch_id, 
	notes=in_notes, stop=in_stop, activetime=in_activetime, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE id = in_id AND company_id = in_company_id;							
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 25, 8, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.tbl_cc order by acc.tbl_cc.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;

	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_cc where id = '0';
INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 25, in_id);

------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cc_update(in_id character varying, in_aname text, in_ename text, in_cc1 boolean, in_cc2 boolean, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 209 (class 1259 OID 62204)
-- Name: tbl_chart; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_chart (
    id character varying(50) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    menue_id character varying(1) NOT NULL,
    side_id character varying(1) NOT NULL,
    ccrelation_id character varying(1) NOT NULL,
    cc1_id character varying(50),
    cc2_id character varying(50),
    property_id character varying(1),
    company_id character varying(2) NOT NULL,
    branch_id character varying(3) NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    level smallint NOT NULL,
    parent boolean DEFAULT false NOT NULL,
    parent_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE acc.tbl_chart OWNER TO postgres;

--
-- TOC entry 353 (class 1255 OID 62213)
-- Name: fnc_chart_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_chart_delete(in_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF acc.tbl_chart
    LANGUAGE plpgsql
    AS $$

declare 
	on_parent_id text;
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN	
	on_parent_id = (select parent_id from acc.tbl_chart WHERE id = in_id AND company_id = in_company_id);
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from acc.tbl_chartedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from acc.tbl_chart  WHERE id = in_id AND company_id = in_company_id));		
-------------------------------------------------------------------------UPDATE acc.tbl_chartedit & UPDATE acc.tbl_chart
INSERT INTO acc.tbl_chartedit(
	id, chart_id, sequ, aname, ename, menue_id, side_id, ccrelation_id, cc1_id, cc2_id, property_id, company_id, branch_id, 
	notes, stop, activetime, level, parent, parent_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id, id, sequ, aname, ename, menue_id, side_id, ccrelation_id, cc1_id, cc2_id, property_id, company_id, branch_id, 
	notes, stop, activetime, level, parent, parent_id, creationtime, on_servertime, createuser_id, in_user_id, on_current_edit, 1
	FROM acc.tbl_chart
	WHERE id = in_id AND company_id = in_company_id;

DELETE FROM acc.tbl_chart
	WHERE id = in_id AND company_id = in_company_id;
	
IF NOT EXISTS(SELECT id FROM acc.tbl_chart WHERE parent_id = on_parent_id AND company_id = in_company_id)
	THEN
		UPDATE acc.tbl_chart SET parent = 'false' WHERE id = on_parent_id AND company_id = in_company_id;
	END IF;

IF (select property_id from acc.tbl_chart where acc.tbl_chart.id = in_id) = '1' --if customer
THEN

DELETE FROM  acc.tbl_cust WHERE id = in_id AND company_id = in_company_id;

End IF;

IF (select property_id from acc.tbl_chart where acc.tbl_chart.id = in_id) = '2' -- if vendor
THEN

DELETE FROM  acc.tbl_ven WHERE id = in_id AND company_id = in_company_id;

End IF;												
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 23, 7, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.tbl_chart order by acc.tbl_chart.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;

	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_chart where id = '0';
INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 23, in_id);

------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_chart_delete(in_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 284 (class 1255 OID 62214)
-- Name: fnc_chart_insert(character varying, text, text, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, text, boolean, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_chart_insert(in_id character varying, in_aname text, in_ename text, in_menue_id character varying, in_side_id character varying, in_ccrelation_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_property_id character varying, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) RETURNS SETOF acc.tbl_chart
    LANGUAGE plpgsql
    AS $$

declare 
	on_sequ int;
	on_xseq text;
	on_lvl smallint;
	on_lvlnu smallint;
	on_servertime timestamp; 
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_chart where id = '0';
	
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_lvl = (select acc.sysfnc_chartlevel(in_parent_id, in_company_id));
	on_sequ = (select acc.sysfnc_chartsequ(on_lvl, in_parent_id, in_company_id));	
	on_lvlnu = (select nu from grl.tbl_lvlnuset where doctypeid = 1 and lvlnu = on_lvl);
	
	IF (length(on_sequ::text) > on_lvlnu)  
	THEN INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','||'1' ||','|| ex_id ||',' || ex_msgtext || ',' || ex_context); 
	----------------------------------------------------------------------------------------------------------------------------INSERT INTO ex
	INSERT INTO grl.tbl_ex(
		id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
		VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 21, in_id);
	RollBack; 
	return QUERY select * from temp_EX;  
	END IF;
	
	in_id = (select cast(on_sequ as character varying));
	on_lvlnu = (select (on_lvlnu - length(on_sequ::text)));
					
	WHILE (on_lvlnu > 0)
		loop
			in_id = (select concat('0',in_id));
			on_lvlnu = (select (on_lvlnu - 1));
		end loop;	
					
	IF (in_parent_id IS NULL)
		THEN in_id = (select in_id);					
	Else in_id =  (select concat(in_parent_id, in_id));
	END IF;
	
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);

IF (select property_id from acc.tbl_chart where acc.tbl_chart.id = in_parent_id) = '1' --if customer
THEN

INSERT INTO acc.tbl_cust
           (id
           ,aname
		   ,ename
           )
     VALUES
           (chartID
           ,in_aname
		   ,in_ename
           );
End IF;

IF (select property_id from acc.tbl_chart where acc.tbl_chart.id = in_parent_id) = '2' -- if vendor
THEN

INSERT INTO acc.tbl_ven
           (id
           ,aname
		   ,ename
           )
     VALUES
           (chartID
           ,in_aname
		   ,in_ename
           );
End IF;												
------------------------------------------------------------------------------------------------------INSERT INTO chart & Update 
INSERT INTO acc.tbl_chart(
	id, sequ,aname, ename, menue_id, side_id, ccrelation_id, cc1_id, cc2_id, property_id, company_id, branch_id, notes, stop, level, parent_id, creationtime, createuser_id)
	VALUES (in_id, on_sequ, in_aname, in_ename, in_menue_id, in_side_id, in_ccrelation_id, in_cc1_id, in_cc2_id, in_property_id, in_company_id, in_branch_id, in_notes, in_stop, on_lvl, in_parent_id, on_servertime, in_user_id);
Update acc.tbl_chart SET parent = 'true' WHERE tbl_chart.id = in_parent_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 21, 7, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.tbl_chart order by acc.tbl_chart.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;

	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_chart where id = '0';
INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 21, in_id);

------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_chart_insert(in_id character varying, in_aname text, in_ename text, in_menue_id character varying, in_side_id character varying, in_ccrelation_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_property_id character varying, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 324 (class 1255 OID 62216)
-- Name: fnc_chart_update(character varying, text, text, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, text, boolean, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_chart_update(in_id character varying, in_aname text, in_ename text, in_menue_id character varying, in_side_id character varying, in_ccrelation_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_property_id character varying, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) RETURNS SETOF acc.tbl_chart
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN	
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from acc.tbl_chartedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from acc.tbl_chart  WHERE id = in_id AND company_id = in_company_id) + 1);	
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	
-------------------------------------------------------------------------UPDATE acc.tbl_chartedit & UPDATE acc.tbl_chart
INSERT INTO acc.tbl_chartedit(
	id, chart_id, sequ, aname, ename, menue_id, side_id, ccrelation_id, cc1_id, cc2_id, property_id, company_id, branch_id, 
	notes, stop, activetime, level, parent, parent_id, creationtime, editingtime, createuser_id, edituser_id, edit)
	SELECT on_edit_id, id, sequ, aname, ename, menue_id, side_id, ccrelation_id, cc1_id, cc2_id, property_id, company_id, branch_id, 
	notes, stop, activetime, level, parent, parent_id, creationtime, on_servertime, createuser_id, in_user_id, on_current_edit
	FROM acc.tbl_chart
	WHERE id = in_id AND company_id = in_company_id;

UPDATE acc.tbl_chart
	SET aname=in_aname, ename=in_ename, menue_id=in_menue_id, side_id=in_side_id, ccrelation_id=in_ccrelation_id, 
	cc1_id=in_cc1_id, cc2_id=in_cc2_id, property_id=in_property_id, company_id=in_company_id, branch_id=in_branch_id, 
	notes=in_notes, stop=in_stop, activetime=in_activetime, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE id = in_id AND company_id = in_company_id;

IF (select property_id from acc.tbl_chart where acc.tbl_chart.id = in_id) = '1' --if customer
THEN

INSERT INTO acc.tbl_cust
           (id
           ,aname
		   ,ename
           )
     VALUES
           (in_id
           ,in_aname
		   ,in_ename
           )
ON CONFLICT (id) DO UPDATE 
	SET aname=in_aname, ename=in_ename;

End IF;

IF (select property_id from acc.tbl_chart where acc.tbl_chart.id = in_id) = '2' -- if vendor
THEN

INSERT INTO acc.tbl_ven
           (id
           ,aname
		   ,ename
           )
     VALUES
           (in_id
           ,in_aname
		   ,in_ename
           )
ON CONFLICT (id) DO UPDATE 
	SET aname=in_aname, ename=in_ename;
End IF;												
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 22, 7, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.tbl_chart order by acc.tbl_chart.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;

	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.tbl_chart where id = '0';
INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 22, in_id);

------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_chart_update(in_id character varying, in_aname text, in_ename text, in_menue_id character varying, in_side_id character varying, in_ccrelation_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_property_id character varying, in_company_id character varying, in_branch_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_parent_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 210 (class 1259 OID 62218)
-- Name: tbl_cin; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_cin (
    id character varying(10) NOT NULL,
    sequ integer NOT NULL,
    jor_id character varying(15),
    notes text,
    posted boolean DEFAULT false NOT NULL,
    frozen boolean DEFAULT false NOT NULL,
    closed boolean DEFAULT false NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    cc1_id character varying(50),
    cc2_id character varying(50),
    fyear_id character varying(2),
    branch_id character varying(3),
    company_id character varying(2) NOT NULL,
    postedjor_id character varying(15)
);


ALTER TABLE acc.tbl_cin OWNER TO postgres;

--
-- TOC entry 211 (class 1259 OID 62228)
-- Name: tbl_cind; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_cind (
    cin_id character varying(10) NOT NULL,
    jor_id character varying(15),
    amount numeric DEFAULT 0 NOT NULL,
    chart_cin_id text NOT NULL,
    chart_cout_id text NOT NULL,
    notes text,
    paytype_id smallint NOT NULL,
    bank_id smallint NOT NULL,
    checkcardno text,
    checkcarddate date,
    sorno text,
    salno text,
    billdate date,
    manualno text,
    currency_id character varying(2) NOT NULL,
    currencyprice numeric DEFAULT 1 NOT NULL,
    posted boolean DEFAULT false NOT NULL,
    frozen boolean DEFAULT false NOT NULL,
    closed boolean DEFAULT false NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    cc1_id character varying(50),
    cc2_id character varying(50),
    fyear_id character varying(2),
    branch_id character varying(3),
    company_id character varying(2) NOT NULL
);


ALTER TABLE acc.tbl_cind OWNER TO postgres;

--
-- TOC entry 212 (class 1259 OID 62240)
-- Name: tbl_bank; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_bank (
    id smallint NOT NULL,
    aname text,
    ename text,
    notes text
);


ALTER TABLE grl.tbl_bank OWNER TO postgres;

--
-- TOC entry 213 (class 1259 OID 62246)
-- Name: tbl_branches; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_branches (
    id character varying(3) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    mobile1 text,
    mobile2 text,
    phone1 text,
    phone2 text,
    email text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2) NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE grl.tbl_branches OWNER TO postgres;

--
-- TOC entry 214 (class 1259 OID 62254)
-- Name: tbl_currencies; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_currencies (
    id character varying(2) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    asymbol text,
    esymbol text,
    price numeric DEFAULT 1 NOT NULL,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE grl.tbl_currencies OWNER TO postgres;

--
-- TOC entry 215 (class 1259 OID 62263)
-- Name: tbl_paytype; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_paytype (
    id smallint NOT NULL,
    aname text,
    ename text,
    notes text
);


ALTER TABLE grl.tbl_paytype OWNER TO postgres;

--
-- TOC entry 216 (class 1259 OID 62269)
-- Name: viw_cin_select; Type: VIEW; Schema: acc; Owner: postgres
--

CREATE VIEW acc.viw_cin_select AS
 SELECT h.id AS h_id,
    h.sequ AS h_sequ,
    h.notes AS h_notes,
    h.jor_id AS h_jor_id,
    h.posted AS h_posted,
    h.frozen AS h_frozen,
    h.closed AS h_closed,
    h.creationtime AS h_creationtime,
    h.createservertime AS h_createservertime,
    h.createuser_id AS h_createuser_id,
    h.edit AS h_edit,
    h.cc1_id AS h_cc1_id,
    h.cc2_id AS h_cc2_id,
    h.fyear_id AS h_fyear_id,
    h.branch_id AS h_branch_id,
    h.company_id AS h_company_id,
    d.cin_id AS d_cin_id,
    d.jor_id AS d_jor_id,
    d.amount AS d_amount,
    d.chart_cin_id AS d_chart_cin_id,
    chartin.aname AS d_chart_cin_aname,
    chartin.ename AS d_chart_cin_ename,
    d.chart_cout_id AS d_chart_cout_id,
    chartout.aname AS d_chart_cout_aname,
    chartout.ename AS d_chart_cout_ename,
    d.notes AS d_notes,
    d.paytype_id AS d_paytype_id,
    paytype.aname AS d_paytype_aname,
    paytype.ename AS d_paytype_ename,
    d.bank_id AS d_bank_id,
    bank.aname AS d_bank_aname,
    bank.ename AS d_bank_ename,
    d.checkcardno AS d_checkcardno,
    d.checkcarddate AS d_checkcarddate,
    d.sorno AS d_sorno,
    d.salno AS d_salno,
    d.billdate AS d_billdate,
    d.manualno AS d_manualno,
    d.currency_id AS d_currency_id,
    currency.aname AS d_currency_aname,
    currency.ename AS d_currency_ename,
    d.currencyprice AS d_currency_price,
    d.posted AS d_posted,
    d.frozen AS d_frozen,
    d.closed AS d_closed,
    d.creationtime AS d_creationtime,
    d.createservertime AS d_createservertime,
    d.createuser_id AS d_createuser_id,
    d.edit AS d_edit,
    d.cc1_id AS d_cc1_id,
    cc1.aname AS d_cc1_aname,
    cc1.ename AS d_cc1_ename,
    d.cc2_id AS d_cc2_id,
    cc2.aname AS d_cc2_aname,
    cc2.ename AS d_cc2_ename,
    d.fyear_id AS d_fyear_id,
    d.branch_id AS d_branch_id,
    branch.aname AS d_branch_aname,
    branch.ename AS d_branch_ename,
    d.company_id AS d_company_id
   FROM (((((((((acc.tbl_cind d
     LEFT JOIN acc.tbl_cin h ON (((d.cin_id)::text = (h.id)::text)))
     LEFT JOIN acc.tbl_chart chartin ON ((d.chart_cin_id = (chartin.id)::text)))
     LEFT JOIN acc.tbl_chart chartout ON ((d.chart_cout_id = (chartout.id)::text)))
     LEFT JOIN grl.tbl_paytype paytype ON ((d.paytype_id = paytype.id)))
     LEFT JOIN grl.tbl_bank bank ON ((d.bank_id = bank.id)))
     LEFT JOIN grl.tbl_currencies currency ON (((d.currency_id)::text = (currency.id)::text)))
     LEFT JOIN acc.tbl_cc cc1 ON (((d.cc1_id)::text = (cc1.id)::text)))
     LEFT JOIN acc.tbl_cc cc2 ON (((d.cc2_id)::text = (cc2.id)::text)))
     LEFT JOIN grl.tbl_branches branch ON (((d.branch_id)::text = (branch.id)::text)))
  WHERE ((branch.company_id)::text = (d.company_id)::text)
  ORDER BY d.ctid;


ALTER TABLE acc.viw_cin_select OWNER TO postgres;

--
-- TOC entry 341 (class 1255 OID 62274)
-- Name: fnc_cin_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cin_delete(in_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF acc.viw_cin_select
    LANGUAGE plpgsql
    AS $$


declare 
	on_edit_id integer;
	on_jorD_id integer;
	on_servertime timestamp; 
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_jorRefType text;
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));					 					 
------------------------------------------------------------------------------------------------------INSERT INTO joredit	
DELETE FROM acc.tbl_cind WHERE cin_id = in_id AND company_id = in_company_id;
DELETE FROM acc.tbl_cin j WHERE id = in_id AND company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 62, 10, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cin_Select where h_id = in_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_jor_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id,62, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End


$$;


ALTER FUNCTION acc.fnc_cin_delete(in_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 355 (class 1255 OID 62275)
-- Name: fnc_cin_insert(character varying, text, character varying, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, json); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cin_insert(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_cind json) RETURNS SETOF acc.viw_cin_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp; 
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
-------------------------------------------
	i jsonb;
	on_cinD_amount numeric;
	on_cinD_chart_cin_id text;
	on_cinD_chart_cout_id text;
	on_cinD_notes text;
	on_cinD_paytype_id smallint;
	on_cinD_bank_id smallint;
	
	on_cinD_checkcardno text; 
	on_cinD_checkcarddate timestamp;
	on_cinD_sorno text; 
	on_cinD_salno text; 
	on_cinD_billdate timestamp;
	on_cinD_manualno text; 
	on_cinD_currency_id text;
	on_cinD_currencyprice numeric; 
	
	on_cinD_cc1_id text;
	on_cinD_cc2_id text;
	on_cinD_branch_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
					 
	on_sequ = (select(select max(sequ) from acc.tbl_cin
					  WHERE branch_id = in_branch_id	
					  AND company_id = in_company_id	   
					 ) + 1);
					 					 
	on_sequ = (select case when (on_sequ is NULL) then 1 else on_sequ end);
	on_xsequ = on_sequ::text;
	
	WHILE (length(on_xsequ) < 7)
		loop
			on_xsequ = (select concat('0',on_xsequ));
		end loop;
		
	in_id = (in_branch_id || on_xsequ);
------------------------------------------------------------------------------------------------------INSERT INTO cin 
INSERT INTO acc.tbl_cin(
	id, sequ, notes, creationtime, createservertime, createuser_id, cc1_id, cc2_id, fyear_id, branch_id, company_id)
	VALUES (
		in_id, 
		on_sequ, 
		in_notes,		 
		in_creationtime, 
		on_servertime, 
		in_user_id,
		in_cc1_id, 
		in_cc2_id,
		in_fyear_id, 
		in_branch_id, 
		in_company_id);
------------------------------------------------------------------------------------------------------INSERT INTO cinD 
FOR i IN SELECT * FROM json_array_elements(in_cind)
  LOOP

	on_cinD_amount := i->>'amount';
	on_cinD_chart_cin_id := i->>'chart_cin_id';
	on_cinD_chart_cout_id := i->>'chart_cout_id';
    on_cinD_notes := i->>'notes';
	on_cinD_paytype_id := i->>'paytype_id';
	on_cinD_bank_id := i->>'bank_id';
	on_cinD_checkcardno := i->>'checkcardno'; 
	on_cinD_checkcarddate := i->>'checkcarddate';
	on_cinD_sorno := i->>'sorno'; 
	on_cinD_salno := i->>'salno'; 
	on_cinD_billdate := i->>'billdate';
	on_cinD_manualno := i->>'manualno'; 
	on_cinD_currency_id := i->>'currency_id';
	on_cinD_currencyprice := i->>'currency_price';	
    on_cinD_cc1_id := i->>'cc1_id';
    on_cinD_cc2_id := i->>'cc2_id';
    on_cinD_branch_id := i->>'branch_id';
	
	on_cinD_cc1_id = (select case when (on_cinD_cc1_id IS NULL OR on_cinD_cc1_id = '') THEN in_cc1_id else on_cinD_cc1_id end);
	on_cinD_cc2_id = (select case when (on_cinD_cc2_id IS NULL OR on_cinD_cc2_id = '') THEN in_cc2_id else on_cinD_cc2_id end);
	on_cinD_branch_id = (select case when (on_cinD_branch_id IS NULL OR on_cinD_branch_id = '') THEN in_branch_id else on_cinD_branch_id end);
	
	INSERT INTO acc.tbl_cind(
	cin_id, amount, chart_cin_id, chart_cout_id, notes, paytype_id, bank_id, checkcardno, checkcarddate, sorno, salno, billdate, 
		manualno, currency_id, currencyprice, creationtime, createservertime, createuser_id, 
		cc1_id, cc2_id, fyear_id, branch_id, company_id)	
	
	VALUES (
	in_id, 		
	on_cinD_amount,
	on_cinD_chart_cin_id,
	on_cinD_chart_cout_id,
    on_cinD_notes,
	on_cinD_paytype_id,
	on_cinD_bank_id,
	on_cinD_checkcardno,
	on_cinD_checkcarddate,
	on_cinD_sorno,
	on_cinD_salno,
	on_cinD_billdate,
	on_cinD_manualno,
	on_cinD_currency_id,
	on_cinD_currencyprice,
	in_creationtime, 
	on_servertime, 
	in_user_id,
	on_cinD_cc1_id, 
	on_cinD_cc2_id, 
	in_fyear_id,
	on_cinD_branch_id,
	in_company_id
	);
		
 END LOOP;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 60, 19, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cin_Select where h_id = in_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_cin_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id,60, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cin_insert(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_cind json) OWNER TO postgres;

--
-- TOC entry 364 (class 1255 OID 75689)
-- Name: fnc_cin_post(character varying, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cin_post(in_cin_id character varying, in_posttime timestamp without time zone, in_user_id character varying, in_company_id character varying) RETURNS SETOF acc.viw_cin_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_jor_id character varying;
	on_jorD_id integer;
	
	on_doctype_id smallint;
	on_currency_id smallint;
	on_currencyprice numeric; 
	on_jortype_id smallint;
	
	on_notes text; 
	on_fyear_id text; 
	on_branch_id text; 
	on_cc1_id text;  
	on_cc2_id text;  
	on_creationtime timestamp;  
-------------------------------------------------------------
rec   record;
-------------------------------------------------------------
	on_servertime timestamp; 
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_jorRefType text;
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
-------------------------------------------
	i jsonb;
	on_jorD_debit numeric;
	on_jorD_credit numeric;
	on_jorD_chart_id text;
	on_jorD_notes text;
	on_jorD_cc1_id text;
	on_jorD_cc2_id text;
	on_jorD_branch_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	
	DROP TABLE IF EXISTS temp_cin;
	CREATE TEMP TABLE temp_cin AS SELECT * FROM acc.viw_cin_select WHERE h_id = in_cin_id AND h_company_id = in_company_id;
	
	on_doctype_id = 19;
	on_creationtime = (select h_creationtime from temp_cin limit 1);
	on_branch_id = (select h_branch_id from temp_cin limit 1);
	on_currency_id = (select id from grl.tbl_currencies order by sequ asc limit 1);
	on_currencyprice = (select price from grl.tbl_currencies order by sequ asc limit 1); 
	on_jortype_id = 9;
	on_notes = (select h_notes from temp_cin limit 1); 
	on_fyear_id = (select h_fyear_id from temp_cin limit 1); 
	on_cc1_id = (select h_cc1_id from temp_cin limit 1);  
	on_cc2_id = (select h_cc2_id from temp_cin limit 1);  

	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_jorD_id = (select(select max(id) from acc.tbl_jorD WHERE company_id = in_company_id) + 1); if on_jorD_id is null then on_jorD_id = 1; end if;
	on_servertime = (select(current_timestamp));
	
	on_yyyy = (select extract(year from   on_creationtime));
	on_MM = (select extract(month from   on_creationtime));
	on_MM = (select case when (length(on_MM) = 1) then (select concat('0',on_MM)) else on_MM end);
	on_ref = 'pin';
					 
	on_sequ = (select(select max(sequ) from acc.tbl_jor
					  WHERE company_id = in_company_id	
					  AND branch_id = on_branch_id
					  AND fyear_id = on_fyear_id
					 ) + 1);
					 					 
	on_sequ = (select case when (on_sequ is NULL) then 1 else on_sequ end);
	on_xsequ = on_sequ::text;
	
	WHILE (length(on_xsequ) < 5)
		loop
			on_xsequ = (select concat('0',on_xsequ));
		end loop;
		
	--on_yy = (select substring(on_yyyy from 3 for 2));
	on_yy = (select substring((select extract(year from (select beigndate from grl.tbl_fyears where id = on_fyear_id))::text) from 3 for 2));	
								  
	--in_id = (on_branch_id || on_yy || on_MM || on_ref || on_xsequ);
	
	on_jor_id = (select postedjor_id from acc.tbl_cin where id = in_cin_id);

	if(on_jor_id is not null)
	THEN
		on_sequ = CAST (substr(on_jor_id, 6) AS int);
	ELSE
			on_jor_id = (on_branch_id || on_yy || on_xsequ);
			
			WHILE exists(select 1 from acc.tbl_cin cin, acc.tbl_cout cout where cin.postedjor_id = on_jor_id OR cout.postedjor_id = on_jor_id)
			loop
				on_sequ = on_sequ + 1;
				on_xsequ = on_sequ::text;
				on_xsequ = repeat('0', 5 - length(on_xsequ)) || on_xsequ;
				on_jor_id = (on_branch_id || on_yy || on_xsequ);
			end loop;								  
	END IF;
------------------------------------------------------------------------------------------------------INSERT INTO jor 
INSERT INTO acc.tbl_jor(
	id, 
	sequ,
	doctype_id,
	doc_id,
	currency_id, 
	currencyprice, 
	jortype_id, 
	yyyy,
	MM,
	ref,
	notes, 
	company_id, 
	fyear_id, 
	branch_id, 
	cc1_id, 
	cc2_id, 
	creationtime, 
	createservertime, 
	createuser_id)
	VALUES (
		on_jor_id, 
		on_sequ, 
		on_doctype_id,
		in_cin_id,
		on_currency_id, 
		on_currencyprice, 
		on_jortype_id,
		on_yyyy,
		on_MM,
		on_ref,
		on_notes,
		in_company_id, 
		on_fyear_id, 
		on_branch_id, 
		on_cc1_id, 
		on_cc2_id, 
		on_creationtime, 
		on_servertime, 
		in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO jorD 		
FOR rec IN SELECT * FROM acc.viw_cin_select WHERE h_id = in_cin_id AND h_company_id = in_company_id
    LOOP
        INSERT INTO acc.tbl_jord(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, MM, ref, notes, 
								 company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, createuser_id )
		VALUES (
			on_jorD_id, on_jor_id, rec.d_amount, 0, rec.d_chart_cin_id, on_doctype_id, in_cin_id, rec.d_currency_id, rec.d_currency_price, on_jortype_id, on_yyyy, on_MM, on_ref,
			rec.d_notes, in_company_id, on_fyear_id, on_branch_id, on_cc1_id, on_cc2_id, on_creationtime, on_servertime, in_user_id);		
			on_jorD_id = on_jorD_id + 1;
							  
		INSERT INTO acc.tbl_jord(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, MM, ref, notes, 
								 company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, createuser_id )
		VALUES (
			on_jorD_id, on_jor_id, 0, rec.d_amount, rec.d_chart_cout_id, on_doctype_id, in_cin_id, rec.d_currency_id, rec.d_currency_price, on_jortype_id, on_yyyy, on_MM, on_ref,
			rec.d_notes, in_company_id, on_fyear_id, on_branch_id, on_cc1_id, on_cc2_id, on_creationtime, on_servertime, in_user_id);		
			on_jorD_id = on_jorD_id + 1;
    END LOOP;	 
------------------------------------------------------------------------------------------------------UPDATE acc.tbl_cin & cind
	UPDATE acc.tbl_cin SET posted = '1', jor_id = on_jor_id, postedjor_id = on_jor_id  WHERE id = in_cin_id AND company_id = in_company_id;
	UPDATE acc.tbl_cind SET posted = '1', jor_id = on_jor_id WHERE cin_id = in_cin_id AND company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 63, on_doctype_id, in_cin_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cin_Select where h_id = in_cin_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_cin_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doctype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, on_branch_id, null, in_user_id,63, on_doctype_id, in_cin_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cin_post(in_cin_id character varying, in_posttime timestamp without time zone, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 349 (class 1255 OID 62279)
-- Name: fnc_cin_postcancel(character varying, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cin_postcancel(in_cin_id character varying, in_time timestamp without time zone, in_user_id character varying, in_company_id character varying) RETURNS SETOF acc.viw_cin_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_doctype_id smallint;
	on_branch_id text; 
	on_audit_id bigint;
    on_servertime timestamp;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;	
	on_doctype_id = '19';
	on_branch_id = (select h_branch_id FROM acc.viw_cin_select WHERE h_id = in_cin_id AND h_company_id = in_company_id limit 1);
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
------------------------------------------------------------------------------------------------------UPDATE acc.tbl_cin & cind
	UPDATE acc.tbl_cind SET posted = 'false', jor_id = null WHERE cin_id = in_cin_id AND company_id = in_company_id;					
	UPDATE acc.tbl_cin SET posted = 'false', jor_id = null WHERE id = in_cin_id AND company_id = in_company_id;	
------------------------------------------------------------------------------------------------------INSERT INTO jorD 		
 	DELETE FROM acc.tbl_jord WHERE doc_id = in_cin_id AND doctype_id = on_doctype_id AND company_id = in_company_id;
------------------------------------------------------------------------------------------------------DELETE FROM jor 
	DELETE FROM acc.tbl_jor WHERE doc_id = in_cin_id AND doctype_id = on_doctype_id AND company_id = in_company_id;	
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 64, on_doctype_id, in_cin_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cin_Select where h_id = in_cin_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_cin_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doctype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, on_branch_id, null, in_user_id,64, on_doctype_id, in_cin_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cin_postcancel(in_cin_id character varying, in_time timestamp without time zone, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 357 (class 1255 OID 62280)
-- Name: fnc_cin_update(character varying, text, character varying, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, json); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cin_update(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_cind json) RETURNS SETOF acc.viw_cin_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp; 
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
-------------------------------------------
	i jsonb;
	on_cinD_amount numeric;
	on_cinD_chart_cin_id text;
	on_cinD_chart_cout_id text;
	on_cinD_notes text;
	on_cinD_paytype_id smallint;
	on_cinD_bank_id smallint;
	
	on_cinD_checkcardno text; 
	on_cinD_checkcarddate timestamp;
	on_cinD_sorno text; 
	on_cinD_salno text; 
	on_cinD_billdate timestamp;
	on_cinD_manualno text; 
	on_cinD_currency_id text;
	on_cinD_currencyprice numeric; 
	
	on_cinD_cc1_id text;
	on_cinD_cc2_id text;
	on_cinD_branch_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	
	on_sequ = (select(select max(sequ) from acc.tbl_cin
					  WHERE branch_id = in_branch_id	
					  AND company_id = in_company_id	   
					 ) + 1);
					 					 
	on_sequ = (select case when (on_sequ is NULL) then 1 else on_sequ end);
	on_xsequ = on_sequ::text;

------------------------------------------------------------------------------------------------------DELETE FROM acc.tbl_cind & cin
DELETE FROM acc.tbl_cind WHERE cin_id = in_id AND company_id = in_company_id;
DELETE FROM acc.tbl_cin WHERE id = in_id AND company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO cin 
INSERT INTO acc.tbl_cin(
	id, sequ, notes, creationtime, createservertime, createuser_id, cc1_id, cc2_id, fyear_id, branch_id, company_id)
	VALUES (
		in_id, 
		on_sequ, 
		in_notes,		 
		in_creationtime, 
		on_servertime, 
		in_user_id,
		in_cc1_id, 
		in_cc2_id,
		in_fyear_id, 
		in_branch_id, 
		in_company_id);
------------------------------------------------------------------------------------------------------INSERT INTO cinD 
FOR i IN SELECT * FROM json_array_elements(in_cind)
  LOOP

	on_cinD_amount := i->>'amount';
	on_cinD_chart_cin_id := i->>'chart_cin_id';
	on_cinD_chart_cout_id := i->>'chart_cout_id';
    on_cinD_notes := i->>'notes';
	on_cinD_paytype_id := i->>'paytype_id';
	on_cinD_bank_id := i->>'bank_id';
	on_cinD_checkcardno := i->>'checkcardno'; 
	on_cinD_checkcarddate := i->>'checkcarddate';
	on_cinD_sorno := i->>'sorno'; 
	on_cinD_salno := i->>'salno'; 
	on_cinD_billdate := i->>'billdate';
	on_cinD_manualno := i->>'manualno'; 
	on_cinD_currency_id := i->>'currency_id';
	on_cinD_currencyprice := i->>'currency_price';	
    on_cinD_cc1_id := i->>'cc1_id';
    on_cinD_cc2_id := i->>'cc2_id';
    on_cinD_branch_id := i->>'branch_id';
	
	on_cinD_cc1_id = (select case when (on_cinD_cc1_id IS NULL OR on_cinD_cc1_id = '') THEN in_cc1_id else on_cinD_cc1_id end);
	on_cinD_cc2_id = (select case when (on_cinD_cc2_id IS NULL OR on_cinD_cc2_id = '') THEN in_cc2_id else on_cinD_cc2_id end);
	on_cinD_branch_id = (select case when (on_cinD_branch_id IS NULL OR on_cinD_branch_id = '') THEN in_branch_id else on_cinD_branch_id end);
	
	INSERT INTO acc.tbl_cind(
	cin_id, amount, chart_cin_id, chart_cout_id, notes, paytype_id, bank_id, checkcardno, checkcarddate, sorno, salno, billdate, 
		manualno, currency_id, currencyprice, creationtime, createservertime, createuser_id, 
		cc1_id, cc2_id, fyear_id, branch_id, company_id)	
	
	VALUES (
	in_id, 		
	on_cinD_amount,
	on_cinD_chart_cin_id,
	on_cinD_chart_cout_id,
    on_cinD_notes,
	on_cinD_paytype_id,
	on_cinD_bank_id,
	on_cinD_checkcardno,
	on_cinD_checkcarddate,
	on_cinD_sorno,
	on_cinD_salno,
	on_cinD_billdate,
	on_cinD_manualno,
	on_cinD_currency_id,
	on_cinD_currencyprice,
	in_creationtime, 
	on_servertime, 
	in_user_id,
	on_cinD_cc1_id, 
	on_cinD_cc2_id, 
	in_fyear_id,
	on_cinD_branch_id,
	in_company_id
	);
		
 END LOOP;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 61, 19, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cin_Select where h_id = in_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_cin_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id,61, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cin_update(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_cind json) OWNER TO postgres;

--
-- TOC entry 217 (class 1259 OID 62282)
-- Name: tbl_cout; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_cout (
    id character varying(10) NOT NULL,
    sequ integer NOT NULL,
    jor_id character varying(15),
    notes text,
    posted boolean DEFAULT false NOT NULL,
    frozen boolean DEFAULT false NOT NULL,
    closed boolean DEFAULT false NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    cc1_id character varying(50),
    cc2_id character varying(50),
    fyear_id character varying(2),
    branch_id character varying(3),
    company_id character varying(2) NOT NULL,
    postedjor_id character varying(15)
);


ALTER TABLE acc.tbl_cout OWNER TO postgres;

--
-- TOC entry 218 (class 1259 OID 62292)
-- Name: tbl_coutd; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_coutd (
    cout_id character varying(10) NOT NULL,
    jor_id character varying(15),
    amount numeric DEFAULT 0 NOT NULL,
    chart_cin_id text NOT NULL,
    chart_cout_id text NOT NULL,
    notes text,
    paytype_id smallint NOT NULL,
    bank_id smallint NOT NULL,
    checkcardno text,
    checkcarddate date,
    sorno text,
    salno text,
    billdate date,
    manualno text,
    currency_id character varying(2) NOT NULL,
    currencyprice numeric DEFAULT 1 NOT NULL,
    posted boolean DEFAULT false NOT NULL,
    frozen boolean DEFAULT false NOT NULL,
    closed boolean DEFAULT false NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    cc1_id character varying(50),
    cc2_id character varying(50),
    fyear_id character varying(2),
    branch_id character varying(3),
    company_id character varying(2) NOT NULL
);


ALTER TABLE acc.tbl_coutd OWNER TO postgres;

--
-- TOC entry 219 (class 1259 OID 62304)
-- Name: viw_cout_select; Type: VIEW; Schema: acc; Owner: postgres
--

CREATE VIEW acc.viw_cout_select AS
 SELECT h.id AS h_id,
    h.sequ AS h_sequ,
    h.notes AS h_notes,
    h.jor_id AS h_jor_id,
    h.posted AS h_posted,
    h.frozen AS h_frozen,
    h.closed AS h_closed,
    h.creationtime AS h_creationtime,
    h.createservertime AS h_createservertime,
    h.createuser_id AS h_createuser_id,
    h.edit AS h_edit,
    h.cc1_id AS h_cc1_id,
    h.cc2_id AS h_cc2_id,
    h.fyear_id AS h_fyear_id,
    h.branch_id AS h_branch_id,
    h.company_id AS h_company_id,
    d.cout_id AS d_cout_id,
    d.jor_id AS d_jor_id,
    d.amount AS d_amount,
    d.chart_cin_id AS d_chart_cin_id,
    chartin.aname AS d_chart_cin_aname,
    chartin.ename AS d_chart_cin_ename,
    d.chart_cout_id AS d_chart_cout_id,
    chartout.aname AS d_chart_cout_aname,
    chartout.ename AS d_chart_cout_ename,
    d.notes AS d_notes,
    d.paytype_id AS d_paytype_id,
    paytype.aname AS d_paytype_aname,
    paytype.ename AS d_paytype_ename,
    d.bank_id AS d_bank_id,
    bank.aname AS d_bank_aname,
    bank.ename AS d_bank_ename,
    d.checkcardno AS d_checkcardno,
    d.checkcarddate AS d_checkcarddate,
    d.sorno AS d_sorno,
    d.salno AS d_salno,
    d.billdate AS d_billdate,
    d.manualno AS d_manualno,
    d.currency_id AS d_currency_id,
    currency.aname AS d_currency_aname,
    currency.ename AS d_currency_ename,
    d.currencyprice AS d_currency_price,
    d.posted AS d_posted,
    d.frozen AS d_frozen,
    d.closed AS d_closed,
    d.creationtime AS d_creationtime,
    d.createservertime AS d_createservertime,
    d.createuser_id AS d_createuser_id,
    d.edit AS d_edit,
    d.cc1_id AS d_cc1_id,
    cc1.aname AS d_cc1_aname,
    cc1.ename AS d_cc1_ename,
    d.cc2_id AS d_cc2_id,
    cc2.aname AS d_cc2_aname,
    cc2.ename AS d_cc2_ename,
    d.fyear_id AS d_fyear_id,
    d.branch_id AS d_branch_id,
    branch.aname AS d_branch_aname,
    branch.ename AS d_branch_ename,
    d.company_id AS d_company_id
   FROM (((((((((acc.tbl_coutd d
     LEFT JOIN acc.tbl_cout h ON (((d.cout_id)::text = (h.id)::text)))
     LEFT JOIN acc.tbl_chart chartin ON ((d.chart_cin_id = (chartin.id)::text)))
     LEFT JOIN acc.tbl_chart chartout ON ((d.chart_cout_id = (chartout.id)::text)))
     LEFT JOIN grl.tbl_paytype paytype ON ((d.paytype_id = paytype.id)))
     LEFT JOIN grl.tbl_bank bank ON ((d.bank_id = bank.id)))
     LEFT JOIN grl.tbl_currencies currency ON (((d.currency_id)::text = (currency.id)::text)))
     LEFT JOIN acc.tbl_cc cc1 ON (((d.cc1_id)::text = (cc1.id)::text)))
     LEFT JOIN acc.tbl_cc cc2 ON (((d.cc2_id)::text = (cc2.id)::text)))
     LEFT JOIN grl.tbl_branches branch ON (((d.branch_id)::text = (branch.id)::text)))
  WHERE ((branch.company_id)::text = (d.company_id)::text)
  ORDER BY d.ctid;


ALTER TABLE acc.viw_cout_select OWNER TO postgres;

--
-- TOC entry 343 (class 1255 OID 62309)
-- Name: fnc_cout_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cout_delete(in_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF acc.viw_cout_select
    LANGUAGE plpgsql
    AS $$

declare
    on_edit_id integer;
            on_jorD_id integer;
            on_servertime timestamp;
            on_yyyy text;
            on_yy text;
            on_MM text;
            on_ref text;
            on_jorRefType text;
            on_sequ smallint;
            on_xsequ text;
            on_audit_id bigint;
            --------------------------------------------
                ex_id integer;
            ex_sqlstate text;
            ex_colname text;
            ex_constraintname text;
            ex_datatype text;
            ex_msgtext text;
            ex_tablename text;
            ex_schemaname text;
            ex_details text;
            ex_hint text;
            ex_context text;
            BEGIN
            ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
            on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
            on_servertime = (select(current_timestamp));
            ------------------------------------------------------------------------------------------------------INSERT INTO joredit
DELETE FROM acc.tbl_coutd WHERE cout_id = in_id AND company_id = in_company_id;
            DELETE FROM acc.tbl_cout j WHERE id = in_id AND company_id = in_company_id;
            ------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
    id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)

    VALUES(on_audit_id, on_servertime, 62, 10, in_id, in_user_id, in_company_id);
            ------------------------------------------------------------------------------------------------------Success Return
            RETURN QUERY select *from acc.viw_cout_Select where h_id = in_id;
            ------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN

    GET STACKED DIAGNOSTICS
        ex_sqlstate = RETURNED_SQLSTATE,
        ex_colname = COLUMN_NAME,
        ex_constraintname = CONSTRAINT_NAME,
        ex_datatype = PG_DATATYPE_NAME,
        ex_msgtext = MESSAGE_TEXT,
        ex_tablename = TABLE_NAME,
        ex_schemaname = SCHEMA_NAME,
        ex_details = PG_EXCEPTION_DETAIL,
        ex_hint = PG_EXCEPTION_HINT,
        ex_context = PG_EXCEPTION_CONTEXT;
            DROP TABLE IF EXISTS temp_EX;
            CREATE TEMP TABLE temp_EX as SELECT* from acc.viw_jor_Select where h_id = '0';
            INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL' || ',' || ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
            ------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 62, in_id);
            ------------------------------------------------------------------------------------------------------Faild Return
return QUERY select* from temp_EX;
            End

$$;


ALTER FUNCTION acc.fnc_cout_delete(in_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 286 (class 1255 OID 62310)
-- Name: fnc_cout_insert(character varying, text, character varying, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, json); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cout_insert(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_coutd json) RETURNS SETOF acc.viw_cout_select
    LANGUAGE plpgsql
    AS $$

declare
    on_servertime timestamp;
            on_sequ smallint;
            on_xsequ text;
            on_audit_id bigint;
            -------------------------------------------
                i jsonb;
            on_coutD_amount numeric;
            on_coutD_chart_cin_id text;
            on_coutD_chart_cout_id text;
            on_coutD_notes text;
            on_coutD_paytype_id smallint;
            on_coutD_bank_id smallint;

            on_coutD_checkcardno text;
            on_coutD_checkcarddate timestamp;
            on_coutD_sorno text;
            on_coutD_salno text;
            on_coutD_billdate timestamp;
            on_coutD_manualno text;
            on_coutD_currency_id text;
            on_coutD_currencyprice numeric;

            on_coutD_cc1_id text;
            on_coutD_cc2_id text;
            on_coutD_branch_id text;
            --------------------------------------------
                ex_id integer;
            ex_sqlstate text;
            ex_colname text;
            ex_constraintname text;
            ex_datatype text;
            ex_msgtext text;
            ex_tablename text;
            ex_schemaname text;
            ex_details text;
            ex_hint text;
            ex_context text;
            BEGIN
                ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
            on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
            on_servertime = (select(current_timestamp));

            on_sequ = (select(select max(sequ) from acc.tbl_cout
                              WHERE branch_id = in_branch_id

                              AND company_id = in_company_id
                             ) + 1);

            on_sequ = (select case when(on_sequ is NULL) then 1 else on_sequ end);
            on_xsequ = on_sequ::text;

            WHILE(length(on_xsequ) < 7)

        loop
            on_xsequ = (select concat('0', on_xsequ));
            end loop;

            in_id = (in_branch_id || on_xsequ);
            ------------------------------------------------------------------------------------------------------INSERT INTO cout
INSERT INTO acc.tbl_cout(
    id, sequ, notes, creationtime, createservertime, createuser_id, cc1_id, cc2_id, fyear_id, branch_id, company_id)

    VALUES(
        in_id,
        on_sequ,
        in_notes,
        in_creationtime,
        on_servertime,
        in_user_id,
        in_cc1_id,
        in_cc2_id,
        in_fyear_id,
        in_branch_id,
        in_company_id);
            ------------------------------------------------------------------------------------------------------INSERT INTO coutD
FOR i IN SELECT *FROM json_array_elements(in_coutd)
  LOOP

    on_coutD_amount := i->> 'amount';
            on_coutD_chart_cin_id:= i->> 'chart_cin_id';
            on_coutD_chart_cout_id:= i->> 'chart_cout_id';
            on_coutD_notes:= i->> 'notes';
            on_coutD_paytype_id:= i->> 'paytype_id';
            on_coutD_bank_id:= i->> 'bank_id';
            on_coutD_checkcardno:= i->> 'checkcardno';
            on_coutD_checkcarddate:= i->> 'checkcarddate';
            on_coutD_sorno:= i->> 'sorno';
            on_coutD_salno:= i->> 'salno';
            on_coutD_billdate:= i->> 'billdate';
            on_coutD_manualno:= i->> 'manualno';
            on_coutD_currency_id:= i->> 'currency_id';
            on_coutD_currencyprice:= i->> 'currency_price';
            on_coutD_cc1_id:= i->> 'cc1_id';
            on_coutD_cc2_id:= i->> 'cc2_id';
            on_coutD_branch_id:= i->> 'branch_id';

            on_coutD_cc1_id = (select case when(on_coutD_cc1_id IS NULL OR on_coutD_cc1_id = '') THEN in_cc1_id else on_coutD_cc1_id end);
            on_coutD_cc2_id = (select case when(on_coutD_cc2_id IS NULL OR on_coutD_cc2_id = '') THEN in_cc2_id else on_coutD_cc2_id end);
            on_coutD_branch_id = (select case when(on_coutD_branch_id IS NULL OR on_coutD_branch_id = '') THEN in_branch_id else on_coutD_branch_id end);

            INSERT INTO acc.tbl_coutd(
            cout_id, amount, chart_cin_id, chart_cout_id, notes, paytype_id, bank_id, checkcardno, checkcarddate, sorno, salno, billdate,
                manualno, currency_id, currencyprice, creationtime, createservertime, createuser_id,
                cc1_id, cc2_id, fyear_id, branch_id, company_id)


    VALUES(
    in_id,
    on_coutD_amount,
    on_coutD_chart_cin_id,
    on_coutD_chart_cout_id,
    on_coutD_notes,
    on_coutD_paytype_id,
    on_coutD_bank_id,
    on_coutD_checkcardno,
    on_coutD_checkcarddate,
    on_coutD_sorno,
    on_coutD_salno,
    on_coutD_billdate,
    on_coutD_manualno,
    on_coutD_currency_id,
    on_coutD_currencyprice,
    in_creationtime,
    on_servertime,
    in_user_id,
    on_coutD_cc1_id,
    on_coutD_cc2_id,
    in_fyear_id,
    on_coutD_branch_id,
    in_company_id
    );

            END LOOP;
            ------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
    id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)

    VALUES(on_audit_id, on_servertime, 60, 20, in_id, in_user_id, in_company_id);
            ------------------------------------------------------------------------------------------------------Success Return
            RETURN QUERY select *from acc.viw_cout_Select where h_id = in_id;
            ------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN

    GET STACKED DIAGNOSTICS
        ex_sqlstate = RETURNED_SQLSTATE,
        ex_colname = COLUMN_NAME,
        ex_constraintname = CONSTRAINT_NAME,
        ex_datatype = PG_DATATYPE_NAME,
        ex_msgtext = MESSAGE_TEXT,
        ex_tablename = TABLE_NAME,
        ex_schemaname = SCHEMA_NAME,
        ex_details = PG_EXCEPTION_DETAIL,
        ex_hint = PG_EXCEPTION_HINT,
        ex_context = PG_EXCEPTION_CONTEXT;
            DROP TABLE IF EXISTS temp_EX;
            CREATE TEMP TABLE temp_EX as SELECT* from acc.viw_cout_Select where h_id = '0';
            INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL' || ',' || ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
            ------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 60, in_id);
            ------------------------------------------------------------------------------------------------------Faild Return
return QUERY select* from temp_EX;
            End

$$;


ALTER FUNCTION acc.fnc_cout_insert(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_coutd json) OWNER TO postgres;

--
-- TOC entry 307 (class 1255 OID 75691)
-- Name: fnc_cout_post(character varying, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cout_post(in_cout_id character varying, in_posttime timestamp without time zone, in_user_id character varying, in_company_id character varying) RETURNS SETOF acc.viw_cout_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_jor_id character varying;
	on_jorD_id integer;
	
	on_doctype_id smallint;
	on_currency_id smallint;
	on_currencyprice numeric; 
	on_jortype_id smallint;
	
	on_notes text; 
	on_fyear_id text; 
	on_branch_id text; 
	on_cc1_id text;  
	on_cc2_id text;  
	on_creationtime timestamp;  
-------------------------------------------------------------
rec   record;
-------------------------------------------------------------
	on_servertime timestamp; 
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_jorRefType text;
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
-------------------------------------------
	i jsonb;
	on_jorD_debit numeric;
	on_jorD_credit numeric;
	on_jorD_chart_id text;
	on_jorD_notes text;
	on_jorD_cc1_id text;
	on_jorD_cc2_id text;
	on_jorD_branch_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	
	DROP TABLE IF EXISTS temp_cout;
	CREATE TEMP TABLE temp_cout AS SELECT * FROM acc.viw_cout_select WHERE h_id = in_cout_id AND h_company_id = in_company_id;
	
	on_doctype_id = 20;
	on_creationtime = (select h_creationtime from temp_cout limit 1);
	on_branch_id = (select h_branch_id from temp_cout limit 1);
	on_currency_id = (select id from grl.tbl_currencies order by sequ asc limit 1);
	on_currencyprice = (select price from grl.tbl_currencies order by sequ asc limit 1); 
	on_jortype_id = 10;
	on_notes = (select h_notes from temp_cout limit 1); 
	on_fyear_id = (select h_fyear_id from temp_cout limit 1); 
	on_cc1_id = (select h_cc1_id from temp_cout limit 1);  
	on_cc2_id = (select h_cc2_id from temp_cout limit 1);  

	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_jorD_id = (select(select max(id) from acc.tbl_jorD WHERE company_id = in_company_id) + 1); if on_jorD_id is null then on_jorD_id = 1; end if;
	on_servertime = (select(current_timestamp));
	
	on_yyyy = (select extract(year from   on_creationtime));
	on_MM = (select extract(month from   on_creationtime));
	on_MM = (select case when (length(on_MM) = 1) then (select concat('0',on_MM)) else on_MM end);
	on_ref = 'put';
					 
	on_sequ = (select(select max(sequ) from acc.tbl_jor
					  WHERE company_id = in_company_id	
					  AND branch_id = on_branch_id
					  AND fyear_id = on_fyear_id
					 ) + 1);
					 					 
	on_sequ = (select case when (on_sequ is NULL) then 1 else on_sequ end);
	on_xsequ = on_sequ::text;
	
	WHILE (length(on_xsequ) < 5)
		loop
			on_xsequ = (select concat('0',on_xsequ));
		end loop;
		
	--on_yy = (select substring(on_yyyy from 3 for 2));
	on_yy = (select substring((select extract(year from (select beigndate from grl.tbl_fyears where id = on_fyear_id))::text) from 3 for 2));	

	--in_id = (on_branch_id || on_yy || on_MM || on_ref || on_xsequ);
	
	on_jor_id = (select postedjor_id from acc.tbl_cout where id = in_cout_id);

	if(on_jor_id is not null)
	THEN
		on_sequ = CAST (substr(on_jor_id, 6) AS int);
	ELSE
			on_jor_id = (on_branch_id || on_yy || on_xsequ);
							  
			WHILE exists(select 1 from acc.tbl_cin cin, acc.tbl_cout cout where cin.postedjor_id = on_jor_id OR cout.postedjor_id = on_jor_id)
			loop
				on_sequ = on_sequ + 1;
				on_xsequ = on_sequ::text;
				on_xsequ = repeat('0', 5 - length(on_xsequ)) || on_xsequ;
				on_jor_id = (on_branch_id || on_yy || on_xsequ);
			end loop;	
							  
			--WHILE exists(select * from acc.tbl_cout where postedjor_id = on_jor_id)
			--loop
				--on_sequ = on_sequ + 1;
				--on_xsequ = on_sequ::text;
				--on_xsequ = repeat('0', 5 - length(on_xsequ)) || on_xsequ;								  
				--on_jor_id = (on_branch_id || on_yy || on_xsequ);
			--end loop;	
	END IF;
------------------------------------------------------------------------------------------------------INSERT INTO jor 
INSERT INTO acc.tbl_jor(
	id, 
	sequ,
	doctype_id,
	doc_id,
	currency_id, 
	currencyprice, 
	jortype_id, 
	yyyy,
	MM,
	ref,
	notes, 
	company_id, 
	fyear_id, 
	branch_id, 
	cc1_id, 
	cc2_id, 
	creationtime, 
	createservertime, 
	createuser_id)
	VALUES (
		on_jor_id, 
		on_sequ, 
		on_doctype_id,
		in_cout_id,
		on_currency_id, 
		on_currencyprice, 
		on_jortype_id,
		on_yyyy,
		on_MM,
		on_ref,
		on_notes,
		in_company_id, 
		on_fyear_id, 
		on_branch_id, 
		on_cc1_id, 
		on_cc2_id, 
		on_creationtime, 
		on_servertime, 
		in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO jorD 		
FOR rec IN SELECT * FROM acc.viw_cout_select WHERE h_id = in_cout_id AND h_company_id = in_company_id
    LOOP
        INSERT INTO acc.tbl_jord(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, MM, ref, notes, 
								 company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, createuser_id )
		VALUES (
			on_jorD_id, on_jor_id, rec.d_amount, 0, rec.d_chart_cin_id, on_doctype_id, in_cout_id, rec.d_currency_id, rec.d_currency_price, on_jortype_id, on_yyyy, on_MM, on_ref,
			rec.d_notes, in_company_id, on_fyear_id, on_branch_id, on_cc1_id, on_cc2_id, on_creationtime, on_servertime, in_user_id);		
			on_jorD_id = on_jorD_id + 1;
							  
		INSERT INTO acc.tbl_jord(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, MM, ref, notes, 
								 company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, createuser_id )
		VALUES (
			on_jorD_id, on_jor_id, 0, rec.d_amount, rec.d_chart_cout_id, on_doctype_id, in_cout_id, rec.d_currency_id, rec.d_currency_price, on_jortype_id, on_yyyy, on_MM, on_ref,
			rec.d_notes, in_company_id, on_fyear_id, on_branch_id, on_cc1_id, on_cc2_id, on_creationtime, on_servertime, in_user_id);		
			on_jorD_id = on_jorD_id + 1;
    END LOOP;	 
------------------------------------------------------------------------------------------------------UPDATE acc.tbl_cout & coutd
	UPDATE acc.tbl_cout SET posted = '1', jor_id = on_jor_id, postedjor_id = on_jor_id  WHERE id = in_cout_id AND company_id = in_company_id;
	UPDATE acc.tbl_coutd SET posted = '1', jor_id = on_jor_id WHERE cout_id = in_cout_id AND company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 68, on_doctype_id, in_cout_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cout_Select where h_id = in_cout_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_cout_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doctype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, on_branch_id, null, in_user_id,68, on_doctype_id, in_cout_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cout_post(in_cout_id character varying, in_posttime timestamp without time zone, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 354 (class 1255 OID 62314)
-- Name: fnc_cout_postcancel(character varying, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cout_postcancel(in_cout_id character varying, in_time timestamp without time zone, in_user_id character varying, in_company_id character varying) RETURNS SETOF acc.viw_cout_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_doctype_id smallint;
	on_branch_id text; 
	on_audit_id bigint;
    on_servertime timestamp;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;	
	on_doctype_id = '20';
	on_branch_id = (select h_branch_id FROM acc.viw_cout_select WHERE h_id = in_cout_id AND h_company_id = in_company_id limit 1);
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
------------------------------------------------------------------------------------------------------UPDATE acc.tbl_cout & coutd
	UPDATE acc.tbl_coutd SET posted = 'false', jor_id = null WHERE cout_id = in_cout_id AND company_id = in_company_id;					
	UPDATE acc.tbl_cout SET posted = 'false', jor_id = null WHERE id = in_cout_id AND company_id = in_company_id;	
------------------------------------------------------------------------------------------------------INSERT INTO jorD 		
 	DELETE FROM acc.tbl_jord WHERE doc_id = in_cout_id AND doctype_id = on_doctype_id AND company_id = in_company_id;
------------------------------------------------------------------------------------------------------DELETE FROM jor 
	DELETE FROM acc.tbl_jor WHERE doc_id = in_cout_id AND doctype_id = on_doctype_id AND company_id = in_company_id;	
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 69, on_doctype_id, in_cout_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_cout_Select where h_id = in_cout_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_cout_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doctype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, on_branch_id, null, in_user_id,69, on_doctype_id, in_cout_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_cout_postcancel(in_cout_id character varying, in_time timestamp without time zone, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 290 (class 1255 OID 62315)
-- Name: fnc_cout_update(character varying, text, character varying, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, json); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_cout_update(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_coutd json) RETURNS SETOF acc.viw_cout_select
    LANGUAGE plpgsql
    AS $$

declare
    on_servertime timestamp;
            on_sequ smallint;
            on_xsequ text;
            on_audit_id bigint;
            -------------------------------------------
                i jsonb;
            on_coutD_amount numeric;
            on_coutD_chart_cin_id text;
            on_coutD_chart_cout_id text;
            on_coutD_notes text;
            on_coutD_paytype_id smallint;
            on_coutD_bank_id smallint;

            on_coutD_checkcardno text;
            on_coutD_checkcarddate timestamp;
            on_coutD_sorno text;
            on_coutD_salno text;
            on_coutD_billdate timestamp;
            on_coutD_manualno text;
            on_coutD_currency_id text;
            on_coutD_currencyprice numeric;

            on_coutD_cc1_id text;
            on_coutD_cc2_id text;
            on_coutD_branch_id text;
            --------------------------------------------
                ex_id integer;
            ex_sqlstate text;
            ex_colname text;
            ex_constraintname text;
            ex_datatype text;
            ex_msgtext text;
            ex_tablename text;
            ex_schemaname text;
            ex_details text;
            ex_hint text;
            ex_context text;
            BEGIN
                ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
            on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
            on_servertime = (select(current_timestamp));

            on_sequ = (select(select max(sequ) from acc.tbl_cout
                              WHERE branch_id = in_branch_id

                              AND company_id = in_company_id
                             ) + 1);

            on_sequ = (select case when(on_sequ is NULL) then 1 else on_sequ end);
            on_xsequ = on_sequ::text;

            ------------------------------------------------------------------------------------------------------DELETE FROM acc.tbl_coutd & cout
DELETE FROM acc.tbl_coutd WHERE cout_id = in_id AND company_id = in_company_id;
            DELETE FROM acc.tbl_cout WHERE id = in_id AND company_id = in_company_id;
            ------------------------------------------------------------------------------------------------------INSERT INTO cout
INSERT INTO acc.tbl_cout(
    id, sequ, notes, creationtime, createservertime, createuser_id, cc1_id, cc2_id, fyear_id, branch_id, company_id)

    VALUES(
        in_id,
        on_sequ,
        in_notes,
        in_creationtime,
        on_servertime,
        in_user_id,
        in_cc1_id,
        in_cc2_id,
        in_fyear_id,
        in_branch_id,
        in_company_id);
            ------------------------------------------------------------------------------------------------------INSERT INTO coutD
FOR i IN SELECT *FROM json_array_elements(in_coutd)
  LOOP

    on_coutD_amount := i->> 'amount';
            on_coutD_chart_cin_id:= i->> 'chart_cin_id';
            on_coutD_chart_cout_id:= i->> 'chart_cout_id';
            on_coutD_notes:= i->> 'notes';
            on_coutD_paytype_id:= i->> 'paytype_id';
            on_coutD_bank_id:= i->> 'bank_id';
            on_coutD_checkcardno:= i->> 'checkcardno';
            on_coutD_checkcarddate:= i->> 'checkcarddate';
            on_coutD_sorno:= i->> 'sorno';
            on_coutD_salno:= i->> 'salno';
            on_coutD_billdate:= i->> 'billdate';
            on_coutD_manualno:= i->> 'manualno';
            on_coutD_currency_id:= i->> 'currency_id';
            on_coutD_currencyprice:= i->> 'currency_price';
            on_coutD_cc1_id:= i->> 'cc1_id';
            on_coutD_cc2_id:= i->> 'cc2_id';
            on_coutD_branch_id:= i->> 'branch_id';

            on_coutD_cc1_id = (select case when(on_coutD_cc1_id IS NULL OR on_coutD_cc1_id = '') THEN in_cc1_id else on_coutD_cc1_id end);
            on_coutD_cc2_id = (select case when(on_coutD_cc2_id IS NULL OR on_coutD_cc2_id = '') THEN in_cc2_id else on_coutD_cc2_id end);
            on_coutD_branch_id = (select case when(on_coutD_branch_id IS NULL OR on_coutD_branch_id = '') THEN in_branch_id else on_coutD_branch_id end);

            INSERT INTO acc.tbl_coutd(
            cout_id, amount, chart_cin_id, chart_cout_id, notes, paytype_id, bank_id, checkcardno, checkcarddate, sorno, salno, billdate,
                manualno, currency_id, currencyprice, creationtime, createservertime, createuser_id,
                cc1_id, cc2_id, fyear_id, branch_id, company_id)


    VALUES(
    in_id,
    on_coutD_amount,
    on_coutD_chart_cin_id,
    on_coutD_chart_cout_id,
    on_coutD_notes,
    on_coutD_paytype_id,
    on_coutD_bank_id,
    on_coutD_checkcardno,
    on_coutD_checkcarddate,
    on_coutD_sorno,
    on_coutD_salno,
    on_coutD_billdate,
    on_coutD_manualno,
    on_coutD_currency_id,
    on_coutD_currencyprice,
    in_creationtime,
    on_servertime,
    in_user_id,
    on_coutD_cc1_id,
    on_coutD_cc2_id,
    in_fyear_id,
    on_coutD_branch_id,
    in_company_id
    );

            END LOOP;
            ------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
    id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)

    VALUES(on_audit_id, on_servertime, 61, 20, in_id, in_user_id, in_company_id);
            ------------------------------------------------------------------------------------------------------Success Return
            RETURN QUERY select *from acc.viw_cout_Select where h_id = in_id;
            ------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN

    GET STACKED DIAGNOSTICS
        ex_sqlstate = RETURNED_SQLSTATE,
        ex_colname = COLUMN_NAME,
        ex_constraintname = CONSTRAINT_NAME,
        ex_datatype = PG_DATATYPE_NAME,
        ex_msgtext = MESSAGE_TEXT,
        ex_tablename = TABLE_NAME,
        ex_schemaname = SCHEMA_NAME,
        ex_details = PG_EXCEPTION_DETAIL,
        ex_hint = PG_EXCEPTION_HINT,
        ex_context = PG_EXCEPTION_CONTEXT;
            DROP TABLE IF EXISTS temp_EX;
            CREATE TEMP TABLE temp_EX as SELECT* from acc.viw_cout_Select where h_id = '0';
            INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL' || ',' || ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
            ------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 61, in_id);
            ------------------------------------------------------------------------------------------------------Faild Return
return QUERY select* from temp_EX;
            End

$$;


ALTER FUNCTION acc.fnc_cout_update(in_id character varying, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_coutd json) OWNER TO postgres;

--
-- TOC entry 220 (class 1259 OID 62317)
-- Name: tbl_jor; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_jor (
    id character varying(15) NOT NULL,
    sequ smallint NOT NULL,
    doctype_id smallint,
    doc_id text,
    currency_id character varying(2) NOT NULL,
    currencyprice numeric DEFAULT 1 NOT NULL,
    jortype_id text,
    yyyy character varying(4) NOT NULL,
    mm character varying(2) NOT NULL,
    ref character varying(3) NOT NULL,
    notes text,
    company_id character varying(2) NOT NULL,
    fyear_id character varying(2),
    branch_id character varying(3),
    cc1_id character varying(50),
    cc2_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    frozen boolean DEFAULT false NOT NULL,
    closed boolean DEFAULT false NOT NULL
);


ALTER TABLE acc.tbl_jor OWNER TO postgres;

--
-- TOC entry 221 (class 1259 OID 62325)
-- Name: tbl_jord; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_jord (
    id integer NOT NULL,
    jor_id character varying(15) NOT NULL,
    debit numeric DEFAULT 0 NOT NULL,
    credit numeric DEFAULT 0 NOT NULL,
    chart_id text NOT NULL,
    doctype_id smallint,
    doc_id text,
    currency_id character varying(2) NOT NULL,
    currencyprice numeric DEFAULT 1 NOT NULL,
    jortype_id text,
    yyyy character varying(4) NOT NULL,
    mm character varying(2) NOT NULL,
    ref character varying(3) NOT NULL,
    notes text,
    company_id character varying(2),
    fyear_id character varying(2),
    branch_id character varying(3),
    cc1_id character varying(50),
    cc2_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    frozen boolean DEFAULT false NOT NULL,
    closed boolean DEFAULT false NOT NULL
);


ALTER TABLE acc.tbl_jord OWNER TO postgres;

--
-- TOC entry 222 (class 1259 OID 62335)
-- Name: viw_jor_select; Type: VIEW; Schema: acc; Owner: postgres
--

CREATE VIEW acc.viw_jor_select AS
 SELECT h.id AS h_id,
    h.doctype_id AS h_doctype_id,
    h.sequ AS h_sequ,
    h.doc_id AS h_doc_id,
    h.currency_id AS h_currency_id,
    h.currencyprice AS h_currencyprice,
    h.jortype_id AS h_jortype_id,
    h.notes AS h_notes,
    h.fyear_id AS h_fyear_id,
    h.branch_id AS h_branch_id,
    h.company_id AS h_company_id,
    h.cc1_id AS h_cc1_id,
    h.cc2_id AS h_cc2_id,
    h.creationtime AS h_creationtime,
    h.createuser_id AS h_createuser_id,
    d.debit AS d_debit,
    d.credit AS d_credit,
    d.chart_id AS d_chart_id,
    c.aname AS d_chart_aname,
    c.ename AS d_chart_ename,
    d.doctype_id AS d_doctype_id,
    d.doc_id AS d_doc_id,
    d.currency_id AS d_currency_id,
    d.currencyprice AS d_currencyprice,
    d.jortype_id AS d_jortype_id,
    d.notes AS d_notes,
    cc1.aname AS d_cc1_aname,
    cc1.ename AS d_cc1_ename,
    d.cc1_id AS d_cc1_id,
    cc2.aname AS d_cc2_aname,
    cc2.ename AS d_cc2_ename,
    d.cc2_id AS d_cc2_id,
    branch.aname AS d_branch_aname,
    branch.ename AS d_branch_ename,
    d.branch_id AS d_branch_id,
    d.company_id
   FROM (((((acc.tbl_jord d
     LEFT JOIN acc.tbl_jor h ON (((d.jor_id)::text = (h.id)::text)))
     LEFT JOIN acc.tbl_chart c ON ((d.chart_id = (c.id)::text)))
     LEFT JOIN acc.tbl_cc cc1 ON (((d.cc1_id)::text = (cc1.id)::text)))
     LEFT JOIN acc.tbl_cc cc2 ON (((d.cc2_id)::text = (cc2.id)::text)))
     LEFT JOIN grl.tbl_branches branch ON (((d.branch_id)::text = (branch.id)::text)))
  WHERE ((branch.company_id)::text = (d.company_id)::text)
  ORDER BY d.ctid;


ALTER TABLE acc.viw_jor_select OWNER TO postgres;

--
-- TOC entry 312 (class 1255 OID 75695)
-- Name: fnc_jor_close(text, json, text, text, boolean, text, timestamp without time zone, text); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_close(in_company_id text, in_branches_ids json, in_oldfyear_id text, in_newfyear_id text, in_cc boolean, in_user_id text, in_date timestamp without time zone, in_notes text) RETURNS SETOF acc.viw_jor_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp; 
	on_int_seq smallint;
	on_string_seq text;
	on_audit_id bigint;
-------------------------------------------
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_date timestamp;
	on_branch_id text;
	on_jor_id text;
	on_jortype_id text;
	on_jorD_id integer;
-------------------------------------------
	i jsonb;
	on_eventtype_id smallint;
	on_doctype_id smallint;
	rec RECORD;
--------------------------------------------
	on_jorD_chart_id text;								   
	on_jorD_debit  numeric;
    on_jorD_credit  numeric;										       		
    on_jorD_currency_id text;
	on_jorD_currencyprice numeric;	
	on_jorD_cc1_id text;
	on_jorD_cc2_id text;
	
	on_balance numeric;
	on_balance_chart_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_jorD_id = (select(select max(id) from acc.tbl_jorD) + 1); if on_jorD_id is null then on_jorD_id = 1; end if;	
	
	on_jortype_id = '2';				
	on_eventtype_id = 70;
	on_doctype_id = 10;
																			
	--CREATE TABLE IF NOT EXISTS acc.tbl_arch_jor( like acc.tbl_jor including all);
							
FOR i IN SELECT * FROM json_array_elements(in_branches_ids)
  LOOP
			
	on_branch_id := i->>'id';
	on_yyyy = (select extract(year from   in_date));
	on_MM = (select extract(month from   in_date));
	on_MM = (select case when (length(on_MM) = 1) then (select concat('0',on_MM)) else on_MM end);
	on_ref = '000';

	on_int_seq = 1;
	on_string_seq = '00001';											
	
	on_date = (select beigndate from grl.tbl_fyears where id = in_newfyear_id);												
	on_yy = (select substring((select extract(year from (select beigndate from grl.tbl_fyears where id = in_newfyear_id))::text) from 3 for 2));	
	on_jor_id = (on_branch_id || on_yy || on_string_seq);	
											  
							  
	WHILE exists(select 1 from acc.tbl_cin where postedjor_id = on_branch_id)
	loop
		on_int_seq = on_int_seq + 1;
		on_string_seq = on_sequ::text;
		on_string_seq = repeat('0', 5 - length(on_string_seq)) || on_string_seq;
		on_jor_id = (on_branch_id || on_yy || on_string_seq);
	end loop;	
							  
	WHILE exists(select 1 from acc.tbl_cout where postedjor_id = on_jor_id)
	loop
		on_int_seq = on_int_seq + 1;
		on_string_seq = on_sequ::text;
		on_string_seq = repeat('0', 5 - length(on_string_seq)) || on_string_seq;
		on_jor_id = (on_branch_id || on_yy || on_string_seq);
	end loop;						
							
							
  	INSERT INTO acc.tbl_jor(id, sequ, jortype_id, currency_id, yyyy, MM, ref, notes, company_id, fyear_id, 
	branch_id, creationtime, createservertime, createuser_id, frozen)
	VALUES (
		on_jor_id, 
		on_int_seq, 
		on_jortype_id,
		'01',
		on_yyyy,
		on_MM,
		on_ref,
		in_notes,
		in_company_id, 
		in_newfyear_id, 
		on_branch_id, 
		on_date, 
		on_servertime, 
		in_user_id,
	    'true');	
------------------------------------------------------------------------------------------------------INSERT INTO acc.tbl_jord	
	 DROP TABLE IF EXISTS temp_close;
	 IF (in_cc = 'true') THEN											   
	 	CREATE TEMP TABLE temp_close as SELECT * from acc.fnc_jor_close_jord_cc(in_company_id, on_branch_id, in_oldfyear_id) order by ret_chart_id;
	 ELSE	
		CREATE TEMP TABLE temp_close as SELECT * from acc.fnc_jor_close_jord(in_company_id, on_branch_id, in_oldfyear_id) order by ret_chart_id;									   
	 END IF;									   
											   
	 FOR rec IN SELECT * FROM temp_close
        LOOP
			on_jorD_chart_id = rec.ret_chart_id;								   
			on_jorD_debit = rec.ret_debit;
    		on_jorD_credit = rec.ret_credit;										       		
    		on_jorD_currency_id = rec.ret_currency_id;
			on_jorD_currencyprice = rec.ret_currencyprice;									   
			IF (in_cc = 'true') THEN on_jorD_cc1_id = rec.ret_cc1_id; ELSE  on_jorD_cc1_id = NULL; END IF;
			IF (in_cc = 'true') THEN on_jorD_cc2_id = rec.ret_cc2_id; ELSE  on_jorD_cc1_id = NULL; END IF;							   
											   
			IF (on_jorD_debit > on_jorD_credit) THEN		   		 
				on_jorD_debit = on_jorD_debit - on_jorD_credit;
				on_jorD_credit = 0;	
		   ELSIF(on_jorD_debit < on_jorD_credit) THEN
				on_jorD_credit = on_jorD_credit - on_jorD_debit;
				on_jorD_debit = 0;	
		   ELSIF(on_jorD_debit = on_jorD_credit) THEN	
				on_jorD_debit = 0;
				on_jorD_credit = 0;	
		   END IF;								   
			
			IF 	(on_jorD_debit <> on_jorD_credit) THEN						   
			INSERT INTO acc.tbl_jord
    		(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, 
			 currencyprice, cc1_id, cc2_id, jortype_id, yyyy, mm, ref, 
			 company_id, fyear_id, branch_id, 
			 creationtime, createservertime, createuser_id, frozen)	
			VALUES
			(on_jord_id, on_jor_id, on_jorD_debit, on_jorD_credit, on_jorD_chart_id, on_doctype_id, on_jor_id, on_jorD_currency_id,
			 on_jorD_currencyprice, on_jorD_cc1_id, on_jorD_cc2_id, on_jortype_id, on_yyyy, on_mm, on_ref, 
			 in_company_id, in_newfyear_id, on_branch_id, 
		     on_date, on_servertime, in_user_id, 'true'
			);
   		
			on_jorD_id = on_jorD_id + 1;	
			END IF;									   
 		END LOOP;			
		
	 on_balance = (select sum(ret_debit) - sum(ret_credit) from temp_close);
											   
	 IF on_balance > 1 THEN 
	 	on_balance_chart_id = (SELECT id FROM acc.tbl_chart WHERE stop = 'false' AND company_id = in_company_id AND parent = 'false' AND property_id = '4' limit 1);
			INSERT INTO acc.tbl_jord
    		(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, 
			 currencyprice, cc1_id, cc2_id, jortype_id, yyyy, mm, ref, 
			 company_id, fyear_id, branch_id, 
			 creationtime, createservertime, createuser_id, frozen)	
			VALUES
			(on_jord_id, on_jor_id, 0, on_balance, on_balance_chart_id, on_doctype_id, on_jor_id, on_jorD_currency_id,
			 on_jorD_currencyprice, on_jorD_cc1_id, on_jorD_cc2_id, on_jortype_id, on_yyyy, on_mm, on_ref, 
			 in_company_id, in_newfyear_id, on_branch_id, 
		     on_date, on_servertime, in_user_id, 'true'
			);
											   
	 ELSEIF on_balance < 1 THEN 
	 	on_balance_chart_id = (SELECT id FROM acc.tbl_chart WHERE stop = 'false' AND company_id = in_company_id AND parent = 'false' AND property_id = '5' limit 1);	
		on_balance = on_balance * -1;								   
			INSERT INTO acc.tbl_jord
    		(id, jor_id, debit, credit, chart_id, doctype_id, doc_id, currency_id, 
			 currencyprice, cc1_id, cc2_id, jortype_id, yyyy, mm, ref, 
			 company_id, fyear_id, branch_id, 
			 creationtime, createservertime, createuser_id, frozen)	
			VALUES
			(on_jord_id, on_jor_id, on_balance, 0, on_balance_chart_id, on_doctype_id, on_jor_id, on_jorD_currency_id,
			 on_jorD_currencyprice, on_jorD_cc1_id, on_jorD_cc2_id, on_jortype_id, on_yyyy, on_mm, on_ref, 
			 in_company_id, in_newfyear_id, on_branch_id, 
		     on_date, on_servertime, in_user_id, 'true'
			);									   
											   
	 END IF;										   
											   
END LOOP;										   
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, on_eventtype_id, on_doctype_id, on_jor_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_jor_Select where h_id = on_jor_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_jor_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, on_branch_id, null, in_user_id, on_eventtype_id, on_jor_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_jor_close(in_company_id text, in_branches_ids json, in_oldfyear_id text, in_newfyear_id text, in_cc boolean, in_user_id text, in_date timestamp without time zone, in_notes text) OWNER TO postgres;

--
-- TOC entry 310 (class 1255 OID 75693)
-- Name: fnc_jor_close_jord(text, text, text); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_close_jord(in_company_id text, in_branch_id text, in_fyear_id text) RETURNS TABLE(ret_chart_id text, ret_debit numeric, ret_credit numeric, ret_currency_id character varying, ret_currencyprice numeric)
    LANGUAGE plpgsql
    AS $$

BEGIN

RETURN QUERY SELECT chart_id, sum(debit) AS debit, sum(credit) AS credit, currency_id, currencyprice
FROM acc.tbl_jord
WHERE company_id = in_company_id AND branch_id = in_branch_id AND fyear_id = in_fyear_id AND chart_id IN (select id from acc.tbl_chart where menue_id = '1')
GROUP BY chart_id, currency_id, currencyprice;

End

$$;


ALTER FUNCTION acc.fnc_jor_close_jord(in_company_id text, in_branch_id text, in_fyear_id text) OWNER TO postgres;

--
-- TOC entry 317 (class 1255 OID 75694)
-- Name: fnc_jor_close_jord_cc(text, text, text); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_close_jord_cc(in_company_id text, in_branch_id text, in_fyear_id text) RETURNS TABLE(ret_chart_id text, ret_debit numeric, ret_credit numeric, ret_currency_id character varying, ret_currencyprice numeric, ret_cc1_id character varying, ret_cc2_id character varying)
    LANGUAGE plpgsql
    AS $$

BEGIN

RETURN QUERY SELECT chart_id, sum(debit) AS debit, sum(credit) AS credit, currency_id, currencyprice, cc1_id, cc2_id
FROM acc.tbl_jord
WHERE company_id = in_company_id AND branch_id = in_branch_id AND fyear_id = in_fyear_id AND chart_id IN (select id from acc.tbl_chart where menue_id = '1')
GROUP BY chart_id, currency_id, currencyprice, cc1_id, cc2_id;

End

$$;


ALTER FUNCTION acc.fnc_jor_close_jord_cc(in_company_id text, in_branch_id text, in_fyear_id text) OWNER TO postgres;

--
-- TOC entry 311 (class 1255 OID 62342)
-- Name: fnc_jor_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_delete(in_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF acc.viw_jor_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id integer;
	on_jorD_id integer;
	on_servertime timestamp; 
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_jorRefType text;
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from acc.tbl_joredit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));					 					 
------------------------------------------------------------------------------------------------------INSERT INTO joredit
INSERT INTO acc.tbl_joredit(
	id, jor_id, sequ, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, mm, ref, 
	notes, company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, editingtime, editservertime, 
	createuser_id, edituser_id, edit, delete)
SELECT on_edit_id, id, sequ, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, mm, ref, 
	notes, company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, on_servertime, on_servertime, 
	createuser_id, in_user_id, edit, 1
	FROM acc.tbl_jor j WHERE j.id = in_id AND j.company_id = in_company_id;
	
------------------------------------------------------------------------------------------------------INSERT INTO jordedit
INSERT INTO acc.tbl_jordedit(
	jord_id, jor_id, debit, credit, 
	chart_id, doctype_id, doc_id, currency_id, currencyprice, 
	jortype_id, yyyy, mm, ref,notes, 
	company_id, fyear_id, branch_id, cc1_id, cc2_id, 
	creationtime, createservertime, editingtime, editservertime,createuser_id, edituser_id, edit, delete)
	
SELECT id, jor_id, debit, credit, 
	chart_id, doctype_id, doc_id, currency_id, currencyprice, 
	jortype_id, yyyy, mm, ref, notes, 
	company_id, fyear_id, branch_id, cc1_id, cc2_id, 
	creationtime, createservertime, on_servertime, on_servertime, createuser_id, in_user_id, edit, 1
	FROM acc.tbl_jord jd WHERE jd.jor_id = in_id AND jd.company_id = in_company_id;
	
	
DELETE FROM acc.tbl_jord jd WHERE jd.jor_id = in_id AND jd.company_id = in_company_id;
DELETE FROM acc.tbl_jor j WHERE j.id = in_id AND j.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 32, 10, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_jor_Select where h_id = in_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_jor_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id,32, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_jor_delete(in_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 304 (class 1255 OID 62343)
-- Name: fnc_jor_insert(character varying, character varying, numeric, text, text, character varying, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, json); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_insert(in_id character varying, in_currency_id character varying, in_currencyprice numeric, in_jortype_id text, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_jord json) RETURNS SETOF acc.viw_jor_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_jorD_id integer;
	on_servertime timestamp; 
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_jorRefType text;
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
-------------------------------------------
	i jsonb;
	on_jorD_debit numeric;
	on_jorD_credit numeric;
	on_jorD_chart_id text;
	on_jorD_notes text;
	on_jorD_cc1_id text;
	on_jorD_cc2_id text;
	on_jorD_branch_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_jorD_id = (select(select max(id) from acc.tbl_jorD) + 1); if on_jorD_id is null then on_jorD_id = 1; end if;
	on_servertime = (select(current_timestamp));
	
	on_yyyy = (select extract(year from   in_creationtime));
	on_MM = (select extract(month from   in_creationtime));
	on_MM = (select case when (length(on_MM) = 1) then (select concat('0',on_MM)) else on_MM end);
	on_ref = '000';
													
		
	--on_yy = (select substring(on_yyyy from 3 for 2));
	on_yy = (select substring((select extract(year from (select beigndate from grl.tbl_fyears where id = in_fyear_id))::text) from 3 for 2));	
													
	
	--on_sequ = (select(select max(sequ) from acc.tbl_jor
					  --where company_id = in_company_id
					  --and branch_id = in_branch_id
					  --and yyyy = on_yyyy
					  --and mm = on_MM
					  --and ref = on_ref			   
					 --) + 1);
					 
	on_sequ = (select(select max(sequ) from acc.tbl_jor
					  WHERE company_id = in_company_id	
					  AND branch_id = in_branch_id
					  AND fyear_id = in_fyear_id
					 ) + 1);
    on_sequ = (select case when (on_sequ is NULL) then 1 else on_sequ end);
	on_xsequ = on_sequ::text;	
	on_xsequ = repeat('0', 5 - length(on_xsequ)) || on_xsequ;
									
					 					 

	--in_id = (in_branch_id || on_yy || on_MM || on_ref || on_xsequ);
							  
	in_id = (in_branch_id || on_yy || on_xsequ);
								
							  
	WHILE exists(select * from acc.tbl_cin where postedjor_id = in_id)
	loop
		on_sequ = on_sequ + 1;
		on_xsequ = on_sequ::text;
		on_xsequ = repeat('0', 5 - length(on_xsequ)) || on_xsequ;
		in_id = (in_branch_id || on_yy || on_xsequ);
	end loop;	
							  
	WHILE exists(select * from acc.tbl_cout where postedjor_id = in_id)
	loop
		on_sequ = on_sequ + 1;
		on_xsequ = on_sequ::text;
		on_xsequ = repeat('0', 5 - length(on_xsequ)) || on_xsequ;								  
		in_id = (in_branch_id || on_yy || on_xsequ);
	end loop;	
------------------------------------------------------------------------------------------------------INSERT INTO jor 
INSERT INTO acc.tbl_jor(
	id, 
	sequ, 
	currency_id, 
	currencyprice, 
	jortype_id, 
	yyyy,
	MM,
	ref,
	notes, 
	company_id, 
	fyear_id, 
	branch_id, 
	cc1_id, 
	cc2_id, 
	creationtime, 
	createservertime, 
	createuser_id)
	VALUES (
		in_id, 
		on_sequ, 
		in_currency_id, 
		in_currencyprice, 
		in_jortype_id,
		on_yyyy,
		on_MM,
		on_ref,
		in_notes,
		in_company_id, 
		in_fyear_id, 
		in_branch_id, 
		in_cc1_id, 
		in_cc2_id, 
		in_creationtime, 
		on_servertime, 
		in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO jorD 
FOR i IN SELECT * FROM json_array_elements(in_jord)
  LOOP
  	on_jorD_debit := i->>'debit';
    on_jorD_credit := i->>'credit';
    on_jorD_chart_id := i->>'chart_id';
    on_jorD_notes := i->>'notes';
    on_jorD_cc1_id := i->>'cc1_id';
    on_jorD_cc2_id := i->>'cc2_id';
    on_jorD_branch_id := i->>'branch_id';
	
 	on_jorD_debit = (select case when (on_jorD_debit IS NULL) THEN 0 else on_jorD_debit end);
	on_jorD_credit = (select case when (on_jorD_credit IS NULL) THEN 0 else on_jorD_credit end);
	on_jorD_notes = (select case when (on_jorD_notes IS NULL OR on_jorD_notes = '') THEN in_notes else on_jorD_notes end);
	on_jorD_cc1_id = (select case when (on_jorD_cc1_id IS NULL OR on_jorD_cc1_id = '') THEN in_cc1_id else on_jorD_cc1_id end);
	on_jorD_cc2_id = (select case when (on_jorD_cc2_id IS NULL OR on_jorD_cc2_id = '') THEN in_cc2_id else on_jorD_cc2_id end);
	on_jorD_branch_id = (select case when (on_jorD_branch_id IS NULL OR on_jorD_branch_id = '') THEN in_branch_id else on_jorD_branch_id end);
	
	INSERT INTO acc.tbl_jord(
	id, 
	jor_id, 
	debit, 
	credit, 
	chart_id, 
	currency_id, 
	currencyprice, 
	jortype_id, 
	yyyy,
	MM,
	ref,
	notes, 
	company_id, 
	fyear_id, 
	branch_id, 
	cc1_id, 
	cc2_id, 
	creationtime, 
	createservertime, 
	createuser_id )
	VALUES (
		on_jorD_id, 
		in_id, 
		on_jorD_debit, 
		on_jorD_credit, 
		on_jorD_chart_id, 	
		in_currency_id, 
		in_currencyprice, 
		in_jortype_id, 
		on_yyyy,
		on_MM,
		on_ref,
		on_jorD_notes, 	
		in_company_id, 
		in_fyear_id,
		on_jorD_branch_id, 
		on_jorD_cc1_id, 
		on_jorD_cc2_id, 
		in_creationtime, 
		on_servertime, 
		in_user_id);
		
	on_jorD_id = on_jorD_id + 1;
 END LOOP;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 30, 10, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_jor_Select where h_id = in_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_jor_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id,30, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_jor_insert(in_id character varying, in_currency_id character varying, in_currencyprice numeric, in_jortype_id text, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_jord json) OWNER TO postgres;

--
-- TOC entry 335 (class 1255 OID 62345)
-- Name: fnc_jor_select(character varying, integer, character varying, character varying, text); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_select(in_id character varying, in_sequ integer, in_branch_id character varying, in_company_id character varying, in_selecttype text) RETURNS SETOF acc.viw_jor_select
    LANGUAGE plpgsql
    AS $$

declare 

BEGIN
------------------------------------------------------------------------------------------------------Select
IF in_selecttype = 'Select' THEN 

RETURN QUERY SELECT * FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id;

END IF;
------------------------------------------------------------------------------------------------------Search
IF in_selecttype = 'Search' THEN 

RETURN QUERY SELECT * FROM acc.viw_jor_Select WHERE h_sequ = in_sequ AND h_branch_id = in_branch_id AND h_company_id = in_company_id;

END IF;
------------------------------------------------------------------------------------------------------First
IF in_selecttype = 'First' THEN 

in_id = (SELECT h_id FROM acc.viw_jor_Select WHERE h_branch_id = in_branch_id AND h_company_id = in_company_id ORDER BY h_sequ ASC LIMIT 1);
RETURN QUERY SELECT * FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id;

END IF;
------------------------------------------------------------------------------------------------------Prev
IF in_selecttype = 'Prev' THEN 

in_sequ = (SELECT h_sequ FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id LIMIT 1);
in_id = (SELECT h_id FROM acc.viw_jor_Select WHERE h_sequ < in_sequ AND h_branch_id = in_branch_id AND h_company_id = in_company_id ORDER BY h_sequ Desc LIMIT 1);
RETURN QUERY SELECT * FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id;

END IF;
------------------------------------------------------------------------------------------------------Next
IF in_selecttype = 'Next' THEN 

in_sequ = (SELECT h_sequ FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id LIMIT 1);
in_id = (SELECT h_id FROM acc.viw_jor_Select WHERE h_sequ > in_sequ AND h_branch_id = in_branch_id AND h_company_id = in_company_id ORDER BY h_sequ ASC LIMIT 1);
RETURN QUERY SELECT * FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id;

END IF;
------------------------------------------------------------------------------------------------------Last
IF in_selecttype = 'Last' THEN 

in_id = (SELECT h_id FROM acc.viw_jor_Select WHERE h_branch_id = in_branch_id AND h_company_id = in_company_id ORDER BY h_sequ Desc LIMIT 1);
RETURN QUERY SELECT * FROM acc.viw_jor_Select WHERE h_id = in_id AND h_company_id = in_company_id;

END IF;

End

$$;


ALTER FUNCTION acc.fnc_jor_select(in_id character varying, in_sequ integer, in_branch_id character varying, in_company_id character varying, in_selecttype text) OWNER TO postgres;

--
-- TOC entry 318 (class 1255 OID 62346)
-- Name: fnc_jor_update(character varying, character varying, numeric, text, text, character varying, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, json); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.fnc_jor_update(in_id character varying, in_currency_id character varying, in_currencyprice numeric, in_jortype_id text, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_jord json) RETURNS SETOF acc.viw_jor_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_current_edit smallint;
	on_edit_id integer;
	on_jorD_id integer;
	on_servertime timestamp; 
	on_yyyy text;
	on_yy text;
	on_MM text;
	on_ref text;
	on_jorRefType text;
	on_sequ smallint;
	on_xsequ text;
	on_audit_id bigint;
-------------------------------------------
	i jsonb;
	on_jorD_debit numeric;
	on_jorD_credit numeric;
	on_jorD_chart_id text;
	on_jorD_notes text;
	on_jorD_cc1_id text;
	on_jorD_cc2_id text;
	on_jorD_branch_id text;
--------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from acc.tbl_joredit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_jorD_id = (select(select max(id) from acc.tbl_jorD) + 1); if on_jorD_id is null then on_jorD_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from acc.tbl_jor  WHERE id = in_id AND company_id = in_company_id) + 1);
	
	on_yyyy = (select extract(year from   in_creationtime));
	on_MM = (select extract(month from   in_creationtime));
	on_MM = (select case when (length(on_MM) = 1) then (select concat('0',on_MM)) else on_MM end);
	on_ref = '000';
	
	on_sequ = (select sequ from acc.tbl_jor WHERE id = in_id AND company_id = in_company_id);					 					 
------------------------------------------------------------------------------------------------------INSERT INTO joredit
INSERT INTO acc.tbl_joredit(
	id, jor_id, sequ, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, mm, ref, 
	notes, company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, editingtime, editservertime, 
	createuser_id, edituser_id, edit)
SELECT on_edit_id, id, sequ, doctype_id, doc_id, currency_id, currencyprice, jortype_id, yyyy, mm, ref, 
	notes, company_id, fyear_id, branch_id, cc1_id, cc2_id, creationtime, createservertime, in_creationtime, on_servertime, 
	createuser_id, in_user_id, on_current_edit
	FROM acc.tbl_jor j WHERE j.id = in_id AND j.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO jordedit
INSERT INTO acc.tbl_jordedit(
	jord_id, jor_id, debit, credit, 
	chart_id, doctype_id, doc_id, currency_id, currencyprice, 
	jortype_id, yyyy, mm, ref,notes, 
	company_id, fyear_id, branch_id, cc1_id, cc2_id, 
	creationtime, createservertime, editingtime, editservertime,createuser_id, edituser_id, edit)
	
SELECT id, jor_id, debit, credit, 
	chart_id, doctype_id, doc_id, currency_id, currencyprice, 
	jortype_id, yyyy, mm, ref, notes, 
	company_id, fyear_id, branch_id, cc1_id, cc2_id, 
	creationtime, createservertime, in_creationtime, on_servertime, createuser_id, in_user_id, on_current_edit
	FROM acc.tbl_jord jd WHERE jd.jor_id = in_id AND jd.company_id = in_company_id;
	
DELETE FROM acc.tbl_jord jd WHERE jd.jor_id = in_id AND jd.company_id = in_company_id;
DELETE FROM acc.tbl_jor j WHERE j.id = in_id AND j.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO jor
INSERT INTO acc.tbl_jor(
	id, 
	sequ, 
	currency_id, 
	currencyprice, 
	jortype_id, 
	yyyy,
	MM,
	ref,
	notes, 
	company_id, 
	fyear_id, 
	branch_id, 
	cc1_id, 
	cc2_id, 
	creationtime, 
	createservertime, 
	createuser_id)
	VALUES (
		in_id, 
		on_sequ, 
		in_currency_id, 
		in_currencyprice, 
		in_jortype_id,
		on_yyyy,
		on_MM,
		on_ref,
		in_notes,
		in_company_id, 
		in_fyear_id, 
		in_branch_id, 
		in_cc1_id, 
		in_cc2_id, 
		in_creationtime, 
		on_servertime, 
		in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO jorD 
FOR i IN SELECT * FROM json_array_elements(in_jord)
  LOOP
  	on_jorD_debit := i->>'debit';
    on_jorD_credit := i->>'credit';
    on_jorD_chart_id := i->>'chart_id';
    on_jorD_notes := i->>'notes';
    on_jorD_cc1_id := i->>'cc1_id';
    on_jorD_cc2_id := i->>'cc2_id';
    on_jorD_branch_id := i->>'branch_id';
	
 	on_jorD_debit = (select case when (on_jorD_debit IS NULL) THEN 0 else on_jorD_debit end);
	on_jorD_credit = (select case when (on_jorD_credit IS NULL) THEN 0 else on_jorD_credit end);
	on_jorD_notes = (select case when (on_jorD_notes IS NULL OR on_jorD_notes = '') THEN in_notes else on_jorD_notes end);
	on_jorD_cc1_id = (select case when (on_jorD_cc1_id IS NULL OR on_jorD_cc1_id = '') THEN in_cc1_id else on_jorD_cc1_id end);
	on_jorD_cc2_id = (select case when (on_jorD_cc2_id IS NULL OR on_jorD_cc2_id = '') THEN in_cc2_id else on_jorD_cc2_id end);
	on_jorD_branch_id = (select case when (on_jorD_branch_id IS NULL OR on_jorD_branch_id = '') THEN in_branch_id else on_jorD_branch_id end);
	
	INSERT INTO acc.tbl_jord(
	id, 
	jor_id, 
	debit, 
	credit, 
	chart_id, 
	currency_id, 
	currencyprice, 
	jortype_id, 
	yyyy,
	MM,
	ref,
	notes, 
	company_id, 
	fyear_id, 
	branch_id, 
	cc1_id, 
	cc2_id, 
	creationtime, 
	createservertime, 
	createuser_id )
	VALUES (
		on_jorD_id, 
		in_id, 
		on_jorD_debit, 
		on_jorD_credit, 
		on_jorD_chart_id, 	
		in_currency_id, 
		in_currencyprice, 
		in_jortype_id, 
		on_yyyy,
		on_MM,
		on_ref,
		on_jorD_notes, 	
		in_company_id, 
		in_fyear_id,
		on_jorD_branch_id, 
		on_jorD_cc1_id, 
		on_jorD_cc2_id, 
		in_creationtime, 
		on_servertime, 
		in_user_id);
		
	on_jorD_id = on_jorD_id + 1;
 END LOOP;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 31, 10, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from acc.viw_jor_Select where h_id = in_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from acc.viw_jor_Select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id,31, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION acc.fnc_jor_update(in_id character varying, in_currency_id character varying, in_currencyprice numeric, in_jortype_id text, in_notes text, in_company_id character varying, in_fyear_id character varying, in_branch_id character varying, in_cc1_id character varying, in_cc2_id character varying, in_creationtime timestamp without time zone, in_user_id character varying, in_jord json) OWNER TO postgres;

--
-- TOC entry 365 (class 1255 OID 62348)
-- Name: sysfnc_cclevel(text, text); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.sysfnc_cclevel(in_parent_id text, in_company_id text) RETURNS smallint
    LANGUAGE plpgsql
    AS $$

DECLARE
	on_level smallint;
BEGIN
	on_level = 
	(SELECT
		CASE WHEN (in_parent_id IS NULL OR	 in_parent_id = '') THEN 1 
		ELSE  (select acc.tbl_cc.level from acc.tbl_cc where acc.tbl_cc.id = in_parent_id
			  	AND acc.tbl_cc.company_id = in_company_id) + 1 
		END);
	RETURN on_level;
END

$$;


ALTER FUNCTION acc.sysfnc_cclevel(in_parent_id text, in_company_id text) OWNER TO postgres;

--
-- TOC entry 326 (class 1255 OID 62349)
-- Name: sysfnc_ccsequ(integer, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.sysfnc_ccsequ(in_level integer, in_parent_id character varying, in_company_id character varying) RETURNS smallint
    LANGUAGE plpgsql
    AS $$

DECLARE
	on_sequ smallint;
BEGIN
	on_sequ = 
	(SELECT
		CASE WHEN (in_level = 1) THEN 
	 			(select MAX(acc.tbl_cc.sequ)+1 from acc.tbl_cc where acc.tbl_cc.level = 1 AND company_id = in_company_id)
			 WHEN (in_level > 1) THEN 
	 			(select MAX(acc.tbl_cc.sequ)+1 from acc.tbl_cc where acc.tbl_cc.parent_id = in_parent_id AND company_id = in_company_id) 
		END);
		
		if on_sequ is null then on_sequ = 1; end if;
	RETURN on_sequ;
END

$$;


ALTER FUNCTION acc.sysfnc_ccsequ(in_level integer, in_parent_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 315 (class 1255 OID 62350)
-- Name: sysfnc_chartlevel(text, text); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.sysfnc_chartlevel(in_parent_id text, in_company_id text) RETURNS smallint
    LANGUAGE plpgsql
    AS $$

DECLARE
	on_level smallint;
BEGIN
	on_level = 
	(SELECT
		CASE WHEN (in_parent_id IS NULL OR	 in_parent_id = '') THEN 1 
		ELSE  (select acc.tbl_chart.level from acc.tbl_chart where acc.tbl_chart.id = in_parent_id
			  	AND acc.tbl_chart.company_id = in_company_id) + 1 
		END);
	RETURN on_level;
END

$$;


ALTER FUNCTION acc.sysfnc_chartlevel(in_parent_id text, in_company_id text) OWNER TO postgres;

--
-- TOC entry 306 (class 1255 OID 62351)
-- Name: sysfnc_chartsequ(integer, character varying, character varying); Type: FUNCTION; Schema: acc; Owner: postgres
--

CREATE FUNCTION acc.sysfnc_chartsequ(in_level integer, in_parent_id character varying, in_company_id character varying) RETURNS smallint
    LANGUAGE plpgsql
    AS $$

DECLARE
	on_sequ smallint;
BEGIN
	on_sequ = 
	(SELECT
		CASE WHEN (in_level = 1) THEN 
	 			(select MAX(acc.tbl_chart.sequ)+1 from acc.tbl_chart where acc.tbl_chart.level = 1 AND company_id = in_company_id)
			 WHEN (in_level > 1) THEN 
	 			(select MAX(acc.tbl_chart.sequ)+1 from acc.tbl_chart where acc.tbl_chart.parent_id = in_parent_id AND company_id = in_company_id) 
		END);
		
		if on_sequ is null then on_sequ = 1; end if;
	RETURN on_sequ;
END

$$;


ALTER FUNCTION acc.sysfnc_chartsequ(in_level integer, in_parent_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 223 (class 1259 OID 62352)
-- Name: tbl_areas; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_areas (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    city_id character varying(4)
);


ALTER TABLE grl.tbl_areas OWNER TO postgres;

--
-- TOC entry 358 (class 1255 OID 62359)
-- Name: fnc_areas_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_areas_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_areas
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_areasedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_areas t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO grl.tbl_areasedit(
	id,area_id, sequ, aname, ename, company_id, city_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, city_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1
	FROM grl.tbl_areas WHERE grl.tbl_areas.id = in_id;
Delete From grl.tbl_areas
	WHERE grl.tbl_areas.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 38, 12, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_areas order by grl.tbl_areas.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_areas where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 38, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_areas_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 359 (class 1255 OID 62360)
-- Name: fnc_areas_insert(character varying, text, text, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_areas_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_user_id character varying, in_city_id character varying) RETURNS SETOF grl.tbl_areas
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_areas) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO grl.tbl_areas(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,city_id)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_city_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 36, 12, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_areas order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_areas where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 36, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_areas_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_user_id character varying, in_city_id character varying) OWNER TO postgres;

--
-- TOC entry 328 (class 1255 OID 62361)
-- Name: fnc_areas_update(character varying, character varying, character varying, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_areas_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_city_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_areas
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_areasedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_areas t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO grl.tbl_areasedit(
	id,area_id, sequ,aname, ename, company_id,city_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit)
	SELECT on_edit_id,id, sequ, aname, ename, company_id,in_city_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit
	FROM grl.tbl_areas WHERE grl.tbl_areas.id = in_id;
UPDATE grl.tbl_areas
	SET aname=in_aname, ename=in_ename,city_id=in_city_id, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE grl.tbl_areas.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 37, 12, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_areas order by grl.tbl_areas.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_areas where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 37, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_areas_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_city_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 367 (class 1255 OID 62362)
-- Name: fnc_branches_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_branches_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_branches
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_branchesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_branches t WHERE t.id = in_id AND t.company_id = in_company_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editbranches & Delete branches
INSERT INTO grl.tbl_branchesedit(
	id, 
	branches_id, 
	sequ, 
	aname, 
	ename, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	email, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	creationtime, 
	editingtime, 
	createuser_id, 
	edituser_id, 
	edit)
SELECT 
	on_edit_id, 
	id, 
	sequ, 
	aname, 
	ename, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	email, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	creationtime, 
	on_servertime, 
	createuser_id, 
	in_user_id, 
	on_current_edit
	FROM grl.tbl_branches t
	WHERE t.id = in_id 
	AND t.company_id = in_company_id;
	
Delete From grl.tbl_branches t WHERE t.id = in_id 
							   AND t.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 8, 2, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_branches WHERE company_id = in_company_id ORDER BY grl.tbl_branches.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_branches where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 8, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_branches_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 346 (class 1255 OID 62363)
-- Name: fnc_branches_insert(character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, text, boolean, timestamp without time zone, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_branches_insert(in_id character varying, in_aname character varying, in_ename character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_email character varying, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) RETURNS SETOF grl.tbl_branches
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_branches WHERE company_id = in_company_id) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 3)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO branches 
INSERT INTO grl.tbl_branches(
	id, sequ, aname, ename, mobile1, mobile2, phone1, phone2, email, stop, activetime, notes, company_id, creationtime, createuser_id)
	VALUES (in_id, on_xseq, in_aname, in_ename, in_mobile1, in_mobile2, in_phone1, in_phone2, in_email, in_stop, in_activetime, in_notes, in_company_id, on_servertime, in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 6, 2, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_branches WHERE company_id = in_company_id ORDER BY grl.tbl_branches.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_branches where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id,6, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_branches_insert(in_id character varying, in_aname character varying, in_ename character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_email character varying, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 325 (class 1255 OID 62364)
-- Name: fnc_branches_update(character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, text, boolean, timestamp without time zone, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_branches_update(in_id character varying, in_aname character varying, in_ename character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_email character varying, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) RETURNS SETOF grl.tbl_branches
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_branchesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_branches t WHERE t.id = in_id AND t.company_id = in_company_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_branchesedit & Update branches
INSERT INTO grl.tbl_branchesedit(
	id, 
	branches_id, 
	sequ, 
	aname, 
	ename, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	email, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	creationtime, 
	editingtime, 
	createuser_id, 
	edituser_id, 
	edit)
SELECT 
	on_edit_id, 
	id, 
	sequ, 
	aname, 
	ename, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	email, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	creationtime, 
	on_servertime, 
	createuser_id, 
	in_user_id, 
	on_current_edit
	FROM grl.tbl_branches 
	WHERE grl.tbl_branches.id = in_id 
	AND grl.tbl_branches.company_id = in_company_id;
	
UPDATE grl.tbl_branches t
	SET aname=in_aname, ename=in_ename, mobile1=in_mobile1, mobile2=in_mobile2, phone1=in_phone1, phone2=in_phone2, email=in_email, stop=in_stop, activetime=in_activetime, notes=in_notes, company_id=in_company_id, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE t.id = in_id AND t.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 7, 2, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_branches WHERE company_id = in_company_id ORDER BY grl.tbl_branches.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_branches where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 7, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_branches_update(in_id character varying, in_aname character varying, in_ename character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_email character varying, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 224 (class 1259 OID 62365)
-- Name: tbl_cities; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_cities (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    country_id character varying(4)
);


ALTER TABLE grl.tbl_cities OWNER TO postgres;

--
-- TOC entry 302 (class 1255 OID 62372)
-- Name: fnc_cities_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_cities_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_cities
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_citiesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_cities t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO grl.tbl_citiesedit(
	id,city_id, sequ, aname, ename, company_id, country_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, country_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1
	FROM grl.tbl_cities WHERE grl.tbl_cities.id = in_id;
Delete From grl.tbl_cities
	WHERE grl.tbl_cities.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 35, 11, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_cities order by grl.tbl_cities.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_cities where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 35, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_cities_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 348 (class 1255 OID 62373)
-- Name: fnc_cities_insert(character varying, text, text, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_cities_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_user_id character varying, in_country_id character varying) RETURNS SETOF grl.tbl_cities
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_cities) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO grl.tbl_cities(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,country_id)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_country_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 33, 11, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_cities order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_cities where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 33, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_cities_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_user_id character varying, in_country_id character varying) OWNER TO postgres;

--
-- TOC entry 363 (class 1255 OID 62374)
-- Name: fnc_cities_update(character varying, character varying, character varying, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_cities_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_country_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_cities
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_citiesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_cities t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO grl.tbl_citiesedit(
	id,city_id, sequ,aname, ename, company_id,country_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit)
	SELECT on_edit_id,id, sequ, aname, ename, company_id,in_country_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit
	FROM grl.tbl_cities WHERE grl.tbl_cities.id = in_id;
UPDATE grl.tbl_cities
	SET aname=in_aname, ename=in_ename,country_id=in_country_id, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE grl.tbl_cities.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 34, 11, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_cities order by grl.tbl_cities.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_cities where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 34, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_cities_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_country_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 225 (class 1259 OID 62375)
-- Name: tbl_companies; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_companies (
    id character varying(2) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE grl.tbl_companies OWNER TO postgres;

--
-- TOC entry 288 (class 1255 OID 62383)
-- Name: fnc_companies_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_companies_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_companies
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_companiesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_companies t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO grl.tbl_companiesedit(
	id, companies_id, sequ, aname, ename, notes, stop, activetime, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id, id, sequ, aname, ename, notes, stop, activetime, creationtime, on_servertime, createuser_id, in_user_id, edit, 1
	FROM grl.tbl_companies WHERE grl.tbl_companies.id = in_id;
Delete From grl.tbl_companies
	WHERE grl.tbl_companies.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 5, 1, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_companies order by grl.tbl_companies.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_companies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 5, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_companies_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 295 (class 1255 OID 62384)
-- Name: fnc_companies_insert(character varying, text, text, text, boolean, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_companies_insert(in_id character varying, in_aname text, in_ename text, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_companies
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_companies) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 2)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO grl.tbl_companies(
	id, sequ,aname, ename, notes, stop,activetime, creationtime, createuser_id)
	VALUES (in_id, on_xseq, in_aname, in_ename, in_notes, in_stop,in_activetime, on_servertime, in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 3, 1, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_companies order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_companies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 3, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_companies_insert(in_id character varying, in_aname text, in_ename text, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 323 (class 1255 OID 62385)
-- Name: fnc_companies_update(character varying, text, text, text, boolean, timestamp without time zone, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_companies_update(in_id character varying, in_aname text, in_ename text, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_companies
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_companiesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_companies t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Update companies
INSERT INTO grl.tbl_companiesedit(
	id, companies_id, sequ, aname, ename, notes, stop,activetime, creationtime, editingtime, createuser_id, edituser_id, edit)
	SELECT on_edit_id, id, sequ, aname, ename, notes, stop,	activetime, creationtime, on_servertime, createuser_id, in_user_id, on_current_edit
	FROM grl.tbl_companies WHERE grl.tbl_companies.id = in_id;
UPDATE grl.tbl_companies
	SET aname=in_aname, ename=in_ename, notes=in_notes, stop=in_stop, activetime=in_activetime, editingtime=on_servertime, edituser_id=in_user_id, edit= on_current_edit
	WHERE grl.tbl_companies.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 4, 1, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_companies order by grl.tbl_companies.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_companies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 4, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_companies_update(in_id character varying, in_aname text, in_ename text, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 319 (class 1255 OID 62386)
-- Name: fnc_companies_update(character varying, character varying, character varying, character varying, character varying, numeric, text, boolean, timestamp without time zone, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_companies_update(in_id character varying, in_aname character varying, in_ename character varying, in_asymbol character varying, in_esymbol character varying, in_price numeric, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_branch_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_currencies
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_currenciesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_currencies t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_currenciesedit & Update companies
INSERT INTO grl.tbl_currenciesedit(
	id, 
	currencies_id, 
	sequ, 
	aname, 
	ename, 
	asymbol, 
	esymbol, 
	price, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	editingtime, 
	createuser_id, 
	edituser_id, 
	edit, 
	delete)
	SELECT 
	 on_edit_id, 
	 id, 
	 sequ, 
	 aname, 
	 ename, 
	 asymbol, 
   	 esymbol, 
	 price, 
	 stop, 
	 activetime, 
	 notes, 
	 company_id, 
	 branch_id, 
	 creationtime, 
	 editingtime, 
	 createuser_id, 
	 edituser_id, 
	 edit,
	 1
	 FROM grl.tbl_currencies WHERE grl.tbl_currencies.id = in_id;

UPDATE grl.tbl_currencies
	SET  
	aname=in_aname, 
	ename=in_ename, 
	asymbol=in_asymbol, 
	esymbol=in_esymbol, 
	price=in_price,
	stop=in_stop, 
	activetime=in_activetime, 
	notes=in_notes?, 
	company_id=in_company_id?, 
	branch_id=in_branch_id?, 
	editingtime=on_servertime, 
	edituser_id=in_user_id,  
	edit=on_current_edit
	WHERE grl.tbl_currencies.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 19, 6, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_currencies order by grl.tbl_currencies.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_currencies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 19, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_companies_update(in_id character varying, in_aname character varying, in_ename character varying, in_asymbol character varying, in_esymbol character varying, in_price numeric, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_branch_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 361 (class 1255 OID 62387)
-- Name: fnc_currencies_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_currencies_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_currencies
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_currenciesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_currencies t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_currencies & Delete currencies
INSERT INTO grl.tbl_currenciesedit(
	id, 
	currencies_id, 
	sequ, 
	aname, 
	ename, 
	asymbol, 
	esymbol, 
	price, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	editingtime, 
	createuser_id, 
	edituser_id, 
	edit, 
	delete)
	SELECT 
	 on_edit_id, 
	 id, 
	 sequ, 
	 aname, 
	 ename, 
	 asymbol, 
   	 esymbol, 
	 price, 
	 stop, 
	 activetime, 
	 notes, 
	 company_id, 
	 branch_id, 
	 creationtime, 
	 editingtime, 
	 createuser_id, 
	 edituser_id, 
	 edit,
	 1
	 FROM grl.tbl_currencies WHERE grl.tbl_currencies.id = in_id;

Delete From grl.tbl_currencies
	WHERE grl.tbl_currencies.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 20, 6, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_currencies order by grl.tbl_currencies.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_currencies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 20, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_currencies_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 322 (class 1255 OID 62388)
-- Name: fnc_currencies_insert(character varying, character varying, character varying, character varying, character varying, numeric, text, boolean, timestamp without time zone, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_currencies_insert(in_id character varying, in_aname character varying, in_ename character varying, in_asymbol character varying, in_esymbol character varying, in_price numeric, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_branch_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_currencies
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_currencies) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 2)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO currencies 
INSERT INTO grl.tbl_currencies(
	id, 
	sequ, 
	aname, 
	ename, 
	asymbol, 
	esymbol, 
	price, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	createuser_id)
	VALUES (
	in_id, 
	on_xseq, 
	in_aname, 
	in_ename, 
	in_asymbol, 
	in_esymbol, 
	in_price, 
	in_stop, 
	in_activetime, 
	in_notes, 
	in_company_id, 
	in_branch_id, 
	on_servertime, 
	in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 18, 6, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_currencies t order by t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_currencies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 18, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_currencies_insert(in_id character varying, in_aname character varying, in_ename character varying, in_asymbol character varying, in_esymbol character varying, in_price numeric, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_branch_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 334 (class 1255 OID 62389)
-- Name: fnc_currencies_update(character varying, character varying, character varying, character varying, character varying, numeric, text, boolean, timestamp without time zone, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_currencies_update(in_id character varying, in_aname character varying, in_ename character varying, in_asymbol character varying, in_esymbol character varying, in_price numeric, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_branch_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_currencies
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_currenciesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_currencies t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_currenciesedit & Update currencies
INSERT INTO grl.tbl_currenciesedit(
	id, 
	currencies_id, 
	sequ, 
	aname, 
	ename, 
	asymbol, 
	esymbol, 
	price, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	editingtime, 
	createuser_id, 
	edituser_id, 
	edit, 
	delete)
	SELECT 
	 on_edit_id, 
	 id, 
	 sequ, 
	 aname, 
	 ename, 
	 asymbol, 
   	 esymbol, 
	 price, 
	 stop, 
	 activetime, 
	 notes, 
	 company_id, 
	 branch_id, 
	 creationtime, 
	 editingtime, 
	 createuser_id, 
	 edituser_id, 
	 edit,
	 1
	 FROM grl.tbl_currencies WHERE grl.tbl_currencies.id = in_id;

UPDATE grl.tbl_currencies
	SET  
	aname=in_aname, 
	ename=in_ename, 
	asymbol=in_asymbol, 
	esymbol=in_esymbol, 
	price=in_price,
	stop=in_stop, 
	activetime=in_activetime, 
	notes=in_notes, 
	company_id=in_company_id, 
	branch_id=in_branch_id, 
	editingtime=on_servertime, 
	edituser_id=in_user_id,  
	edit=on_current_edit
	WHERE grl.tbl_currencies.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 19, 6, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_currencies  order by grl.tbl_currencies.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_currencies where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 19, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_currencies_update(in_id character varying, in_aname character varying, in_ename character varying, in_asymbol character varying, in_esymbol character varying, in_price numeric, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying, in_branch_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 226 (class 1259 OID 62390)
-- Name: tbl_fyears; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_fyears (
    id character varying(2) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    beigndate date,
    enddate date,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE grl.tbl_fyears OWNER TO postgres;

--
-- TOC entry 344 (class 1255 OID 62398)
-- Name: fnc_fyears_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_fyears_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_fyears
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_fyearsedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_fyears t WHERE t.id = in_id AND t.company_id = in_company_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editbranches & Delete branches
INSERT INTO grl.tbl_fyearsedit(
	id, fyears_id, sequ, aname, ename, beigndate, enddate, stop, activetime, notes, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
SELECT on_edit_id, id, sequ, aname, ename, beigndate, enddate, stop, activetime, notes, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, 1
	FROM grl.tbl_fyears t
	WHERE t.id = in_id 
	AND t.company_id = in_company_id;
	
Delete From grl.tbl_fyears t WHERE t.id = in_id 
							   AND t.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 14, 4, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_fyears WHERE company_id = in_company_id ORDER BY grl.tbl_fyears.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_fyears where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 14, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_fyears_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 330 (class 1255 OID 62399)
-- Name: fnc_fyears_insert(character varying, character varying, character varying, date, date, character varying, text, boolean, timestamp without time zone, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_fyears_insert(in_id character varying, in_aname character varying, in_ename character varying, in_beigndate date, in_enddate date, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) RETURNS SETOF grl.tbl_fyears
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_fyears WHERE company_id = in_company_id) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 2)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO fyears
INSERT INTO grl.tbl_fyears(
	id, sequ, aname, ename, beigndate, enddate, stop, activetime, notes, company_id, creationtime, createuser_id)
	VALUES (in_id, on_xseq, in_aname, in_ename, in_beigndate, in_enddate, in_stop, in_activetime, in_notes, in_company_id, on_servertime, in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 12, 4, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_fyears WHERE company_id = in_company_id ORDER BY grl.tbl_fyears.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_fyears where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 12, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_fyears_insert(in_id character varying, in_aname character varying, in_ename character varying, in_beigndate date, in_enddate date, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 313 (class 1255 OID 62400)
-- Name: fnc_fyears_update(character varying, character varying, character varying, date, date, character varying, text, boolean, timestamp without time zone, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_fyears_update(in_id character varying, in_aname character varying, in_ename character varying, in_beigndate date, in_enddate date, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) RETURNS SETOF grl.tbl_fyears
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_fyearsedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_fyears t WHERE t.id = in_id AND t.company_id = in_company_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_branchesedit & Update branches
INSERT INTO grl.tbl_fyearsedit(
	id, fyears_id, sequ, aname, ename, beigndate, enddate, stop, activetime, notes, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
SELECT on_edit_id, id, sequ, aname, ename, beigndate, enddate, stop, activetime, notes, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, 1
	FROM grl.tbl_fyears t
	WHERE t.id = in_id 
	AND t.company_id = in_company_id;
	
UPDATE grl.tbl_fyears t
	SET aname=in_aname, ename=in_ename, beigndate=in_beigndate, enddate=in_enddate, stop=in_stop, activetime=in_activetime, notes=in_notes, company_id=in_company_id, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE t.id = in_id AND t.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 13, 4, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_fyears WHERE company_id = in_company_id ORDER BY grl.tbl_fyears.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_fyears where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 13, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_fyears_update(in_id character varying, in_aname character varying, in_ename character varying, in_beigndate date, in_enddate date, in_company_id character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 227 (class 1259 OID 62401)
-- Name: tbl_nationality; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_nationality (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2)
);


ALTER TABLE grl.tbl_nationality OWNER TO postgres;

--
-- TOC entry 362 (class 1255 OID 62408)
-- Name: fnc_nationality_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_nationality_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_nationality
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from grl.tbl_nationalityedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_nationality t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO grl.tbl_nationalityedit(
	id,nat_id, sequ, aname, ename, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1
	FROM grl.tbl_nationality WHERE grl.tbl_nationality.id = in_id;
Delete From grl.tbl_nationality
	WHERE grl.tbl_nationality.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 29, 9, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_nationality order by grl.tbl_nationality.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_nationality where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 29, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_nationality_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 305 (class 1255 OID 62409)
-- Name: fnc_nationality_insert(character varying, text, text, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_nationality_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_user_id character varying) RETURNS SETOF grl.tbl_nationality
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_nationality) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO grl.tbl_nationality(
	id, sequ,aname, ename,company_id, creationtime, createuser_id)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 27, 9, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_nationality order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_nationality where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 27, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_nationality_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 327 (class 1255 OID 62410)
-- Name: fnc_nationality_update(character varying, character varying, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_nationality_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_nationality
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_nationalityedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from grl.tbl_nationality t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO grl.tbl_nationalityedit(
	id,nat_id, sequ,aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit
	FROM grl.tbl_nationality WHERE grl.tbl_nationality.id = in_id;
UPDATE grl.tbl_nationality
	SET aname=in_aname, ename=in_ename, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE grl.tbl_nationality.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 28, 9, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from grl.tbl_nationality order by grl.tbl_nationality.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_nationality where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 28, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_nationality_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 228 (class 1259 OID 62411)
-- Name: tbl_rep; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_rep (
    id integer NOT NULL,
    name text NOT NULL,
    content text,
    rowcount smallint,
    rowindex boolean,
    fontsize smallint,
    view text,
    user_id character varying(4),
    company_id character varying(2) NOT NULL,
    notes text
);


ALTER TABLE grl.tbl_rep OWNER TO postgres;

--
-- TOC entry 229 (class 1259 OID 62417)
-- Name: tbl_repd; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_repd (
    id integer NOT NULL,
    rep_id integer NOT NULL,
    field text NOT NULL,
    no boolean,
    operator text,
    condition text,
    logic text,
    ggroup boolean,
    oorder text,
    company_id character varying(2) NOT NULL,
    view text NOT NULL,
    user_id character varying(4) NOT NULL
);


ALTER TABLE grl.tbl_repd OWNER TO postgres;

--
-- TOC entry 230 (class 1259 OID 62423)
-- Name: viw_rep_select; Type: VIEW; Schema: grl; Owner: postgres
--

CREATE VIEW grl.viw_rep_select AS
 SELECT h.id AS h_id,
    h.name AS h_name,
    h.content AS h_content,
    h.rowcount AS h_rowcount,
    h.rowindex AS h_rowindex,
    h.fontsize AS h_fontsize,
    h.notes AS h_notes,
    h.view AS h_view,
    h.user_id AS h_user_id,
    h.company_id AS h_company_id,
    d.rep_id AS d_rep_id,
    d.field AS d_field,
    d.no AS d_no,
    d.operator AS d_operator,
    d.condition AS d_condition,
    d.logic AS d_logic,
    d.ggroup AS d_group,
    d.oorder AS d_order
   FROM (grl.tbl_rep h
     JOIN grl.tbl_repd d ON ((((h.id)::text = (d.rep_id)::text) AND ((h.company_id)::text = (d.company_id)::text))))
  ORDER BY d.ctid;


ALTER TABLE grl.viw_rep_select OWNER TO postgres;

--
-- TOC entry 329 (class 1255 OID 62428)
-- Name: fnc_rep_insert(integer, text, text, smallint, boolean, smallint, text, text, character varying, json); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_rep_insert(in_id integer, in_name text, in_content text, in_rowcount smallint, in_rowindex boolean, in_fontsize smallint, in_view text, in_user_id text, in_company_id character varying, in_repd json) RETURNS SETOF grl.viw_rep_select
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp; 
	on_audit_id bigint;
--------------------------------------
	i jsonb;
	on_repD_id int;  
	on_repD_field text; 
	on_repD_no boolean;
	on_repD_operator text;
	on_repD_condition text; 
	on_repD_logic text;
	on_repD_ggroup boolean; 
	on_repD_oorder text;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	in_id = (select(select max(id) from grl.tbl_rep) + 1); if in_id is null then in_id = 1; end if;
	on_repD_id = (select(select max(id) from grl.tbl_repd) + 1); if on_repD_id is null then on_repD_id = 1; end if;
------------------------------------------------------------------------------------------------------INSERT INTO rep
INSERT INTO grl.tbl_rep(
	id, name, content, rowcount, rowindex, fontsize, view, user_id, company_id)
	VALUES (in_id, in_name, in_content, in_rowcount, in_rowindex, in_fontsize, in_view, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------INSERT INTO repD
FOR i IN SELECT * FROM json_array_elements(in_repd)
  LOOP
	on_repD_field := i->>'col_field'; 
	on_repD_no := i->>'col_not'; 
	on_repD_operator := i->>'col_operator'; 
	on_repD_condition := i->>'col_condition'; 
	on_repD_logic := i->>'col_AndOr'; 
	on_repD_ggroup := i->>'col_group'; 
	on_repD_oorder := i->>'col_order'; 
	
	IF on_repD_logic IS null OR on_repD_logic = '' THEN on_repD_logic = ''; END IF;

	INSERT INTO grl.tbl_repd(
	id, rep_id, field, no, operator, condition, logic, ggroup, oorder, view, user_id, company_id)
	VALUES (on_repD_id, in_id, on_repD_field, on_repD_no, on_repD_operator, on_repD_condition,
			on_repD_logic, on_repD_ggroup, on_repD_oorder, in_view, in_user_id, in_company_id);

	on_repD_id = on_repD_id + 1;
 END LOOP;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 57, 18, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.viw_rep_select WHERE h_view = in_view AND h_user_id = in_user_id AND h_company_id = in_company_id;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.viw_rep_select where h_id = '0';
	INSERT INTO temp_EX(h_notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 57, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_rep_insert(in_id integer, in_name text, in_content text, in_rowcount smallint, in_rowindex boolean, in_fontsize smallint, in_view text, in_user_id text, in_company_id character varying, in_repd json) OWNER TO postgres;

--
-- TOC entry 231 (class 1259 OID 62429)
-- Name: tbl_stores; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_stores (
    id character varying(3) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    responame text,
    mobile1 text,
    mobile2 text,
    phone1 text,
    phone2 text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2) NOT NULL,
    branch_id character varying(3) NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE grl.tbl_stores OWNER TO postgres;

--
-- TOC entry 292 (class 1255 OID 62437)
-- Name: fnc_stores_delete(character varying, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_stores_delete(in_id character varying, in_user_id character varying, in_branch_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_stores
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_storesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_stores t WHERE t.id = in_id AND t.company_id = in_company_id AND t.branch_id = in_branch_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_storesedit & Delete tbl_stores
INSERT INTO grl.tbl_storesedit(
	id, 
	stores_id, 
	sequ, 
	aname, 
	ename, 
	responame, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	editingtime, 
	createuser_id,
	edituser_id, 
	edit, 
	delete)
SELECT 
	on_edit_id,
	id, 
	sequ, 
	aname, 
	ename, 
	responame, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	stop, 
	activetime, 
	notes,
	company_id, 
	branch_id, 
	creationtime, 
	on_servertime, 
	createuser_id, 
	in_user_id, 
	edit,
	1
	FROM grl.tbl_stores t
	WHERE t.id = in_id 
	AND t.branch_id = in_branch_id
	AND t.company_id = in_company_id;
	
	
Delete From grl.tbl_stores t WHERE t.id = in_id 
							   AND t.branch_id = in_branch_id
							   AND t.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 11, 3, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_stores t WHERE t.branch_id = in_branch_id AND t.company_id = in_company_id ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_stores where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 11, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_stores_delete(in_id character varying, in_user_id character varying, in_branch_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 298 (class 1255 OID 62438)
-- Name: fnc_stores_insert(character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, text, boolean, timestamp without time zone, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_stores_insert(in_id character varying, in_aname character varying, in_ename character varying, in_responame character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_branch_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF grl.tbl_stores
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_stores t WHERE t.branch_id = in_branch_id AND t.company_id = in_company_id) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 3)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_stores
INSERT INTO grl.tbl_stores(
	id,  
	sequ, 
	aname, 
	ename, 
	responame, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	createuser_id)
VALUES ( 
	in_id, 
	on_xseq, 
	in_aname, 
	in_ename, 
	in_responame, 
	in_mobile1, 
	in_mobile2, 
	in_phone1, 
	in_phone2, 
	in_stop, 
	in_activetime, 
	in_notes,
	in_company_id, 
	in_branch_id, 
	on_servertime,  
	in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 9, 3, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_stores t WHERE t.branch_id = in_branch_id AND t.company_id = in_company_id ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_stores where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 9, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_stores_insert(in_id character varying, in_aname character varying, in_ename character varying, in_responame character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_branch_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 320 (class 1255 OID 62439)
-- Name: fnc_stores_update(character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, text, boolean, timestamp without time zone, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_stores_update(in_id character varying, in_aname character varying, in_ename character varying, in_responame character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_branch_id character varying, in_company_id character varying, in_user_id character varying) RETURNS SETOF grl.tbl_stores
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_storesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_stores  WHERE id = in_id AND company_id = in_company_id AND branch_id = in_branch_id) + 1);
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_storesedit & Update tbl_stores
INSERT INTO grl.tbl_storesedit(
	id, 
	stores_id, 
	sequ, 
	aname, 
	ename, 
	responame, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	stop, 
	activetime, 
	notes, 
	company_id, 
	branch_id, 
	creationtime, 
	editingtime, 
	createuser_id,
	edituser_id, 
	edit, 
	delete)
SELECT 
	on_edit_id,
	id, 
	sequ, 
	aname, 
	ename, 
	responame, 
	mobile1, 
	mobile2, 
	phone1, 
	phone2, 
	stop, 
	activetime, 
	notes,
	company_id, 
	branch_id, 
	creationtime, 
	on_servertime, 
	createuser_id, 
	in_user_id, 
	edit,
	1
	FROM grl.tbl_stores t
	WHERE t.id = in_id 
	AND t.branch_id = in_branch_id
	AND t.company_id = in_company_id;
	
UPDATE grl.tbl_stores t
	SET aname=in_aname, ename=in_ename, responame=in_responame, mobile1=in_mobile1, mobile2=in_mobile2, phone1=in_phone1, phone2=in_phone2,
	stop=in_stop, activetime=in_activetime, notes=in_notes, company_id=in_company_id, branch_id=in_branch_id,
	editingtime=on_servertime, edituser_id=in_user_id, edit=on_edit_id
	 WHERE t.id = in_id 
	 AND t.branch_id = in_branch_id
	 AND t.company_id = in_company_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 10, 3, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_stores t WHERE t.branch_id = in_branch_id AND t.company_id = in_company_id ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_stores where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 10, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_stores_update(in_id character varying, in_aname character varying, in_ename character varying, in_responame character varying, in_mobile1 character varying, in_mobile2 character varying, in_phone1 character varying, in_phone2 character varying, in_notes text, in_stop boolean, in_activetime timestamp without time zone, in_branch_id character varying, in_company_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 232 (class 1259 OID 62440)
-- Name: tbl_users; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_users (
    id character varying(4) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    password text,
    gender_id smallint,
    jobtitle text,
    mobile1 text,
    mobile2 text,
    phone1 text,
    phone2 text,
    email text,
    permission_id character varying(3),
    blockedcompanies_ids text,
    blockedbranches_ids text,
    blockedstores_ids text,
    blockedfyears_ids text,
    defaultcompany_id character varying(2),
    defaultbranch_id character varying(3),
    defaultstore_id character varying(3),
    defaultfyear_id character varying(2),
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL
);


ALTER TABLE grl.tbl_users OWNER TO postgres;

--
-- TOC entry 350 (class 1255 OID 62448)
-- Name: fnc_users_delete(character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_users_delete(in_id character varying, in_user_id character varying) RETURNS SETOF grl.tbl_users
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_usersedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_users WHERE id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_usersedit & delete tbl_users
INSERT INTO grl.tbl_usersedit(
	id, users_id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id, in_id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, on_servertime, createuser_id, in_user_id, on_current_edit, 1
	FROM grl.tbl_users WHERE grl.tbl_users.id = in_id;
	
Delete From grl.tbl_users WHERE grl.tbl_users.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 17, 5, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_users ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_users where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 17, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_users_delete(in_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 308 (class 1255 OID 62449)
-- Name: fnc_users_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_users_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF grl.tbl_users
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_usersedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_users WHERE id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_usersedit & delete tbl_users
INSERT INTO grl.tbl_usersedit(
	id, users_id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete)
	SELECT on_edit_id, in_id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, on_servertime, createuser_id, in_user_id, on_current_edit, 1
	FROM grl.tbl_users WHERE grl.tbl_users.id = in_id;
	
Delete From grl.tbl_users WHERE grl.tbl_users.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 17, 5, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_users t ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_users where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 17, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_users_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 294 (class 1255 OID 62450)
-- Name: fnc_users_insert(character varying, text, text, text, smallint, text, text, text, text, text, text, character varying, text, text, text, text, character varying, character varying, character varying, character varying, boolean, timestamp without time zone, text, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_users_insert(in_id character varying, in_aname text, in_ename text, in_password text, in_gender_id smallint, in_jobtitle text, in_mobile1 text, in_mobile2 text, in_phone1 text, in_phone2 text, in_email text, in_permission_id character varying, in_blockedcompanies_ids text, in_blockedbranches_ids text, in_blockedstores_ids text, in_blockedfyears_ids text, in_defaultcompany_id character varying, in_defaultbranch_id character varying, in_defaultstore_id character varying, in_defaultfyear_id character varying, in_stop boolean, in_activetime timestamp without time zone, in_notes text, in_company_id character varying, in_branch_id character varying, in_user_id character varying) RETURNS SETOF grl.tbl_users
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from grl.tbl_users) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_users
INSERT INTO grl.tbl_users(
	id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, createuser_id)
	VALUES (in_id, on_xseq, in_aname, in_ename, in_password, in_gender_id, in_jobtitle, in_mobile1, in_mobile2, in_phone1, in_phone2, in_email, 
			in_permission_id, in_blockedcompanies_ids, in_blockedbranches_ids, in_blockedstores_ids, in_blockedfyears_ids, 
			in_defaultcompany_id, in_defaultbranch_id, in_defaultstore_id, in_defaultfyear_id, in_stop, in_activetime, 
			in_notes, in_company_id, in_branch_id, on_servertime, in_user_id);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 15, 5, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_users t ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_users where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 15, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_users_insert(in_id character varying, in_aname text, in_ename text, in_password text, in_gender_id smallint, in_jobtitle text, in_mobile1 text, in_mobile2 text, in_phone1 text, in_phone2 text, in_email text, in_permission_id character varying, in_blockedcompanies_ids text, in_blockedbranches_ids text, in_blockedstores_ids text, in_blockedfyears_ids text, in_defaultcompany_id character varying, in_defaultbranch_id character varying, in_defaultstore_id character varying, in_defaultfyear_id character varying, in_stop boolean, in_activetime timestamp without time zone, in_notes text, in_company_id character varying, in_branch_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 347 (class 1255 OID 62452)
-- Name: fnc_users_update(character varying, text, text, text, smallint, text, text, text, text, text, text, character varying, text, text, text, text, character varying, character varying, character varying, character varying, boolean, timestamp without time zone, text, character varying, character varying, character varying); Type: FUNCTION; Schema: grl; Owner: postgres
--

CREATE FUNCTION grl.fnc_users_update(in_id character varying, in_aname text, in_ename text, in_password text, in_gender_id smallint, in_jobtitle text, in_mobile1 text, in_mobile2 text, in_phone1 text, in_phone2 text, in_email text, in_permission_id character varying, in_blockedcompanies_ids text, in_blockedbranches_ids text, in_blockedstores_ids text, in_blockedfyears_ids text, in_defaultcompany_id character varying, in_defaultbranch_id character varying, in_defaultstore_id character varying, in_defaultfyear_id character varying, in_stop boolean, in_activetime timestamp without time zone, in_notes text, in_company_id character varying, in_branch_id character varying, in_user_id character varying) RETURNS SETOF grl.tbl_users
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
--------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from grl.tbl_usersedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;	
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from grl.tbl_users WHERE id = in_id) + 1);
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_usersedit & Update tbl_users
INSERT INTO grl.tbl_usersedit(
	id, users_id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, editingtime, createuser_id, edituser_id, edit)
	SELECT on_edit_id, in_id, sequ, aname, ename, password, gender_id, jobtitle, mobile1, mobile2, phone1, phone2, email, 
	permission_id, blockedcompanies_ids, blockedbranches_ids, blockedstores_ids, blockedfyears_ids, 
	defaultcompany_id, defaultbranch_id, defaultstore_id, defaultfyear_id, stop, activetime, 
	notes, company_id, branch_id, creationtime, on_servertime, createuser_id, in_user_id, on_current_edit
	FROM grl.tbl_users WHERE grl.tbl_users.id = in_id;
	
UPDATE grl.tbl_users
	SET aname=in_aname, ename=in_ename, password=in_password, gender_id=in_gender_id, jobtitle=in_jobtitle, 
	mobile1=in_mobile1, mobile2=in_mobile2, phone1=in_phone1, phone2=in_phone2, email=in_email, permission_id=in_permission_id, 
	blockedcompanies_ids=in_blockedcompanies_ids, blockedbranches_ids=in_blockedbranches_ids, blockedstores_ids=in_blockedstores_ids, blockedfyears_ids=in_blockedfyears_ids, 
	defaultcompany_id=in_defaultcompany_id, defaultbranch_id=in_defaultbranch_id, defaultstore_id=in_defaultstore_id, defaultfyear_id=in_defaultfyear_id, 
	stop=in_stop, activetime=in_activetime, notes=in_notes, company_id=in_company_id, branch_id=in_branch_id, 
	editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit
	WHERE grl.tbl_users.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 16, 5, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY SELECT * FROM grl.tbl_users t ORDER BY t.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from grl.tbl_users where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, in_branch_id, null, in_user_id, 16, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION grl.fnc_users_update(in_id character varying, in_aname text, in_ename text, in_password text, in_gender_id smallint, in_jobtitle text, in_mobile1 text, in_mobile2 text, in_phone1 text, in_phone2 text, in_email text, in_permission_id character varying, in_blockedcompanies_ids text, in_blockedbranches_ids text, in_blockedstores_ids text, in_blockedfyears_ids text, in_defaultcompany_id character varying, in_defaultbranch_id character varying, in_defaultstore_id character varying, in_defaultfyear_id character varying, in_stop boolean, in_activetime timestamp without time zone, in_notes text, in_company_id character varying, in_branch_id character varying, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 233 (class 1259 OID 62454)
-- Name: tbl_class; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_class (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_class OWNER TO postgres;

--
-- TOC entry 368 (class 1255 OID 62462)
-- Name: fnc_class_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_class_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF scl.tbl_class
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from scl.tbl_classedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from scl.tbl_class t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO scl.tbl_classedit(
	id,class_id, sequ, aname, ename, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete, stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1, stop
	FROM scl.tbl_class WHERE scl.tbl_class.id = in_id;
Delete From scl.tbl_class
	WHERE scl.tbl_class.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 47, 15, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_class order by scl.tbl_class.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_class where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 47, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_class_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 338 (class 1255 OID 62463)
-- Name: fnc_class_insert(character varying, text, text, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_class_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) RETURNS SETOF scl.tbl_class
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from scl.tbl_class) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO scl.tbl_class(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,stop)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_stop);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 45, 15, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_class order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_class where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 45, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_class_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 339 (class 1255 OID 62464)
-- Name: fnc_class_update(character varying, character varying, character varying, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_class_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) RETURNS SETOF scl.tbl_class
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from scl.tbl_classedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from scl.tbl_class t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO scl.tbl_classedit(
	id,class_id, sequ,aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit,stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit,stop
	FROM scl.tbl_class WHERE scl.tbl_class.id = in_id;
UPDATE scl.tbl_class
	SET aname=in_aname, ename=in_ename, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit, stop=in_stop
	WHERE scl.tbl_class.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 46, 15, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_class order by scl.tbl_class.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_class where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 46, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_class_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 234 (class 1259 OID 62465)
-- Name: tbl_parents; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_parents (
    id character varying(50) NOT NULL,
    sequ smallint,
    f_parent_id character varying(20),
    f_enddate_id timestamp without time zone,
    f_aname character varying(50),
    f_ename character varying(50),
    ff_aname character varying(20),
    ff_ename character varying(20),
    f_mobile1 character varying(20),
    fh_phone character varying(20),
    fw_phone character varying(20),
    f_email character varying(50),
    fcountry_id character varying(4),
    freligion_id smallint,
    facc_code character varying(50),
    fh_adress character varying(50),
    fw_adress character varying(50),
    m_parent_id character varying(20),
    m_enddate_id timestamp without time zone,
    m_aname character varying(50),
    m_ename character varying(50),
    mf_aname character varying(20),
    mf_ename character varying(20),
    m_mobile1 character varying(20),
    mh_phone character varying(20),
    mw_phone character varying(20),
    m_email character varying(50),
    mcountry_id character varying(4),
    mreligion_id smallint,
    macc_code character varying(50),
    mh_adress character varying(50),
    mw_adress character varying(50),
    company_id character varying(2),
    branch_id character varying(3),
    notes text,
    stop boolean DEFAULT false NOT NULL,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint
);


ALTER TABLE scl.tbl_parents OWNER TO postgres;

--
-- TOC entry 291 (class 1255 OID 62472)
-- Name: fnc_parents_insert(character varying, character varying, timestamp without time zone, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, smallint, character varying, character varying, character varying, character varying, timestamp without time zone, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, character varying, smallint, character varying, character varying, character varying, character varying, character varying, boolean, text, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_parents_insert(in_id character varying, in_f_parent_id character varying, in_f_enddate_id timestamp without time zone, in_f_aname character varying, in_f_ename character varying, in_ff_aname character varying, in_ff_ename character varying, in_f_mobile1 character varying, in_f_hphone character varying, in_f_wphone character varying, in_f_mail character varying, in_f_country character varying, in_f_religion smallint, in_f_acc character varying, in_f_haddress character varying, in_f_waddress character varying, in_m_parent_id character varying, in_m_enddate_id timestamp without time zone, in_m_aname character varying, in_m_ename character varying, in_mf_aname character varying, in_mf_ename character varying, in_m_mobile1 character varying, in_m_hphone character varying, in_m_wphone character varying, in_m_mail character varying, in_m_country character varying, in_m_religion smallint, in_m_acc character varying, in_m_hadress character varying, in_m_wadress character varying, in_branch_id character varying, in_company_id character varying, in_stop boolean, in_notes text, in_user_id character varying) RETURNS SETOF scl.tbl_parents
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq character varying;
	on_sequ smallint;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_sequ = (select(select max(sequ) from scl.tbl_parents where
					  company_id = in_company_id and branch_id = in_branch_id ) + 1);
	on_sequ = (select case when (on_sequ is NULL) then 1 else on_sequ end);
	on_xseq = on_sequ::text;
	while (length(on_xseq) < 7)
			loop
				on_xseq = (select concat('0',on_xseq));
			end loop;
	in_id = (in_branch_id || on_xseq);
	in_f_aname = (select case when (in_f_aname IS NULL OR in_f_aname = '') THEN in_f_ename else in_f_aname end);
	in_f_ename = (select case when (in_f_ename IS NULL OR in_f_ename = '') THEN in_f_aname else in_f_ename end);
	in_ff_aname = (select case when (in_ff_aname IS NULL OR in_ff_aname = '') THEN in_ff_ename else in_ff_aname end);
	in_ff_ename = (select case when (in_ff_ename IS NULL OR in_ff_ename = '') THEN in_ff_aname else in_ff_ename end);	
---------------------------------------------------------------------------INSERT INTO parents 
INSERT INTO scl.tbl_parents(
			   id,   sequ,    f_parent_id,    f_enddate_id,    f_aname,    f_ename,    ff_aname,    ff_ename,    f_mobile1,    fh_phone,    fw_phone,    f_email,    fcountry_id,    freligion_id,    facc_code,    fh_adress,    fw_adress,    m_parent_id,    m_enddate_id,    m_aname,    m_ename, mf_aname,       mf_ename,    m_mobile1,      mh_phone,    mw_phone,    m_email,    mcountry_id,    mreligion_id,    macc_code,    mh_adress,    mw_adress,    company_id,    branch_id,    notes,    stop,  creationtime, createuser_id)
	VALUES (in_id, on_sequ, in_f_parent_id, in_f_enddate_id, in_f_aname, in_f_ename, in_ff_aname, in_ff_ename, in_f_mobile1, in_f_hphone, in_f_wphone,  in_f_mail,    in_f_country,  in_f_religion,     in_f_acc, in_f_haddress, in_f_waddress, in_m_parent_id, in_m_enddate_id, in_m_aname, in_m_ename, in_mf_aname, in_mf_ename, in_m_mobile1, in_m_hphone, in_m_wphone,  in_m_mail,   in_m_country,   in_m_religion,     in_m_acc, in_m_hadress, in_m_wadress, in_company_id, in_branch_id, in_notes, in_stop, on_servertime,    in_user_id);
-----------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 54, 18, in_id, in_user_id, in_company_id);
----------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_parents order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_parents where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 54, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_parents_insert(in_id character varying, in_f_parent_id character varying, in_f_enddate_id timestamp without time zone, in_f_aname character varying, in_f_ename character varying, in_ff_aname character varying, in_ff_ename character varying, in_f_mobile1 character varying, in_f_hphone character varying, in_f_wphone character varying, in_f_mail character varying, in_f_country character varying, in_f_religion smallint, in_f_acc character varying, in_f_haddress character varying, in_f_waddress character varying, in_m_parent_id character varying, in_m_enddate_id timestamp without time zone, in_m_aname character varying, in_m_ename character varying, in_mf_aname character varying, in_mf_ename character varying, in_m_mobile1 character varying, in_m_hphone character varying, in_m_wphone character varying, in_m_mail character varying, in_m_country character varying, in_m_religion smallint, in_m_acc character varying, in_m_hadress character varying, in_m_wadress character varying, in_branch_id character varying, in_company_id character varying, in_stop boolean, in_notes text, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 235 (class 1259 OID 62474)
-- Name: tbl_rows; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_rows (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_rows OWNER TO postgres;

--
-- TOC entry 342 (class 1255 OID 62482)
-- Name: fnc_rows_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_rows_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF scl.tbl_rows
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from scl.tbl_rowsedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from scl.tbl_rows t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO scl.tbl_rowsedit(
	id,row_id, sequ, aname, ename, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete, stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1, stop
	FROM scl.tbl_rows WHERE scl.tbl_rows.id = in_id;
Delete From scl.tbl_rows
	WHERE scl.tbl_rows.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 44, 13, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_rows order by scl.tbl_rows.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_rows where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 44, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_rows_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 293 (class 1255 OID 62483)
-- Name: fnc_rows_insert(character varying, text, text, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_rows_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) RETURNS SETOF scl.tbl_rows
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from scl.tbl_rows) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO scl.tbl_rows(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,stop)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_stop);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 42, 14, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_rows order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_rows where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 42, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_rows_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 340 (class 1255 OID 62484)
-- Name: fnc_rows_update(character varying, character varying, character varying, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_rows_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) RETURNS SETOF scl.tbl_rows
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from scl.tbl_rowsedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from scl.tbl_rows t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO scl.tbl_rowsedit(
	id,row_id, sequ,aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit,stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit,stop
	FROM scl.tbl_rows WHERE scl.tbl_rows.id = in_id;
UPDATE scl.tbl_rows
	SET aname=in_aname, ename=in_ename, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit, stop=in_stop
	WHERE scl.tbl_rows.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 43, 14, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_rows order by scl.tbl_rows.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_rows where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 43, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_rows_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 236 (class 1259 OID 62485)
-- Name: tbl_section; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_section (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_section OWNER TO postgres;

--
-- TOC entry 296 (class 1255 OID 62493)
-- Name: fnc_section_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_section_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF scl.tbl_section
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from scl.tbl_sectionedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from scl.tbl_section t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO scl.tbl_sectionedit(
	id,section_id, sequ, aname, ename, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete, stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1, stop
	FROM scl.tbl_section WHERE scl.tbl_section.id = in_id;
Delete From scl.tbl_section
	WHERE scl.tbl_section.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 53, 17, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_section order by scl.tbl_section.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_section where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 53, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_section_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 297 (class 1255 OID 62494)
-- Name: fnc_section_insert(character varying, text, text, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_section_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) RETURNS SETOF scl.tbl_section
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from scl.tbl_section) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO scl.tbl_section(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,stop)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_stop);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 51, 17, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_section order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_section where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 51, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_section_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 351 (class 1255 OID 62495)
-- Name: fnc_section_update(character varying, character varying, character varying, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_section_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) RETURNS SETOF scl.tbl_section
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from scl.tbl_sectionedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from scl.tbl_section t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO scl.tbl_sectionedit(
	id,section_id, sequ,aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit,stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit,stop
	FROM scl.tbl_section WHERE scl.tbl_section.id = in_id;
UPDATE scl.tbl_section
	SET aname=in_aname, ename=in_ename, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit, stop=in_stop
	WHERE scl.tbl_section.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 52, 17, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_section order by scl.tbl_section.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_section where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 52, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_section_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 237 (class 1259 OID 62496)
-- Name: tbl_stages; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_stages (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_stages OWNER TO postgres;

--
-- TOC entry 285 (class 1255 OID 62504)
-- Name: fnc_stages_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_stages_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF scl.tbl_stages
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from scl.tbl_stagesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from scl.tbl_stages t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO scl.tbl_stagesedit(
	id,stage_id, sequ, aname, ename, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete, stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1, stop
	FROM scl.tbl_stages WHERE scl.tbl_stages.id = in_id;
Delete From scl.tbl_stages
	WHERE scl.tbl_stages.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 41, 13, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_stages order by scl.tbl_stages.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_stages where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 41, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_stages_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 336 (class 1255 OID 62505)
-- Name: fnc_stages_insert(character varying, text, text, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_stages_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) RETURNS SETOF scl.tbl_stages
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from scl.tbl_stages) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO scl.tbl_stages(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,stop)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_stop);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 39, 13, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_stages order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_stages where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 39, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_stages_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 316 (class 1255 OID 62506)
-- Name: fnc_stages_update(character varying, character varying, character varying, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_stages_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) RETURNS SETOF scl.tbl_stages
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from scl.tbl_stagesedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from scl.tbl_stages t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO scl.tbl_stagesedit(
	id,stage_id, sequ,aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit,stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit,stop
	FROM scl.tbl_stages WHERE scl.tbl_stages.id = in_id;
UPDATE scl.tbl_stages
	SET aname=in_aname, ename=in_ename, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit, stop=in_stop
	WHERE scl.tbl_stages.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 40, 13, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_stages order by scl.tbl_stages.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_stages where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 40, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_stages_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 238 (class 1259 OID 62507)
-- Name: tbl_study; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_study (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    notes text,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    company_id character varying(2),
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_study OWNER TO postgres;

--
-- TOC entry 331 (class 1255 OID 62515)
-- Name: fnc_study_delete(character varying, character varying, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_study_delete(in_id character varying, in_user_id character varying, in_company_id character varying) RETURNS SETOF scl.tbl_study
    LANGUAGE plpgsql
    AS $$

declare 
	on_servertime timestamp;
	on_current_edit smallint;
	on_edit_id integer;
	on_audit_id bigint;
-------------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_edit_id = (select(select max(id) from scl.tbl_studyedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_current_edit = (select(select edit from scl.tbl_study t where t.id = in_id));
------------------------------------------------------------------------------------------------------INSERT INTO tbl_editcompanies & Delete companies
INSERT INTO scl.tbl_studyedit(
	id,study_id, sequ, aname, ename, company_id, creationtime, editingtime, createuser_id, edituser_id, edit, delete, stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, creationtime, on_servertime, createuser_id, in_user_id, edit, 1, stop
	FROM scl.tbl_study WHERE scl.tbl_study.id = in_id;
Delete From scl.tbl_study
	WHERE scl.tbl_study.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 50, 16, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_study order by scl.tbl_study.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_study where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 50, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_study_delete(in_id character varying, in_user_id character varying, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 360 (class 1255 OID 62516)
-- Name: fnc_study_insert(character varying, text, text, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_study_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) RETURNS SETOF scl.tbl_study
    LANGUAGE plpgsql
    AS $$

declare 
	on_xseq int;
	on_servertime timestamp; 
	on_audit_id bigint;
	---------------------------------------
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_servertime = (select(current_timestamp));
	on_xseq = (select(select max(sequ) from scl.tbl_study) + 1);
	on_xseq = (select case when (on_xseq is NULL) then 1 else on_xseq end);
	in_id = on_xseq;
	WHILE (length(in_id) < 4)
		loop
			in_id = (select concat('0',in_id));
		end loop;
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
------------------------------------------------------------------------------------------------------INSERT INTO companies 
INSERT INTO scl.tbl_study(
	id, sequ,aname, ename,company_id, creationtime, createuser_id,stop)
	VALUES (in_id, on_xseq, in_aname, in_ename,in_company_id, on_servertime, in_user_id,in_stop);
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 48, 16, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_study order by sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_study where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, null, null, null, in_user_id, 48, in_id);
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_study_insert(in_id character varying, in_aname text, in_ename text, in_company_id character varying, in_stop boolean, in_user_id character varying) OWNER TO postgres;

--
-- TOC entry 352 (class 1255 OID 62517)
-- Name: fnc_study_update(character varying, character varying, character varying, character varying, boolean, character varying); Type: FUNCTION; Schema: scl; Owner: postgres
--

CREATE FUNCTION scl.fnc_study_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) RETURNS SETOF scl.tbl_study
    LANGUAGE plpgsql
    AS $$

declare 
	on_edit_id int;
	on_servertime timestamp;
	on_current_edit smallint;
	on_audit_id bigint;
---------------------------------------	
	ex_id integer;
	ex_sqlstate text;
	ex_colname text; 
	ex_constraintname text; 
	ex_datatype text; 
	ex_msgtext text; 
	ex_tablename text; 
	ex_schemaname text; 
	ex_details text; 
	ex_hint text; 
	ex_context text; 
BEGIN
	ex_id = (select(select max(id) from grl.tbl_ex) + 1); if ex_id is null then ex_id = 1; end if;
	on_edit_id = (select(select max(id) from scl.tbl_studyedit) + 1); if on_edit_id is null then on_edit_id = 1; end if;
	on_audit_id = (select(select max(id) from grl.tbl_audit) + 1); if on_audit_id is null then on_audit_id = 1; end if;
	on_servertime = (select(current_timestamp));
	in_aname = (select case when (in_aname IS NULL OR in_aname = '') THEN in_ename else in_aname end);
	in_ename = (select case when (in_ename IS NULL OR in_ename = '') THEN in_aname else in_ename end);
	on_current_edit = (select(select edit from scl.tbl_study t where t.id = in_id) + 1);
------------------------------------------------------------------------------------------------------INSERT INTO tbl_fyearsedit & Update fyears
INSERT INTO scl.tbl_studyedit(
	id,study_id, sequ,aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, edit,stop)
	SELECT on_edit_id,id, sequ, aname, ename, company_id, notes, creationtime, editingtime, createuser_id, edituser_id, on_current_edit,stop
	FROM scl.tbl_study WHERE scl.tbl_study.id = in_id;
UPDATE scl.tbl_study
	SET aname=in_aname, ename=in_ename, editingtime=on_servertime, edituser_id=in_user_id, edit=on_current_edit, stop=in_stop
	WHERE scl.tbl_study.id = in_id;
------------------------------------------------------------------------------------------------------INSERT INTO audit
INSERT INTO grl.tbl_audit(
	id, eventtime, eventtype_id, doctype_id, doc_id, user_id, company_id)
	VALUES (on_audit_id, on_servertime, 49, 16, in_id, in_user_id, in_company_id);
------------------------------------------------------------------------------------------------------Success Return
RETURN QUERY select * from scl.tbl_study order by scl.tbl_study.sequ;
------------------------------------------------------------------------------------------------------EX
EXCEPTION WHEN OTHERS THEN
	GET STACKED DIAGNOSTICS
		ex_sqlstate = RETURNED_SQLSTATE,
		ex_colname = COLUMN_NAME,
		ex_constraintname = CONSTRAINT_NAME,
		ex_datatype = PG_DATATYPE_NAME,
		ex_msgtext = MESSAGE_TEXT,
		ex_tablename = TABLE_NAME,
		ex_schemaname = SCHEMA_NAME,
		ex_details = PG_EXCEPTION_DETAIL,
		ex_hint = PG_EXCEPTION_HINT,
		ex_context = PG_EXCEPTION_CONTEXT;
	DROP TABLE IF EXISTS temp_EX;
	CREATE TEMP TABLE temp_EX as SELECT * from scl.tbl_study where id = '0';
	INSERT INTO temp_EX(notes)VALUES('PostgreSQL'||','|| ex_id || ',' || ex_sqlstate || ',' || ex_msgtext || ',' || ex_context);
------------------------------------------------------------------------------------------------------INSERT INTO ex
INSERT INTO grl.tbl_ex(
id, sqlstate, colname, constraintname, datatype, msgtext, tablename, schemaname, details, hint, context, extime, company_id, branche_id, store_id, user_id, eventtype_id, doc_id)
VALUES(ex_id, ex_sqlstate, ex_colname, ex_constraintname, ex_datatype, ex_msgtext, ex_tablename, ex_schemaname, ex_details, ex_hint, ex_context, on_servertime, in_company_id, null, null, in_user_id, 49, in_id); 
------------------------------------------------------------------------------------------------------Faild Return
return QUERY select * from temp_EX;
End

$$;


ALTER FUNCTION scl.fnc_study_update(in_id character varying, in_aname character varying, in_ename character varying, in_user_id character varying, in_stop boolean, in_company_id character varying) OWNER TO postgres;

--
-- TOC entry 239 (class 1259 OID 62518)
-- Name: tbl_ccedit; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_ccedit (
    id smallint NOT NULL,
    cc_id character varying(50) NOT NULL,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    cc1 boolean DEFAULT false NOT NULL,
    cc2 boolean DEFAULT false NOT NULL,
    company_id character varying(2) NOT NULL,
    branch_id character varying(3),
    notes text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    level smallint,
    parent boolean DEFAULT false NOT NULL,
    parent_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL
);


ALTER TABLE acc.tbl_ccedit OWNER TO postgres;

--
-- TOC entry 240 (class 1259 OID 62530)
-- Name: tbl_chartccrelation; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_chartccrelation (
    id text,
    aname text,
    ename text
);


ALTER TABLE acc.tbl_chartccrelation OWNER TO postgres;

--
-- TOC entry 241 (class 1259 OID 62536)
-- Name: tbl_chartedit; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_chartedit (
    id integer NOT NULL,
    chart_id character varying(50),
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    menue_id character varying(1) NOT NULL,
    side_id character varying(1) NOT NULL,
    ccrelation_id character varying(1) NOT NULL,
    cc1_id character varying(50),
    cc2_id character varying(50),
    property_id character varying(1),
    company_id character varying(2) NOT NULL,
    branch_id character varying(3) NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    level smallint NOT NULL,
    parent boolean DEFAULT false NOT NULL,
    parent_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4) NOT NULL,
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL
);


ALTER TABLE acc.tbl_chartedit OWNER TO postgres;

--
-- TOC entry 242 (class 1259 OID 62546)
-- Name: tbl_chartlists; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_chartlists (
    id text,
    aname text,
    ename text
);


ALTER TABLE acc.tbl_chartlists OWNER TO postgres;

--
-- TOC entry 243 (class 1259 OID 62552)
-- Name: tbl_chartprop; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_chartprop (
    id text,
    aname text,
    ename text
);


ALTER TABLE acc.tbl_chartprop OWNER TO postgres;

--
-- TOC entry 244 (class 1259 OID 62558)
-- Name: tbl_chartside; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_chartside (
    id text,
    aname text,
    ename text
);


ALTER TABLE acc.tbl_chartside OWNER TO postgres;

--
-- TOC entry 245 (class 1259 OID 62564)
-- Name: tbl_cust; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_cust (
    id character varying(50),
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    mobile1 character varying(50),
    mobile2 character varying(50),
    phone1 character varying(50),
    phone2 character varying(50),
    email character varying(50),
    company_id character varying(2),
    branch_id character varying(3),
    notes text,
    stop boolean,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint
);


ALTER TABLE acc.tbl_cust OWNER TO postgres;

--
-- TOC entry 246 (class 1259 OID 62570)
-- Name: tbl_jordedit; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_jordedit (
    id integer NOT NULL,
    jord_id integer NOT NULL,
    jor_id character varying(15) NOT NULL,
    debit numeric NOT NULL,
    credit numeric NOT NULL,
    chart_id text NOT NULL,
    doctype_id smallint,
    doc_id text,
    currency_id character varying(2) NOT NULL,
    currencyprice numeric DEFAULT 1 NOT NULL,
    jortype_id text,
    yyyy character varying(4) NOT NULL,
    mm character varying(2) NOT NULL,
    ref character varying(3) NOT NULL,
    notes text,
    company_id character varying(2),
    fyear_id character varying(2),
    branch_id character varying(3),
    cc1_id character varying(50),
    cc2_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    editservertime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL
);


ALTER TABLE acc.tbl_jordedit OWNER TO postgres;

--
-- TOC entry 247 (class 1259 OID 62579)
-- Name: tbl_jordedit_id_seq; Type: SEQUENCE; Schema: acc; Owner: postgres
--

CREATE SEQUENCE acc.tbl_jordedit_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;


ALTER TABLE acc.tbl_jordedit_id_seq OWNER TO postgres;

--
-- TOC entry 3516 (class 0 OID 0)
-- Dependencies: 247
-- Name: tbl_jordedit_id_seq; Type: SEQUENCE OWNED BY; Schema: acc; Owner: postgres
--

ALTER SEQUENCE acc.tbl_jordedit_id_seq OWNED BY acc.tbl_jordedit.id;


--
-- TOC entry 248 (class 1259 OID 62581)
-- Name: tbl_joredit; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_joredit (
    id integer NOT NULL,
    jor_id character varying(15) NOT NULL,
    sequ smallint NOT NULL,
    doctype_id text,
    doc_id text,
    currency_id character varying(2) NOT NULL,
    currencyprice numeric DEFAULT 1 NOT NULL,
    jortype_id text,
    yyyy character varying(4) NOT NULL,
    mm character varying(2) NOT NULL,
    ref character varying(3) NOT NULL,
    notes text,
    company_id character varying(2),
    fyear_id character varying(2),
    branch_id character varying(3),
    cc1_id character varying(50),
    cc2_id character varying(50),
    creationtime timestamp without time zone NOT NULL,
    createservertime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    editservertime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL
);


ALTER TABLE acc.tbl_joredit OWNER TO postgres;

--
-- TOC entry 249 (class 1259 OID 62590)
-- Name: tbl_jortype; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_jortype (
    id smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL
);


ALTER TABLE acc.tbl_jortype OWNER TO postgres;

--
-- TOC entry 250 (class 1259 OID 62593)
-- Name: tbl_ven; Type: TABLE; Schema: acc; Owner: postgres
--

CREATE TABLE acc.tbl_ven (
    id character varying(50),
    sequ smallint,
    aname character varying(50),
    ename character varying(50),
    mobile1 character varying(50),
    mobile2 character varying(50),
    phone1 character varying(50),
    phone2 character varying(50),
    email character varying(50),
    company_id character varying(2),
    branch_id character varying(3),
    notes text,
    stop boolean,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint
);


ALTER TABLE acc.tbl_ven OWNER TO postgres;

--
-- TOC entry 251 (class 1259 OID 62599)
-- Name: tbl_doctype; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_doctype (
    id smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    schema text NOT NULL,
    notes text,
    moudel_id character varying(2)
);


ALTER TABLE grl.tbl_doctype OWNER TO postgres;

--
-- TOC entry 252 (class 1259 OID 62605)
-- Name: viw_repjor; Type: VIEW; Schema: acc; Owner: postgres
--

CREATE VIEW acc.viw_repjor AS
 SELECT d.jor_id AS "Entry ID",
    d.debit AS "Debit",
    d.credit AS "Credit",
    sum((d.debit - d.credit)) OVER (PARTITION BY d.chart_id ORDER BY d.ctid) AS "Balance",
    d.chart_id AS "Account ID",
    chart.aname AS "Account Name",
    doctype.aname AS "Document Type Name",
    d.doc_id AS "Document ID",
    d.currency_id AS "Currency ID",
    currency.aname AS "Currency Name",
    d.currencyprice AS "Currency Price",
    jortype.aname AS "Entry Type",
    d.yyyy AS "Year",
    d.mm AS "Month",
    d.ref,
    d.notes AS "Notes",
    d.company_id AS "Company ID",
    com.aname AS "Company Name",
    d.fyear_id AS "Fyear ID",
    fyear.aname AS "Fyear Name",
    d.branch_id AS "Branch ID",
    d.cc1_id AS "Cost Center 1 ID",
    cc1.aname AS "Cost Center 1 Name",
    d.cc2_id AS "Cost Center 2 ID",
    cc2.aname AS "Cost Center 2 Name",
    d.creationtime AS "Date",
    d.createservertime AS "Server Time",
    d.createuser_id AS "User ID",
    users.aname AS "User Name",
    d.edit AS "Edited",
    chart.notes
   FROM (((((((((acc.tbl_jord d
     LEFT JOIN acc.tbl_chart chart ON ((d.chart_id = (chart.id)::text)))
     LEFT JOIN grl.tbl_doctype doctype ON ((d.doctype_id = doctype.id)))
     LEFT JOIN grl.tbl_currencies currency ON (((d.currency_id)::text = (currency.id)::text)))
     LEFT JOIN acc.tbl_jortype jortype ON ((d.jortype_id = (jortype.id)::text)))
     LEFT JOIN grl.tbl_companies com ON (((d.company_id)::text = (com.id)::text)))
     LEFT JOIN grl.tbl_fyears fyear ON (((d.fyear_id)::text = (fyear.id)::text)))
     LEFT JOIN acc.tbl_cc cc1 ON (((d.cc1_id)::text = (cc1.id)::text)))
     LEFT JOIN acc.tbl_cc cc2 ON (((d.cc2_id)::text = (cc2.id)::text)))
     LEFT JOIN grl.tbl_users users ON (((d.createuser_id)::text = (users.id)::text)))
  ORDER BY d.ctid;


ALTER TABLE acc.viw_repjor OWNER TO postgres;

--
-- TOC entry 253 (class 1259 OID 62610)
-- Name: viw_st; Type: VIEW; Schema: acc; Owner: postgres
--

CREATE VIEW acc.viw_st AS
 SELECT j.chart_id,
    j.debit,
    j.credit,
    j.notes,
    j.jor_id,
    j.creationtime AS date,
    j.doctype_id,
    j.cc1_id,
    j.cc2_id,
    j.branch_id,
    j.company_id,
    d.aname AS doctype_aname,
    d.ename AS doctype_ename
   FROM (acc.tbl_jord j
     LEFT JOIN grl.tbl_doctype d ON ((j.doctype_id = d.id)))
  ORDER BY j.jor_id;


ALTER TABLE acc.viw_st OWNER TO postgres;

--
-- TOC entry 254 (class 1259 OID 62615)
-- Name: viw_tb; Type: VIEW; Schema: acc; Owner: postgres
--

CREATE VIEW acc.viw_tb AS
 SELECT c.id,
    c.aname,
    c.ename,
    ( SELECT
                CASE
                    WHEN (c.parent = true) THEN ( SELECT sum((d.debit * d.currencyprice)) AS sum
                       FROM acc.tbl_jord d
                      WHERE (d.chart_id ~~ ((c.id)::text || '%'::text)))
                    ELSE (j.debit * j.currencyprice)
                END AS "case") AS debit,
    ( SELECT
                CASE
                    WHEN (c.parent = true) THEN ( SELECT sum((d.credit * d.currencyprice)) AS sum
                       FROM acc.tbl_jord d
                      WHERE (d.chart_id ~~ ((c.id)::text || '%'::text)))
                    ELSE (j.credit * j.currencyprice)
                END AS "case") AS credit,
    j.creationtime AS date,
    c.level,
    c.parent_id,
    c.parent,
    c.menue_id,
    c.side_id,
    j.cc1_id,
    j.cc2_id,
    j.branch_id,
    j.company_id
   FROM (acc.tbl_chart c
     LEFT JOIN acc.tbl_jord j ON (((c.id)::text = j.chart_id)))
  ORDER BY c.id;


ALTER TABLE acc.viw_tb OWNER TO postgres;

--
-- TOC entry 255 (class 1259 OID 62620)
-- Name: tbl_areasedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_areasedit (
    id integer NOT NULL,
    area_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    city_id character varying(4),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text
);


ALTER TABLE grl.tbl_areasedit OWNER TO postgres;

--
-- TOC entry 256 (class 1259 OID 62628)
-- Name: tbl_audit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_audit (
    id bigint NOT NULL,
    eventtime timestamp without time zone NOT NULL,
    eventtype_id smallint NOT NULL,
    doctype_id smallint NOT NULL,
    doc_id character varying(15) NOT NULL,
    user_id character varying(4) NOT NULL,
    notes text,
    company_id character varying(2) NOT NULL
);


ALTER TABLE grl.tbl_audit OWNER TO postgres;

--
-- TOC entry 257 (class 1259 OID 62634)
-- Name: tbl_branchesedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_branchesedit (
    id smallint NOT NULL,
    branches_id character varying(3),
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    mobile1 text,
    mobile2 text,
    phone1 text,
    phone2 text,
    email text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint NOT NULL,
    delete smallint DEFAULT 0
);


ALTER TABLE grl.tbl_branchesedit OWNER TO postgres;

--
-- TOC entry 258 (class 1259 OID 62642)
-- Name: tbl_citiesedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_citiesedit (
    id integer NOT NULL,
    city_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    country_id character varying(4),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text
);


ALTER TABLE grl.tbl_citiesedit OWNER TO postgres;

--
-- TOC entry 259 (class 1259 OID 62650)
-- Name: tbl_companiesedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_companiesedit (
    id integer NOT NULL,
    companies_id character varying,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint NOT NULL,
    delete smallint DEFAULT 0
);


ALTER TABLE grl.tbl_companiesedit OWNER TO postgres;

--
-- TOC entry 260 (class 1259 OID 62658)
-- Name: tbl_currenciesedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_currenciesedit (
    id integer NOT NULL,
    currencies_id character varying,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    asymbol text,
    esymbol text,
    price numeric DEFAULT 1 NOT NULL,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint NOT NULL,
    delete smallint DEFAULT 0
);


ALTER TABLE grl.tbl_currenciesedit OWNER TO postgres;

--
-- TOC entry 261 (class 1259 OID 62667)
-- Name: tbl_events; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_events (
    id smallint NOT NULL,
    aname character varying(50),
    ename character varying(50),
    notes text,
    priority smallint
);


ALTER TABLE grl.tbl_events OWNER TO postgres;

--
-- TOC entry 262 (class 1259 OID 62673)
-- Name: tbl_ex; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_ex (
    id integer NOT NULL,
    sqlstate text,
    colname text,
    constraintname text,
    datatype text,
    msgtext text,
    tablename text,
    schemaname text,
    details text,
    hint text,
    context text,
    extime timestamp without time zone,
    company_id character varying(2),
    branche_id character varying(3),
    store_id character varying(3),
    user_id character varying(4),
    eventtype_id smallint,
    doctype_id smallint,
    doc_id text
);


ALTER TABLE grl.tbl_ex OWNER TO postgres;

--
-- TOC entry 263 (class 1259 OID 62679)
-- Name: tbl_exmsg; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_exmsg (
    id integer NOT NULL,
    aname text,
    ename text
);


ALTER TABLE grl.tbl_exmsg OWNER TO postgres;

--
-- TOC entry 264 (class 1259 OID 62685)
-- Name: tbl_fyearsedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_fyearsedit (
    id integer NOT NULL,
    fyears_id character varying,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    beigndate date,
    enddate date,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint NOT NULL,
    delete smallint DEFAULT 0
);


ALTER TABLE grl.tbl_fyearsedit OWNER TO postgres;

--
-- TOC entry 265 (class 1259 OID 62693)
-- Name: tbl_gender; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_gender (
    id smallint,
    aname text,
    ename text,
    notes text
);


ALTER TABLE grl.tbl_gender OWNER TO postgres;

--
-- TOC entry 266 (class 1259 OID 62699)
-- Name: tbl_lvlnuset; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_lvlnuset (
    doctypeid smallint,
    lvlnu smallint,
    nu smallint
);


ALTER TABLE grl.tbl_lvlnuset OWNER TO postgres;

--
-- TOC entry 267 (class 1259 OID 62702)
-- Name: tbl_moduels; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_moduels (
    id character varying(2) NOT NULL,
    sequ smallint,
    aname text NOT NULL,
    ename text NOT NULL,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone
);


ALTER TABLE grl.tbl_moduels OWNER TO postgres;

--
-- TOC entry 268 (class 1259 OID 62709)
-- Name: tbl_nationalityedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_nationalityedit (
    id integer NOT NULL,
    nat_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text
);


ALTER TABLE grl.tbl_nationalityedit OWNER TO postgres;

--
-- TOC entry 269 (class 1259 OID 62717)
-- Name: tbl_permissions; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_permissions (
    id character varying(4) NOT NULL,
    sequ smallint,
    aname text NOT NULL,
    ename text NOT NULL,
    doctype_id smallint,
    activetime timestamp without time zone
);


ALTER TABLE grl.tbl_permissions OWNER TO postgres;

--
-- TOC entry 270 (class 1259 OID 62723)
-- Name: tbl_religion; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_religion (
    id smallint,
    aname character(50),
    ename character(50)
);


ALTER TABLE grl.tbl_religion OWNER TO postgres;

--
-- TOC entry 271 (class 1259 OID 62726)
-- Name: tbl_storesedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_storesedit (
    id integer NOT NULL,
    stores_id character varying,
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    responame text,
    mobile1 text,
    mobile2 text,
    phone1 text,
    phone2 text,
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2) NOT NULL,
    branch_id character varying(3) NOT NULL,
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4) NOT NULL,
    edit smallint NOT NULL,
    delete smallint DEFAULT 0
);


ALTER TABLE grl.tbl_storesedit OWNER TO postgres;

--
-- TOC entry 283 (class 1259 OID 74501)
-- Name: tbl_system; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_system (
    scl boolean DEFAULT false NOT NULL
);


ALTER TABLE grl.tbl_system OWNER TO postgres;

--
-- TOC entry 272 (class 1259 OID 62734)
-- Name: tbl_update; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_update (
    id smallint NOT NULL,
    aname text,
    ename text,
    notes text,
    ddate timestamp without time zone NOT NULL
);


ALTER TABLE grl.tbl_update OWNER TO postgres;

--
-- TOC entry 273 (class 1259 OID 62740)
-- Name: tbl_userallowed; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_userallowed (
    user_id character varying(4),
    company_id character varying(2),
    branch_id character varying(3),
    store_id character varying(3),
    fyear_id character varying(2)
);


ALTER TABLE grl.tbl_userallowed OWNER TO postgres;

--
-- TOC entry 274 (class 1259 OID 62743)
-- Name: tbl_userblocked; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_userblocked (
    user_id character varying(4) NOT NULL,
    company_id character varying(2),
    branch_id character varying(3),
    store_id character varying(3),
    fyear_id character varying(2)
);


ALTER TABLE grl.tbl_userblocked OWNER TO postgres;

--
-- TOC entry 275 (class 1259 OID 62746)
-- Name: tbl_usersedit; Type: TABLE; Schema: grl; Owner: postgres
--

CREATE TABLE grl.tbl_usersedit (
    id integer NOT NULL,
    users_id character varying(4),
    sequ smallint NOT NULL,
    aname text NOT NULL,
    ename text NOT NULL,
    password text,
    gender_id smallint,
    jobtitle text,
    mobile1 text,
    mobile2 text,
    phone1 text,
    phone2 text,
    email text,
    permission_id character varying(3),
    blockedcompanies_ids text,
    blockedbranches_ids text,
    blockedstores_ids text,
    blockedfyears_ids text,
    defaultcompany_id character varying(2),
    defaultbranch_id character varying(3),
    defaultstore_id character varying(3),
    defaultfyear_id character varying(2),
    stop boolean DEFAULT false NOT NULL,
    activetime timestamp without time zone,
    notes text,
    company_id character varying(2),
    branch_id character varying(3),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone NOT NULL,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4) NOT NULL,
    edit smallint NOT NULL,
    delete smallint DEFAULT 0
);


ALTER TABLE grl.tbl_usersedit OWNER TO postgres;

--
-- TOC entry 276 (class 1259 OID 62754)
-- Name: viw_audit; Type: VIEW; Schema: grl; Owner: postgres
--

CREATE VIEW grl.viw_audit AS
 SELECT a.id,
    a.eventtime,
    a.eventtype_id,
    e.aname,
    a.doctype_id,
    a.doc_id,
    a.user_id,
    a.notes
   FROM grl.tbl_audit a,
    grl.tbl_events e
  WHERE (a.eventtype_id = e.id);


ALTER TABLE grl.viw_audit OWNER TO postgres;

--
-- TOC entry 277 (class 1259 OID 62758)
-- Name: tbl_classedit; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_classedit (
    id integer NOT NULL,
    class_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_classedit OWNER TO postgres;

--
-- TOC entry 278 (class 1259 OID 62767)
-- Name: tbl_parentsedit; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_parentsedit (
    id integer NOT NULL,
    parent_id character varying(50),
    sequ smallint,
    f_parent_id character varying(20),
    f_enddate_id timestamp without time zone,
    f_aname character varying(50),
    f_ename character varying(50),
    ff_aname character varying(20),
    ff_ename character varying(20),
    f_mobile1 character varying(20),
    fh_phone character varying(20),
    fw_phone character varying(20),
    f_email character varying(50),
    fcountry_id character varying(4),
    freligion_id smallint,
    facc_code character varying(50),
    fh_adress character varying(50),
    fw_adress character varying(50),
    m_parent_id character varying(20),
    m_enddate_id timestamp without time zone,
    m_aname character varying(50),
    m_ename character varying(50),
    mf_aname character varying(20),
    mf_ename character varying(20),
    m_mobile1 character varying(20),
    mh_phone character varying(20),
    mw_phone character varying(20),
    m_email character varying(50),
    mcountry_id character varying(4),
    mreligion_id smallint,
    macc_code character varying(50),
    mh_adress character varying(50),
    mw_adress character varying(50),
    company_id character varying(2),
    branch_id character varying(3),
    notes text,
    stop boolean DEFAULT false NOT NULL,
    creationtime timestamp without time zone,
    editingtime timestamp without time zone,
    createuser_id character varying(4),
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL
);


ALTER TABLE scl.tbl_parentsedit OWNER TO postgres;

--
-- TOC entry 279 (class 1259 OID 62776)
-- Name: tbl_rowsedit; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_rowsedit (
    id integer NOT NULL,
    row_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_rowsedit OWNER TO postgres;

--
-- TOC entry 280 (class 1259 OID 62785)
-- Name: tbl_sectionedit; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_sectionedit (
    id integer NOT NULL,
    section_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_sectionedit OWNER TO postgres;

--
-- TOC entry 281 (class 1259 OID 62794)
-- Name: tbl_stagesedit; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_stagesedit (
    id integer NOT NULL,
    stage_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_stagesedit OWNER TO postgres;

--
-- TOC entry 282 (class 1259 OID 62803)
-- Name: tbl_studyedit; Type: TABLE; Schema: scl; Owner: postgres
--

CREATE TABLE scl.tbl_studyedit (
    id integer NOT NULL,
    study_id character varying NOT NULL,
    sequ smallint NOT NULL,
    aname character varying(50) NOT NULL,
    ename character varying(50) NOT NULL,
    company_id character varying(2),
    creationtime timestamp without time zone NOT NULL,
    editingtime timestamp without time zone,
    createuser_id character varying(4) NOT NULL,
    edituser_id character varying(4),
    edit smallint DEFAULT 0 NOT NULL,
    delete smallint DEFAULT 0 NOT NULL,
    notes text,
    stop boolean DEFAULT false NOT NULL
);


ALTER TABLE scl.tbl_studyedit OWNER TO postgres;

--
-- TOC entry 3190 (class 2604 OID 62812)
-- Name: tbl_jordedit id; Type: DEFAULT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jordedit ALTER COLUMN id SET DEFAULT nextval('acc.tbl_jordedit_id_seq'::regclass);


--
-- TOC entry 3284 (class 2606 OID 62814)
-- Name: tbl_ccedit ccedit_pkey; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_ccedit
    ADD CONSTRAINT ccedit_pkey PRIMARY KEY (id);


--
-- TOC entry 3252 (class 2606 OID 62816)
-- Name: tbl_jord jord_pkey; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jord
    ADD CONSTRAINT jord_pkey PRIMARY KEY (id);


--
-- TOC entry 3290 (class 2606 OID 62818)
-- Name: tbl_joredit joredit_pkey; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_joredit
    ADD CONSTRAINT joredit_pkey PRIMARY KEY (id);


--
-- TOC entry 3292 (class 2606 OID 62820)
-- Name: tbl_jortype pke_jortype; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jortype
    ADD CONSTRAINT pke_jortype PRIMARY KEY (id);


--
-- TOC entry 3234 (class 2606 OID 62822)
-- Name: tbl_cc pky_cc; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cc
    ADD CONSTRAINT pky_cc PRIMARY KEY (id, company_id);


--
-- TOC entry 3236 (class 2606 OID 62824)
-- Name: tbl_chart pky_chart; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_chart
    ADD CONSTRAINT pky_chart PRIMARY KEY (id, company_id);


--
-- TOC entry 3286 (class 2606 OID 62826)
-- Name: tbl_chartedit pky_chartedit; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_chartedit
    ADD CONSTRAINT pky_chartedit PRIMARY KEY (id);


--
-- TOC entry 3238 (class 2606 OID 62828)
-- Name: tbl_cin pky_cin; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT pky_cin PRIMARY KEY (id, company_id);


--
-- TOC entry 3248 (class 2606 OID 62830)
-- Name: tbl_cout pky_cout; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT pky_cout PRIMARY KEY (id, company_id);


--
-- TOC entry 3288 (class 2606 OID 62832)
-- Name: tbl_jordedit pky_jordedit; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jordedit
    ADD CONSTRAINT pky_jordedit PRIMARY KEY (id);


--
-- TOC entry 3250 (class 2606 OID 62834)
-- Name: tbl_jor tbl_jor_pkey; Type: CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jor
    ADD CONSTRAINT tbl_jor_pkey PRIMARY KEY (id, company_id);


--
-- TOC entry 3254 (class 2606 OID 62836)
-- Name: tbl_areas areas_pkey; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_areas
    ADD CONSTRAINT areas_pkey PRIMARY KEY (id);


--
-- TOC entry 3256 (class 2606 OID 62838)
-- Name: tbl_cities cities_pkey; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_cities
    ADD CONSTRAINT cities_pkey PRIMARY KEY (id);


--
-- TOC entry 3262 (class 2606 OID 62840)
-- Name: tbl_nationality nationality_pkey; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_nationality
    ADD CONSTRAINT nationality_pkey PRIMARY KEY (id);


--
-- TOC entry 3296 (class 2606 OID 62842)
-- Name: tbl_areasedit pky_areas; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_areasedit
    ADD CONSTRAINT pky_areas PRIMARY KEY (id);


--
-- TOC entry 3298 (class 2606 OID 62844)
-- Name: tbl_audit pky_audit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_audit
    ADD CONSTRAINT pky_audit PRIMARY KEY (id);


--
-- TOC entry 3240 (class 2606 OID 62846)
-- Name: tbl_bank pky_bank; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_bank
    ADD CONSTRAINT pky_bank PRIMARY KEY (id);


--
-- TOC entry 3242 (class 2606 OID 62848)
-- Name: tbl_branches pky_branches; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_branches
    ADD CONSTRAINT pky_branches PRIMARY KEY (id, company_id);


--
-- TOC entry 3300 (class 2606 OID 62850)
-- Name: tbl_branchesedit pky_branchesedit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_branchesedit
    ADD CONSTRAINT pky_branchesedit PRIMARY KEY (id);


--
-- TOC entry 3302 (class 2606 OID 62852)
-- Name: tbl_citiesedit pky_cities; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_citiesedit
    ADD CONSTRAINT pky_cities PRIMARY KEY (id);


--
-- TOC entry 3258 (class 2606 OID 62854)
-- Name: tbl_companies pky_companies; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_companies
    ADD CONSTRAINT pky_companies PRIMARY KEY (id);


--
-- TOC entry 3304 (class 2606 OID 62856)
-- Name: tbl_companiesedit pky_companiesedit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_companiesedit
    ADD CONSTRAINT pky_companiesedit PRIMARY KEY (id);


--
-- TOC entry 3244 (class 2606 OID 62858)
-- Name: tbl_currencies pky_currencies; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_currencies
    ADD CONSTRAINT pky_currencies PRIMARY KEY (id);


--
-- TOC entry 3306 (class 2606 OID 62860)
-- Name: tbl_currenciesedit pky_currenciesedit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_currenciesedit
    ADD CONSTRAINT pky_currenciesedit PRIMARY KEY (id);


--
-- TOC entry 3294 (class 2606 OID 62862)
-- Name: tbl_doctype pky_doctype; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_doctype
    ADD CONSTRAINT pky_doctype PRIMARY KEY (id);


--
-- TOC entry 3308 (class 2606 OID 62864)
-- Name: tbl_events pky_events; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_events
    ADD CONSTRAINT pky_events PRIMARY KEY (id);


--
-- TOC entry 3310 (class 2606 OID 62866)
-- Name: tbl_ex pky_ex; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_ex
    ADD CONSTRAINT pky_ex PRIMARY KEY (id);


--
-- TOC entry 3312 (class 2606 OID 62868)
-- Name: tbl_exmsg pky_exmsg; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_exmsg
    ADD CONSTRAINT pky_exmsg PRIMARY KEY (id);


--
-- TOC entry 3260 (class 2606 OID 62870)
-- Name: tbl_fyears pky_fyears; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_fyears
    ADD CONSTRAINT pky_fyears PRIMARY KEY (id);


--
-- TOC entry 3314 (class 2606 OID 62872)
-- Name: tbl_fyearsedit pky_fyearsedit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_fyearsedit
    ADD CONSTRAINT pky_fyearsedit PRIMARY KEY (id);


--
-- TOC entry 3316 (class 2606 OID 62874)
-- Name: tbl_moduels pky_modules; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_moduels
    ADD CONSTRAINT pky_modules PRIMARY KEY (id);


--
-- TOC entry 3318 (class 2606 OID 62876)
-- Name: tbl_nationalityedit pky_nationality; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_nationalityedit
    ADD CONSTRAINT pky_nationality PRIMARY KEY (id);


--
-- TOC entry 3246 (class 2606 OID 62878)
-- Name: tbl_paytype pky_paytype; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_paytype
    ADD CONSTRAINT pky_paytype PRIMARY KEY (id);


--
-- TOC entry 3320 (class 2606 OID 62880)
-- Name: tbl_permissions pky_permissions; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_permissions
    ADD CONSTRAINT pky_permissions PRIMARY KEY (id);


--
-- TOC entry 3264 (class 2606 OID 62882)
-- Name: tbl_rep pky_rep; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_rep
    ADD CONSTRAINT pky_rep PRIMARY KEY (id, company_id);


--
-- TOC entry 3266 (class 2606 OID 62884)
-- Name: tbl_repd pky_repd; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_repd
    ADD CONSTRAINT pky_repd PRIMARY KEY (id, company_id);


--
-- TOC entry 3268 (class 2606 OID 62886)
-- Name: tbl_stores pky_stores; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_stores
    ADD CONSTRAINT pky_stores PRIMARY KEY (id, branch_id, company_id);


--
-- TOC entry 3322 (class 2606 OID 62888)
-- Name: tbl_storesedit pky_storesedit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_storesedit
    ADD CONSTRAINT pky_storesedit PRIMARY KEY (id);


--
-- TOC entry 3324 (class 2606 OID 62890)
-- Name: tbl_update pky_update; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_update
    ADD CONSTRAINT pky_update PRIMARY KEY (id);


--
-- TOC entry 3270 (class 2606 OID 62892)
-- Name: tbl_users pky_users; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_users
    ADD CONSTRAINT pky_users PRIMARY KEY (id);


--
-- TOC entry 3326 (class 2606 OID 62894)
-- Name: tbl_usersedit pky_usersedit; Type: CONSTRAINT; Schema: grl; Owner: postgres
--

ALTER TABLE ONLY grl.tbl_usersedit
    ADD CONSTRAINT pky_usersedit PRIMARY KEY (id);


--
-- TOC entry 3272 (class 2606 OID 62896)
-- Name: tbl_class class_pkey; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_class
    ADD CONSTRAINT class_pkey PRIMARY KEY (id);


--
-- TOC entry 3274 (class 2606 OID 62898)
-- Name: tbl_parents parent_pkey; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_parents
    ADD CONSTRAINT parent_pkey PRIMARY KEY (id);


--
-- TOC entry 3328 (class 2606 OID 62900)
-- Name: tbl_classedit pky_class; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_classedit
    ADD CONSTRAINT pky_class PRIMARY KEY (id);


--
-- TOC entry 3330 (class 2606 OID 62902)
-- Name: tbl_parentsedit pky_parent; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_parentsedit
    ADD CONSTRAINT pky_parent PRIMARY KEY (id);


--
-- TOC entry 3332 (class 2606 OID 62904)
-- Name: tbl_rowsedit pky_rows; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_rowsedit
    ADD CONSTRAINT pky_rows PRIMARY KEY (id);


--
-- TOC entry 3334 (class 2606 OID 62906)
-- Name: tbl_sectionedit pky_section; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_sectionedit
    ADD CONSTRAINT pky_section PRIMARY KEY (id);


--
-- TOC entry 3336 (class 2606 OID 62908)
-- Name: tbl_stagesedit pky_stages; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_stagesedit
    ADD CONSTRAINT pky_stages PRIMARY KEY (id);


--
-- TOC entry 3338 (class 2606 OID 62910)
-- Name: tbl_studyedit pky_study; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_studyedit
    ADD CONSTRAINT pky_study PRIMARY KEY (id);


--
-- TOC entry 3276 (class 2606 OID 62912)
-- Name: tbl_rows rows_pkey; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_rows
    ADD CONSTRAINT rows_pkey PRIMARY KEY (id);


--
-- TOC entry 3278 (class 2606 OID 62914)
-- Name: tbl_section section_pkey; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_section
    ADD CONSTRAINT section_pkey PRIMARY KEY (id);


--
-- TOC entry 3280 (class 2606 OID 62916)
-- Name: tbl_stages stages_pkey; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_stages
    ADD CONSTRAINT stages_pkey PRIMARY KEY (id);


--
-- TOC entry 3282 (class 2606 OID 62918)
-- Name: tbl_study study_pkey; Type: CONSTRAINT; Schema: scl; Owner: postgres
--

ALTER TABLE ONLY scl.tbl_study
    ADD CONSTRAINT study_pkey PRIMARY KEY (id);


--
-- TOC entry 3340 (class 2606 OID 62919)
-- Name: tbl_cin fky_cin_branchid_branches_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT fky_cin_branchid_branches_id FOREIGN KEY (branch_id, company_id) REFERENCES grl.tbl_branches(id, company_id);


--
-- TOC entry 3341 (class 2606 OID 62924)
-- Name: tbl_cin fky_cin_cc1id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT fky_cin_cc1id_cc_id FOREIGN KEY (company_id, cc1_id) REFERENCES acc.tbl_cc(company_id, id);


--
-- TOC entry 3342 (class 2606 OID 62929)
-- Name: tbl_cin fky_cin_cc2id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT fky_cin_cc2id_cc_id FOREIGN KEY (cc2_id, company_id) REFERENCES acc.tbl_cc(id, company_id);


--
-- TOC entry 3343 (class 2606 OID 62934)
-- Name: tbl_cin fky_cin_companyid_companies_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT fky_cin_companyid_companies_id FOREIGN KEY (company_id) REFERENCES grl.tbl_companies(id);


--
-- TOC entry 3344 (class 2606 OID 62939)
-- Name: tbl_cin fky_cin_fyearid_fyears_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT fky_cin_fyearid_fyears_id FOREIGN KEY (fyear_id) REFERENCES grl.tbl_fyears(id);


--
-- TOC entry 3345 (class 2606 OID 62944)
-- Name: tbl_cin fky_cin_jorid_jor_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cin
    ADD CONSTRAINT fky_cin_jorid_jor_id FOREIGN KEY (jor_id, company_id) REFERENCES acc.tbl_jor(id, company_id);


--
-- TOC entry 3346 (class 2606 OID 62949)
-- Name: tbl_cind fky_cind_bank_id_paytype_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_bank_id_paytype_id FOREIGN KEY (bank_id) REFERENCES grl.tbl_bank(id);


--
-- TOC entry 3347 (class 2606 OID 62954)
-- Name: tbl_cind fky_cind_branchid_branches_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_branchid_branches_id FOREIGN KEY (branch_id, company_id) REFERENCES grl.tbl_branches(id, company_id);


--
-- TOC entry 3348 (class 2606 OID 62959)
-- Name: tbl_cind fky_cind_cc1id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_cc1id_cc_id FOREIGN KEY (company_id, cc1_id) REFERENCES acc.tbl_cc(company_id, id);


--
-- TOC entry 3349 (class 2606 OID 62964)
-- Name: tbl_cind fky_cind_cc2id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_cc2id_cc_id FOREIGN KEY (cc2_id, company_id) REFERENCES acc.tbl_cc(id, company_id);


--
-- TOC entry 3350 (class 2606 OID 62969)
-- Name: tbl_cind fky_cind_chartcinid_chart_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_chartcinid_chart_id FOREIGN KEY (chart_cin_id, company_id) REFERENCES acc.tbl_chart(id, company_id);


--
-- TOC entry 3351 (class 2606 OID 62974)
-- Name: tbl_cind fky_cind_chartcoutid_chart_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_chartcoutid_chart_id FOREIGN KEY (company_id, chart_cout_id) REFERENCES acc.tbl_chart(company_id, id);


--
-- TOC entry 3352 (class 2606 OID 62979)
-- Name: tbl_cind fky_cind_cinid_cin_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_cinid_cin_id FOREIGN KEY (cin_id, company_id) REFERENCES acc.tbl_cin(id, company_id);


--
-- TOC entry 3353 (class 2606 OID 62984)
-- Name: tbl_cind fky_cind_companyid_companies_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_companyid_companies_id FOREIGN KEY (company_id) REFERENCES grl.tbl_companies(id);


--
-- TOC entry 3354 (class 2606 OID 62989)
-- Name: tbl_cind fky_cind_currencyid_currencies_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_currencyid_currencies_id FOREIGN KEY (currency_id) REFERENCES grl.tbl_currencies(id);


--
-- TOC entry 3355 (class 2606 OID 62994)
-- Name: tbl_cind fky_cind_fyearid_fyears_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_fyearid_fyears_id FOREIGN KEY (fyear_id) REFERENCES grl.tbl_fyears(id);


--
-- TOC entry 3356 (class 2606 OID 62999)
-- Name: tbl_cind fky_cind_jorid_jor_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_jorid_jor_id FOREIGN KEY (company_id, jor_id) REFERENCES acc.tbl_jor(company_id, id);


--
-- TOC entry 3357 (class 2606 OID 63004)
-- Name: tbl_cind fky_cind_paytype_id_paytype_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cind
    ADD CONSTRAINT fky_cind_paytype_id_paytype_id FOREIGN KEY (paytype_id) REFERENCES grl.tbl_paytype(id);


--
-- TOC entry 3358 (class 2606 OID 63009)
-- Name: tbl_cout fky_cout_branchid_branches_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT fky_cout_branchid_branches_id FOREIGN KEY (branch_id, company_id) REFERENCES grl.tbl_branches(id, company_id);


--
-- TOC entry 3359 (class 2606 OID 63014)
-- Name: tbl_cout fky_cout_cc1id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT fky_cout_cc1id_cc_id FOREIGN KEY (company_id, cc1_id) REFERENCES acc.tbl_cc(company_id, id);


--
-- TOC entry 3360 (class 2606 OID 63019)
-- Name: tbl_cout fky_cout_cc2id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT fky_cout_cc2id_cc_id FOREIGN KEY (cc2_id, company_id) REFERENCES acc.tbl_cc(id, company_id);


--
-- TOC entry 3361 (class 2606 OID 63024)
-- Name: tbl_cout fky_cout_companyid_companies_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT fky_cout_companyid_companies_id FOREIGN KEY (company_id) REFERENCES grl.tbl_companies(id);


--
-- TOC entry 3362 (class 2606 OID 63029)
-- Name: tbl_cout fky_cout_fyearid_fyears_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT fky_cout_fyearid_fyears_id FOREIGN KEY (fyear_id) REFERENCES grl.tbl_fyears(id);


--
-- TOC entry 3363 (class 2606 OID 63034)
-- Name: tbl_cout fky_cout_jorid_jor_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_cout
    ADD CONSTRAINT fky_cout_jorid_jor_id FOREIGN KEY (company_id, jor_id) REFERENCES acc.tbl_jor(company_id, id);


--
-- TOC entry 3364 (class 2606 OID 63039)
-- Name: tbl_coutd fky_coutd_bank_id_paytype_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_bank_id_paytype_id FOREIGN KEY (bank_id) REFERENCES grl.tbl_bank(id);


--
-- TOC entry 3365 (class 2606 OID 63044)
-- Name: tbl_coutd fky_coutd_branchid_branches_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_branchid_branches_id FOREIGN KEY (branch_id, company_id) REFERENCES grl.tbl_branches(id, company_id);


--
-- TOC entry 3366 (class 2606 OID 63049)
-- Name: tbl_coutd fky_coutd_cc1id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_cc1id_cc_id FOREIGN KEY (company_id, cc1_id) REFERENCES acc.tbl_cc(company_id, id);


--
-- TOC entry 3367 (class 2606 OID 63054)
-- Name: tbl_coutd fky_coutd_cc2id_cc_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_cc2id_cc_id FOREIGN KEY (cc2_id, company_id) REFERENCES acc.tbl_cc(id, company_id);


--
-- TOC entry 3368 (class 2606 OID 63059)
-- Name: tbl_coutd fky_coutd_chartcoutid_chart_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_chartcoutid_chart_id FOREIGN KEY (chart_cout_id, company_id) REFERENCES acc.tbl_chart(id, company_id);


--
-- TOC entry 3369 (class 2606 OID 63064)
-- Name: tbl_coutd fky_coutd_chartinid_chart_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_chartinid_chart_id FOREIGN KEY (chart_cin_id, company_id) REFERENCES acc.tbl_chart(id, company_id);


--
-- TOC entry 3370 (class 2606 OID 63069)
-- Name: tbl_coutd fky_coutd_companyid_companies_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_companyid_companies_id FOREIGN KEY (company_id) REFERENCES grl.tbl_companies(id);


--
-- TOC entry 3371 (class 2606 OID 63074)
-- Name: tbl_coutd fky_coutd_coutid_cout_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_coutid_cout_id FOREIGN KEY (cout_id, company_id) REFERENCES acc.tbl_cout(id, company_id);


--
-- TOC entry 3372 (class 2606 OID 63079)
-- Name: tbl_coutd fky_coutd_currencyid_currencies_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_currencyid_currencies_id FOREIGN KEY (currency_id) REFERENCES grl.tbl_currencies(id);


--
-- TOC entry 3373 (class 2606 OID 63084)
-- Name: tbl_coutd fky_coutd_fyearid_fyears_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_fyearid_fyears_id FOREIGN KEY (fyear_id) REFERENCES grl.tbl_fyears(id);


--
-- TOC entry 3374 (class 2606 OID 63089)
-- Name: tbl_coutd fky_coutd_jorid_jor_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_jorid_jor_id FOREIGN KEY (jor_id, company_id) REFERENCES acc.tbl_jor(id, company_id);


--
-- TOC entry 3375 (class 2606 OID 63094)
-- Name: tbl_coutd fky_coutd_paytype_id_paytype_id; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_coutd
    ADD CONSTRAINT fky_coutd_paytype_id_paytype_id FOREIGN KEY (paytype_id) REFERENCES grl.tbl_paytype(id);


--
-- TOC entry 3339 (class 2606 OID 63099)
-- Name: tbl_chart tbl_chart_parent_id_fkey; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_chart
    ADD CONSTRAINT tbl_chart_parent_id_fkey FOREIGN KEY (parent_id, company_id) REFERENCES acc.tbl_chart(id, company_id);


--
-- TOC entry 3376 (class 2606 OID 63104)
-- Name: tbl_jord tbl_jord_chart_id_fkey; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jord
    ADD CONSTRAINT tbl_jord_chart_id_fkey FOREIGN KEY (chart_id, company_id) REFERENCES acc.tbl_chart(id, company_id);


--
-- TOC entry 3377 (class 2606 OID 63109)
-- Name: tbl_jord tbl_jord_currency_id_fkey; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jord
    ADD CONSTRAINT tbl_jord_currency_id_fkey FOREIGN KEY (currency_id) REFERENCES grl.tbl_currencies(id);


--
-- TOC entry 3378 (class 2606 OID 63114)
-- Name: tbl_jord tbl_jord_doctype_id_fkey; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jord
    ADD CONSTRAINT tbl_jord_doctype_id_fkey FOREIGN KEY (doctype_id) REFERENCES grl.tbl_doctype(id);


--
-- TOC entry 3379 (class 2606 OID 63119)
-- Name: tbl_jord tbl_jord_jor_id_fkey; Type: FK CONSTRAINT; Schema: acc; Owner: postgres
--

ALTER TABLE ONLY acc.tbl_jord
    ADD CONSTRAINT tbl_jord_jor_id_fkey FOREIGN KEY (jor_id, company_id) REFERENCES acc.tbl_jor(id, company_id);


-- Completed on 2019-02-09 00:55:52

--
-- PostgreSQL database dump complete
--
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------------------------------------------------------------------------------------------------------------------------------------------------------









											   